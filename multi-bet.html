<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚽ 多重彩记录簿</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
/* 基础样式 */
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fafc;color:#334155;line-height:1.5}
.wrap{width:100%;margin:0;padding:12px}
.row{display:flex;gap:8px;align-items:stretch}
.col{display:flex;flex-direction:column;gap:8px}
.card{background:white;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.small{font-size:13px}
.muted{color:#64748b}

/* 导航栏 */
.navbar{position:sticky;top:0;z-index:10;background:#0f172a;color:#e5e7eb;border-bottom:1px solid rgba(255,255,255,.08);padding:8px 14px;margin-bottom:12px}
.navbar h1{font-size:24px;font-weight:700;color:#f1f5f9;margin:0}
.iconbar{display:flex;gap:10px;align-items:center}
.icon-btn{background:transparent;border:none;padding:4px;color:#e5e7eb;font-size:18px;cursor:pointer;transition:all 0.2s}
.icon-btn:hover{filter:brightness(1.2)}
.icon-btn.active{background:rgba(96,165,250,.18);border-color:#60a5fa;color:#fff}

/* 按钮样式 */
.btn{background:#3b82f6;color:white;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:14px;transition:all 0.2s}
.btn:hover{background:#2563eb}
.btn.sec{background:#f1f5f9;color:#475569;border:1px solid #e2e8f0}
.btn.sec:hover{background:#e2e8f0}
.btn.warn{background:#ef4444;color:white}
.btn.warn:hover{background:#dc2626}
.btn:disabled{opacity:0.5;cursor:not-allowed}

/* 表单元素 */
input,select,textarea{border:1px solid #d1d5db;border-radius:6px;padding:8px 12px;font-size:14px;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:12px;font-weight:500;color:#374151}

/* 多重彩专用布局 */
.multi-bet-layout{display:grid;grid-template-columns:60% 1fr;gap:16px;min-height:calc(100vh - 120px)}
.left-panel{display:flex;flex-direction:column;gap:12px}
.right-panel{display:flex;flex-direction:column;gap:12px}

/* 赛事列表样式 */
.match-list{max-height:600px;overflow-y:auto}
.match-item{border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
.match-item:hover{border-color:#3b82f6;background:#f8fafc}
.match-item.selected{border-color:#3b82f6;background:#eff6ff}
.match-item .match-header{font-weight:600;color:#1e293b;margin-bottom:4px}
.match-item .match-details{font-size:12px;color:#64748b}

/* 多重彩组样式 */
.multi-bet-group{border:2px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px}
.multi-bet-group.win{border-color:#10b981;background:rgba(16,185,129,0.05)}
.multi-bet-group.loss{border-color:#ef4444;background:rgba(239,68,68,0.05)}
.multi-bet-group.pending{border-color:#f59e0b;background:rgba(245,158,11,0.05)}

.group-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.group-title{font-weight:600;color:#1e293b}
.group-stats{font-size:12px;color:#64748b}
.group-odds{font-weight:700;color:#3b82f6}

.match-in-group{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:4px;margin-bottom:4px;background:#f8fafc}
.match-in-group.win{background:rgba(16,185,129,0.1)}
.match-in-group.loss{background:rgba(239,68,68,0.1)}

/* 统计表格 */
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
th,td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);text-align:left}
thead th{position:sticky;top:0;background:#f1f5f9;z-index:1;cursor:pointer}
tbody tr:hover{background:#f8fafc}
.right{text-align:right}

/* 结果标签 */
.result-tag{padding:2px 8px;border-radius:12px;font-size:11px;font-weight:500}
.result-win{background:#dcfce7;color:#166534}
.result-loss{background:#fee2e2;color:#991b1b}
.result-pending{background:#fef3c7;color:#000000}

/* KPI样式 */
.kpi{display:flex;flex-direction:column;align-items:center;gap:2px}
.k-label{font-size:11px;color:#ffffff;text-transform:uppercase;letter-spacing:0.5px}
.k-val{font-size:16px;font-weight:700;color:#ffffff}
.pos{color:#16a34a}
.neg{color:#b91c1c}

/* 筛选按钮样式 */
.filter-btn{
  padding:6px 12px;
  font-size:12px;
  border:1px solid #d1d5db;
  border-radius:4px;
  background:#fff;
  color:#374151;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
}
.filter-btn:hover{
  background:#f3f4f6;
  border-color:#9ca3af;
}
.filter-btn.active{
  background:#3b82f6;
  color:#fff;
  border-color:#3b82f6;
}

/* 小按钮样式 */
.btn-small{
  padding:4px 8px;
  font-size:12px;
  border:1px solid #d1d5db;
  border-radius:4px;
  background:#fff;
  color:#374151;
  cursor:pointer;
  transition:all 0.2s;
}
.btn-small:hover{
  background:#f9fafb;
  border-color:#9ca3af;
}
.btn-small.sec{
  background:#f3f4f6;
  color:#6b7280;
}
.btn-small.sec:hover{
  background:#e5e7eb;
}

/* 分类导航样式 */
#categoryNav {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 15px;
}

.category-nav-link {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 20px;
  text-decoration: none;
  color: #495057;
  font-size: 13px;
  transition: all 0.2s ease;
}

.category-nav-link:hover {
  background: #e9ecef;
  text-decoration: none;
  color: #495057;
}

.category-nav-link.active {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

.category-nav-link .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}



/* 录入表单折叠样式 */
.form-collapsed .tab-nav,
.form-collapsed .tab-content {
  display: none !important;
}

.form-collapsed {
  transition: all 0.3s ease;
}



.category-nav-link.active .dot {
  background: white !important;
}

/* 多重彩表格样式 */
.multi-bet-table{width:100%;border-collapse:collapse;font-size:12px;background:white}
.multi-bet-table th,.multi-bet-table td{padding:6px 8px;border:1px solid #e2e8f0;text-align:left;vertical-align:middle}
.multi-bet-table th{background:#f8fafc;font-weight:600;color:#374151;position:sticky;top:0;z-index:10;font-size:11px;text-align:center}
.multi-bet-table tbody tr:hover{background:#f1f5f9}
.multi-bet-table .group-row{background:#f1f5f9;font-weight:600}
.multi-bet-table .match-row{background:white}
.multi-bet-table .result-cell{text-align:center}
.multi-bet-table .odds-cell{text-align:right;font-weight:600}
.multi-bet-table .stake-cell{text-align:right}
.multi-bet-table .result-win{background:rgba(34,197,94,0.05)}
.multi-bet-table .result-loss{background:rgba(239,68,68,0.05)}
.multi-bet-table .result-pending{background:rgba(148,163,184,0.05)}

/* 结果设定按钮 */
.result-btn{padding:2px 6px;font-size:11px;border:1px solid #d1d5db;border-radius:3px;background:white;cursor:pointer;margin:0 1px;transition:all 0.2s;min-width:28px;font-family:inherit}
.result-btn:hover{opacity:0.8;transform:translateY(-1px)}
.result-btn.win{background:#dcfce7;color:#166534;border-color:#16a34a}
.result-btn.loss{background:#fee2e2;color:#991b1b;border-color:#dc2626}
.result-btn.pending{background:#fef3c7;color:#92400e;border-color:#f59e0b}
.tab-btn{transition:all 0.2s ease}
.tab-btn:hover{color:#3b82f6 !important;background:#f1f5f9}
.tab-btn.active:hover{background:transparent}
.result-buttons{white-space:nowrap}
.category-tag{white-space:nowrap}

/* 响应式设计 */
@media(max-width:1200px){
  .multi-bet-layout{grid-template-columns:55% 1fr}
}
@media(max-width:1000px){
  .multi-bet-layout{grid-template-columns:1fr;grid-template-rows:auto 1fr}
  .left-panel{max-height:400px}
}
</style>
</head>
<body>

<!-- 导航栏 -->
<div class="navbar">
  <div class="wrap">
    <div class="row" style="align-items:center;gap:12px">
      <h1>⚽ 多重彩记录簿</h1>
      <div class="iconbar">
        <button class="icon-btn" title="单场彩" onclick="window.location.href='index.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        </button>
        <button class="icon-btn active" title="多重彩">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M9 9h6v6H9z"/><path d="M9 3v6"/><path d="M21 9h-6"/><path d="M15 21v-6"/><path d="M3 15h6"/></svg>
        </button>
        <button class="icon-btn" title="预测来源记录验证" onclick="window.location.href='prediction-tracker.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4"/><path d="M20 16V7a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v1"/><path d="M15 2v5"/><path d="M9 2v5"/><path d="M3 9h18"/><circle cx="16" cy="16" r="2"/><path d="m21 21-1.5-1.5"/></svg>
        </button>
        <div style="width:1px;height:20px;background:#e2e8f0;margin:0 4px"></div>
        <button id="exportMultiBet" class="icon-btn" title="导出多重彩数据">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="m8 11 4 4 4-4"/><path d="M21 21H3"/></svg>
        </button>
        <button id="clearAllMultiBet" class="icon-btn" title="清空所有多重彩">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
      

      
      <!-- KPI指标 -->
      <div style="margin-left:auto;display:flex;gap:16px;align-items:center">
        <div class="kpi"><div class="k-label">多重彩总数</div><div class="k-val" id="k_total_groups">0</div></div>
        <div class="kpi"><div class="k-label">已结算</div><div class="k-val" id="k_settled_groups">0</div></div>
        <div class="kpi"><div class="k-label">胜率</div><div class="k-val" id="k_win_rate">0%</div></div>
        <div class="kpi"><div class="k-label">总投入</div><div class="k-val" id="k_total_stake">0</div></div>
        <div class="kpi"><div class="k-label">总返还</div><div class="k-val" id="k_total_return">0</div></div>
        <div class="kpi"><div class="k-label">净收益</div><div class="k-val" id="k_net_profit">0</div></div>
        <div class="kpi"><div class="k-label">ROI</div><div class="k-val" id="k_roi">0%</div></div>
      </div>
    </div>
  </div>
</div>

<!-- 主要内容区域 -->
<div class="wrap">
  <div class="multi-bet-layout">
    
    <!-- 左侧面板：多重彩表格 -->
    <div class="left-panel">
      <!-- 分类筛选 -->
      <div class="card" style="margin-bottom:12px">
        <h4 style="margin:0 0 8px;color:#334155">🏷️ 按分类筛选</h4>
        <div id="categoryNav" class="category-nav" style="display:flex;flex-wrap:wrap;gap:6px">
          <!-- 分类导航将在这里动态生成 -->
        </div>
      </div>
      
      <div class="card">
        <h3 style="margin:0 0 12px;color:#334155">📋 多重彩列表</h3>
        <div class="row" style="margin-bottom:12px;gap:8px">
          <input id="searchGroups" placeholder="搜索多重彩..." style="width:200px">
          <button id="filterAll" class="filter-btn active" data-status="all">全部</button>
          <button id="filterPending" class="filter-btn" data-status="pending">待定</button>
          <button id="filterWin" class="filter-btn" data-status="win">已赢</button>
          <button id="filterLoss" class="filter-btn" data-status="loss">已输</button>
        </div>
        <div>
          <table class="multi-bet-table" id="multiBetTable">
            <thead>
              <tr>
                <th style="width:80px">日期</th>
                <th style="width:100px">联赛</th>
                <th style="width:150px">比赛</th>
                <th style="width:100px">投注内容</th>
                <th style="width:60px">赔率</th>
                <th style="width:80px">结果</th>
                <th style="width:100px">操作</th>
              </tr>
            </thead>
            <tbody id="multiBetList">
              <!-- 多重彩表格内容将在这里动态生成 -->
            </tbody>
          </table>
          <!-- 总结信息容器 -->
          <div id="multiBetSummary"></div>
        </div>
      </div>
    </div>
    
    <!-- 右侧面板：数据录入和统计 -->
    <div class="right-panel">
      
      <!-- 多重彩管理面板 -->
      <div class="card">
        <div class="row" style="align-items:center;margin-bottom:16px">
          <h3 style="margin:0;color:#334155">📝 多重彩管理</h3>
          <button id="formIndentToggle" class="btn-small" style="margin-left:auto">📁 折叠</button>
        </div>
        
        <!-- 标签页导航 -->
        <div class="tab-nav" style="display:flex;border-bottom:1px solid #e2e8f0;margin-bottom:16px">
          <button class="tab-btn active" data-tab="new-multibet" style="padding:8px 16px;border:none;background:none;color:#3b82f6;border-bottom:2px solid #3b82f6;cursor:pointer;font-weight:500">新建多重彩</button>
          <button class="tab-btn" data-tab="category-manage" style="padding:8px 16px;border:none;background:none;color:#64748b;border-bottom:2px solid transparent;cursor:pointer;font-weight:500">分类管理</button>
          <button class="tab-btn" data-tab="league-manage" style="padding:8px 16px;border:none;background:none;color:#64748b;border-bottom:2px solid transparent;cursor:pointer;font-weight:500">联赛管理</button>
        </div>
        
        <!-- 新建多重彩标签页 -->
        <div class="tab-content" id="new-multibet" style="display:block">
          <!-- 多重彩基本信息 -->
          <div class="row" style="margin-bottom:12px">
            <div class="field" style="flex:1">
              <label>分类 <span style="color:#ef4444">*</span></label>
              <select id="categorySelect" required>
                <option value="">请选择分类</option>
              </select>
            </div>
            <div class="field" style="flex:2">
              <label>多重彩名称（可选）</label>
              <input id="groupName" placeholder="如：周末精选三串一">
            </div>
            <div class="field" style="flex:1">
              <label>总投注金额</label>
              <input id="totalStake" type="number" step="0.01" placeholder="100.00">
            </div>
          </div>
          
          <!-- 比赛录入区域 -->
          <div style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:12px">
            <div class="row" style="align-items:center;margin-bottom:8px">
              <h4 style="margin:0;color:#475569">添加比赛</h4>
              <button id="addMatchBtn" class="btn" style="margin-left:auto">+ 添加比赛</button>
            </div>
            
            <div id="matchInputs">
              <!-- 比赛输入表单将在这里动态生成 -->
            </div>
            
            <div class="row" style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0">
              <div class="field" style="flex:1">
                <label>总赔率</label>
                <input id="totalOdds" type="number" step="0.0001" readonly style="background:#f8fafc">
              </div>
              <div class="field" style="flex:1">
                <label>预期返还</label>
                <input id="expectedReturn" type="number" step="0.01" readonly style="background:#f8fafc">
              </div>
            </div>
          </div>
          
          <div class="row">
            <button id="saveMultiBet" class="btn" disabled>保存多重彩</button>
            <button id="clearForm" class="btn sec">清空表单</button>
          </div>
        </div>
        
        <!-- 分类管理标签页 -->
        <div class="tab-content" id="category-manage" style="display:none">
          <!-- 添加新分类 -->
          <div style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:12px">
            <h4 style="margin:0 0 8px;color:#475569">添加新分类</h4>
            <div class="row" style="margin-bottom:8px">
              <div class="field" style="flex:2">
                <label>分类名称</label>
                <input id="newCategoryName" placeholder="如：足球">
              </div>
              <div class="field" style="flex:1">
                <label>颜色</label>
                <input id="newCategoryColor" type="color" value="#3b82f6">
              </div>
            </div>
            <div class="field" style="margin-bottom:8px">
              <label>描述（可选）</label>
              <input id="newCategoryDescription" placeholder="如：足球相关的多重彩投注">
            </div>
            <button id="addCategoryBtn" class="btn">添加分类</button>
          </div>
          
          <!-- 现有分类列表 -->
          <div>
            <h4 style="margin:0 0 8px;color:#475569">现有分类</h4>
            <div id="categoriesList">
              <!-- 分类列表将在这里动态生成 -->
            </div>
          </div>
        </div>
        
        <!-- 联赛管理标签页 -->
        <div class="tab-content" id="league-manage" style="display:none">
          <!-- 添加新联赛 -->
          <div style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:12px">
            <h4 style="margin:0 0 8px;color:#475569">添加新联赛</h4>
            <div class="row" style="margin-bottom:8px">
              <div class="field" style="flex:2">
                <label>联赛名称</label>
                <input id="newLeagueName" placeholder="如：英超">
              </div>
              <div class="field" style="flex:1">
                <label>国家/地区</label>
                <input id="newLeagueCountry" placeholder="如：英格兰">
              </div>
            </div>
            <div class="field" style="margin-bottom:8px">
              <label>描述（可选）</label>
              <input id="newLeagueDescription" placeholder="如：英格兰足球超级联赛">
            </div>
            <button id="addLeagueBtn" class="btn">添加联赛</button>
          </div>
          
          <!-- 现有联赛列表 -->
          <div>
            <h4 style="margin:0 0 8px;color:#475569">现有联赛</h4>
            <div style="margin-bottom:8px">
              <input id="searchLeagues" placeholder="搜索联赛..." style="width:100%">
            </div>
            <div id="leaguesList" style="max-height:300px;overflow-y:auto">
              <!-- 联赛列表将在这里动态生成 -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- 统计报表 -->
      <div class="card">
        <h3 style="margin:0 0 12px;color:#334155">📊 统计报表</h3>
        
        <!-- 主统计区 -->
        <div style="margin-bottom:16px">
          <h4 style="margin:0 0 8px;color:#475569">多重彩整体统计</h4>
          <table class="small">
            <thead>
              <tr>
                <th>状态</th>
                <th class="right">数量</th>
                <th class="right">投入金额</th>
                <th class="right">返还金额</th>
                <th class="right">净收益</th>
                <th class="right">胜率</th>
              </tr>
            </thead>
            <tbody id="overallStatsBody">
              <!-- 统计数据将在这里动态生成 -->
            </tbody>
          </table>
        </div>
        
        <!-- 按联赛统计 -->
        <div style="margin-bottom:16px">
          <h4 style="margin:0 0 8px;color:#475569">按联赛统计（基于单场比赛）</h4>
          <table class="small">
            <thead>
              <tr>
                <th>联赛</th>
                <th class="right">参与次数</th>
                <th class="right">胜场</th>
                <th class="right">负场</th>
                <th class="right">胜率</th>
              </tr>
            </thead>
            <tbody id="leagueStatsBody">
              <!-- 联赛统计将在这里动态生成 -->
            </tbody>
          </table>
        </div>
        
        <!-- 按内容统计 -->
        <div>
          <h4 style="margin:0 0 8px;color:#475569">按内容统计（基于单场比赛）</h4>
          <table class="small">
            <thead>
              <tr>
                <th>投注内容</th>
                <th class="right">参与次数</th>
                <th class="right">胜场</th>
                <th class="right">负场</th>
                <th class="right">胜率</th>
              </tr>
            </thead>
            <tbody id="contentStatsBody">
              <!-- 内容统计将在这里动态生成 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 全局加载指示器 -->
<div id="loadingIndicator" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:8px;z-index:1000;display:none;text-align:center">
  <div style="margin-bottom:10px">数据处理中...</div>
  <div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
// Supabase 配置
const SUPABASE_URL = 'https://hutlxrvwqrmidragxmtx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1dGx4cnZ3cXJtaWRyYWd4bXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMjk3ODMsImV4cCI6MjA3MTYwNTc4M30.KhDGniZHLEnmYJQWugq-U0o6EyZwmCPiXNbat_8Tyg4';

// 初始化 Supabase 客户端
let supabase;
try {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('Supabase 客户端初始化成功');
} catch (error) {
  console.error('Supabase 客户端初始化失败:', error);
  alert('数据库连接失败，请检查配置');
}

// 全局变量
let multiBetGroups = [];
let currentMatches = [];
let profileKey = 'default'; // 可以根据需要扩展多用户支持
let isFormCollapsed = false; // 录入表单折叠状态

// 工具函数
function $(selector) {
  return document.querySelector(selector);
}

function showLoading() {
  $('#loadingIndicator').style.display = 'block';
}

function hideLoading() {
  $('#loadingIndicator').style.display = 'none';
}



// 切换录入表单折叠功能
function toggleFormCollapse() {
  isFormCollapsed = !isFormCollapsed;
  const managementPanel = $('#formIndentToggle').closest('.card');
  const formCollapseToggle = $('#formIndentToggle');
  
  if (isFormCollapsed) {
    managementPanel.classList.add('form-collapsed');
    formCollapseToggle.textContent = '📂 展开';
    formCollapseToggle.style.backgroundColor = '#10b981';
    formCollapseToggle.style.color = 'white';
  } else {
    managementPanel.classList.remove('form-collapsed');
    formCollapseToggle.textContent = '📁 折叠';
    formCollapseToggle.style.backgroundColor = '';
    formCollapseToggle.style.color = '';
  }
}

// 数据库操作
const multiBetDB = {
  // 获取所有分类
  async getAllCategories() {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { data, error } = await supabase
      .from('multi_bet_categories')
      .select('*')
      .eq('profile_key', profileKey)
      .order('name');
    
    if (error) throw error;
    return data || [];
  },
  
  // 创建新分类
  async createCategory(categoryData) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { data, error } = await supabase
      .from('multi_bet_categories')
      .insert({
        profile_key: profileKey,
        name: categoryData.name,
        description: categoryData.description,
        color: categoryData.color || '#3b82f6'
      })
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },
  
  // 更新分类
  async updateCategory(categoryId, categoryData) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { data, error } = await supabase
      .from('multi_bet_categories')
      .update({
        name: categoryData.name,
        description: categoryData.description,
        color: categoryData.color
      })
      .eq('id', categoryId)
      .eq('profile_key', profileKey)
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },
  
  // 删除分类
  async deleteCategory(categoryId) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    // 检查是否有多重彩使用此分类
    const { data: groups, error: checkError } = await supabase
      .from('multi_bet_groups')
      .select('id')
      .eq('category_id', categoryId)
      .eq('profile_key', profileKey)
      .limit(1);
    
    if (checkError) throw checkError;
    if (groups && groups.length > 0) {
      throw new Error('无法删除：该分类下还有多重彩记录');
    }
    
    const { error } = await supabase
      .from('multi_bet_categories')
      .delete()
      .eq('id', categoryId)
      .eq('profile_key', profileKey);
    
    if (error) throw error;
  },

  // 获取所有联赛
  async getAllLeagues() {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { data, error } = await supabase
      .from('leagues')
      .select('*')
      .eq('profile_key', profileKey)
      .order('name');
    
    if (error) throw error;
    return data || [];
  },

  // 创建新联赛
  async createLeague(leagueData) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { data, error } = await supabase
      .from('leagues')
      .insert({
        profile_key: profileKey,
        name: leagueData.name,
        country: leagueData.country,
        description: leagueData.description
      })
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },

  // 更新联赛
  async updateLeague(leagueId, leagueData) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { data, error } = await supabase
      .from('leagues')
      .update({
        name: leagueData.name,
        country: leagueData.country,
        description: leagueData.description
      })
      .eq('id', leagueId)
      .eq('profile_key', profileKey)
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },

  // 删除联赛
  async deleteLeague(leagueId) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { error } = await supabase
      .from('leagues')
      .delete()
      .eq('id', leagueId)
      .eq('profile_key', profileKey);
    
    if (error) throw error;
  },

  // 获取所有多重彩组
  async getAllGroups() {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { data, error } = await supabase
      .from('multi_bet_groups')
      .select(`
        *,
        multi_bet_categories(name, color),
        multi_bet_matches(*)
      `)
      .eq('profile_key', profileKey)
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    return data || [];
  },
  
  // 创建新的多重彩组
  async createGroup(groupData, matches) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    // 计算总赔率
    const totalOdds = matches.reduce((acc, match) => acc * match.odds, 1);
    
    // 创建多重彩组
    const { data: group, error: groupError } = await supabase
      .from('multi_bet_groups')
      .insert({
        profile_key: profileKey,
        category_id: groupData.categoryId,
        group_name: groupData.name,
        total_odds: totalOdds,
        total_stake: groupData.stake,
        match_count: matches.length
      })
      .select()
      .single();
    
    if (groupError) throw groupError;
    
    // 添加比赛记录
    const matchesWithGroupId = matches.map((match, index) => ({
      group_id: group.id,
      date: match.date,
      league: match.league,
      match: match.match,
      description: match.description,
      odds: match.odds,
      match_order: index + 1
    }));
    
    const { error: matchesError } = await supabase
      .from('multi_bet_matches')
      .insert(matchesWithGroupId);
    
    if (matchesError) throw matchesError;
    
    return group;
  },
  
  // 更新比赛结果
  async updateMatchResult(matchId, result) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    // 更新单场比赛结果
    const { error } = await supabase
      .from('multi_bet_matches')
      .update({ result })
      .eq('id', matchId);
    
    if (error) throw error;
    
    // 获取该比赛所属的多重彩组ID
    const { data: matchData, error: matchError } = await supabase
      .from('multi_bet_matches')
      .select('group_id')
      .eq('id', matchId)
      .single();
    
    if (matchError) throw matchError;
    
    // 获取该组所有比赛的结果
    const { data: matches, error: matchesError } = await supabase
      .from('multi_bet_matches')
      .select('result')
      .eq('group_id', matchData.group_id);
    
    if (matchesError) throw matchesError;
    
    // 计算整个多重彩组的结果
    let groupResult = 'pending';
    const results = matches.map(m => m.result);
    
    if (results.includes('loss')) {
      // 有任何一场输，整个多重彩就是输
      groupResult = 'loss';
    } else if (results.every(r => r === 'win')) {
      // 所有场次都赢，整个多重彩才算赢
      groupResult = 'win';
    } else {
      // 有待定场次，整个多重彩为待定
      groupResult = 'pending';
    }
    
    // 更新多重彩组的结果
    const { error: groupError } = await supabase
      .from('multi_bet_groups')
      .update({ result: groupResult })
      .eq('id', matchData.group_id);
    
    if (groupError) throw groupError;
  },
  
  // 删除多重彩组
  async deleteGroup(groupId) {
    if (!supabase) throw new Error('Supabase 未初始化');
    
    const { error } = await supabase
      .from('multi_bet_groups')
      .delete()
      .eq('id', groupId);
    
    if (error) throw error;
  }
};

// UI 渲染函数
function renderMultiBetList() {
  const container = $('#multiBetList');
  const summaryContainer = $('#multiBetSummary');
  const searchTerm = $('#searchGroups').value.toLowerCase();
  const activeFilterBtn = document.querySelector('.filter-btn.active');
  const statusFilter = activeFilterBtn ? activeFilterBtn.dataset.status : 'all';
  const categoryFilter = window.currentCategoryFilter;
  
  let filteredGroups = multiBetGroups;
  
  // 应用搜索过滤
  if (searchTerm) {
    filteredGroups = filteredGroups.filter(group => 
      (group.group_name || '').toLowerCase().includes(searchTerm) ||
      group.multi_bet_matches.some(match => 
        (match.league || '').toLowerCase().includes(searchTerm) ||
        (match.match || '').toLowerCase().includes(searchTerm) ||
        (match.description || '').toLowerCase().includes(searchTerm)
      )
    );
  }
  
  // 应用状态过滤
  if (statusFilter !== 'all') {
    filteredGroups = filteredGroups.filter(group => group.result === statusFilter);
  }
  
  // 应用分类过滤
  if (categoryFilter) {
    filteredGroups = filteredGroups.filter(group => group.category_id == categoryFilter);
  }
  
  if (filteredGroups.length === 0) {
    container.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#64748b">暂无多重彩记录</td></tr>';
    summaryContainer.innerHTML = '';
    return;
  }
  
  // 生成分组显示的内容
  let allContent = [];
  
  // 按分类对多重彩组进行分组，并为每个分类内的组分配序号
  const groupsByCategory = {};
  filteredGroups.forEach(group => {
    const categoryId = group.category_id || 'uncategorized';
    if (!groupsByCategory[categoryId]) {
      groupsByCategory[categoryId] = [];
    }
    groupsByCategory[categoryId].push(group);
  });
  
  // 为每个分类内的组分配序号并渲染
  Object.values(groupsByCategory).forEach(categoryGroups => {
    categoryGroups.forEach((group, indexInCategory) => {
      const matches = group.multi_bet_matches || [];
      const categoryName = group.multi_bet_categories?.name || '未分类';
      const categoryColor = group.multi_bet_categories?.color || '#6b7280';
      const groupNumber = indexInCategory + 1; // 从1开始编号
      const groupName = group.group_name || `多重彩 #${groupNumber}`;
    
    // 根据结果设置背景颜色
    const resultBgColor = group.result === 'win' ? '#dcfce7' : 
                         group.result === 'loss' ? '#fee2e2' : '#f1f5f9';
    const resultTextColor = group.result === 'win' ? '#166534' : 
                           group.result === 'loss' ? '#991b1b' : '#475569';
    
    // 生成组标题（合并标题和操作区域）
    const groupHeader = `
      <div style="background:${resultBgColor};color:${resultTextColor};padding:8px 12px;margin:16px 0 0 0;border-radius:4px;font-size:14px;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-left:4px solid ${categoryColor}">
        <span>
          <span class="category-tag" style="background:${categoryColor};color:white;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;margin-right:8px">
            ${categoryName}
          </span>
          <span style="margin-right:12px;font-weight:700">${groupName}</span>
          <span style="font-size:12px;opacity:0.8">${matches.length}场比赛</span>
        </span>
        <span style="display:flex;align-items:center;gap:16px">
          <span style="font-size:14px;font-weight:600;color:${resultTextColor}">
             赔率 <span style="color:#1f2937;font-size:18px;font-weight:700">${group.total_odds.toFixed(2)}</span>
           </span>
           <span style="font-size:14px;font-weight:600">
             本金 ¥${group.total_stake.toFixed(2)}
           </span>
           <span style="font-size:14px;font-weight:600">
             ${group.result === 'win' ? 
               '利润 <span style="color:#16a34a;font-size:18px;font-weight:700">+¥' + ((group.total_odds * group.total_stake) - group.total_stake).toFixed(2) + '</span>' : 
               group.result === 'loss' ? 
               '亏损 <span style="color:#dc2626;font-size:18px;font-weight:700">-¥' + group.total_stake.toFixed(2) + '</span>' : 
               '<span style="color:#64748b">待定</span>'}
           </span>
          <span class="result-tag" style="font-size:14px;padding:4px 12px;border-radius:6px;font-weight:700;background:${group.result === 'win' ? '#16a34a' : group.result === 'loss' ? '#dc2626' : '#64748b'};color:white">
            ${(group.result || 'pending') === 'win' ? '✓ 赢' : (group.result || 'pending') === 'loss' ? '✗ 输' : '⏳ 待定'}
          </span>
          <button class="btn" style="padding:6px 12px;font-size:12px;background:#6b7280;border:1px solid #4b5563;color:white;border-radius:4px;cursor:pointer;font-weight:600" onclick="deleteMultiBetGroup(${group.id})">删除组</button>
        </span>
      </div>
    `;
    
    // 生成该组的表格
    let groupTableRows = [];
    matches.forEach((match, index) => {
      const groupResultClass = (group.result || 'pending') === 'win' ? 'result-win' : 
                              (group.result || 'pending') === 'loss' ? 'result-loss' : 'result-pending';
      
      let row = '<tr class="' + groupResultClass + '">';
      
      row += `
        <td style="padding:6px;font-size:12px">${match.date || '未知'}</td>
        <td style="padding:6px;font-size:12px">${match.league || '未知联赛'}</td>
        <td style="padding:6px;font-size:12px" title="${match.match || '未知比赛'}">
          ${match.match || '未知比赛'}
        </td>
        <td style="padding:6px;font-size:12px">${match.description || '未知内容'}</td>
        <td style="padding:6px;font-size:12px;font-weight:500">${match.odds ? match.odds.toFixed(3) : '0.000'}</td>
        <td style="padding:6px;text-align:center">
          <span class="result-tag result-${match.result}" style="font-size:10px;padding:2px 6px;border-radius:3px">
            ${match.result === 'win' ? '✓ 赢' : match.result === 'loss' ? '✗ 输' : '⏳ 待定'}
          </span>
        </td>
        <td style="padding:6px;text-align:center">
          <div class="result-buttons" style="display:flex;gap:2px;justify-content:center">
            <button class="result-btn ${match.result === 'win' ? 'active' : ''}" 
                    style="padding:2px 6px;font-size:10px;border:1px solid #22c55e;background:${match.result === 'win' ? '#22c55e' : 'white'};color:${match.result === 'win' ? 'white' : '#22c55e'};border-radius:3px;cursor:pointer" 
                    onclick="updateMatchResult(${match.id}, 'win')">赢</button>
            <button class="result-btn ${match.result === 'loss' ? 'active' : ''}" 
                    style="padding:2px 6px;font-size:10px;border:1px solid #ef4444;background:${match.result === 'loss' ? '#ef4444' : 'white'};color:${match.result === 'loss' ? 'white' : '#ef4444'};border-radius:3px;cursor:pointer" 
                    onclick="updateMatchResult(${match.id}, 'loss')">输</button>
            <button class="result-btn ${match.result === 'pending' ? 'active' : ''}" 
                    style="padding:2px 6px;font-size:10px;border:1px solid #94a3b8;background:${match.result === 'pending' ? '#94a3b8' : 'white'};color:${match.result === 'pending' ? 'white' : '#94a3b8'};border-radius:3px;cursor:pointer" 
                    onclick="updateMatchResult(${match.id}, 'pending')">待定</button>
          </div>
        </td>
      </tr>`;
      
      groupTableRows.push(row);
    });
    
    const groupTable = `
      <table class="multi-bet-table" style="margin:0 0 16px 0;border:1px solid #e2e8f0;border-top:none;border-radius:0 0 4px 4px">
        <tbody>
          ${groupTableRows.join('')}
        </tbody>
      </table>
    `;
    
    // 将该组的完整内容添加到数组中
    allContent.push(groupHeader + groupTable);
    });
  });
  
  // 清空容器并添加所有内容
  container.innerHTML = '';
  summaryContainer.innerHTML = allContent.join('');
}

function addMatchInput() {
  const container = $('#matchInputs');
  const index = currentMatches.length;
  
  const matchHtml = `
    <div class="match-input" data-index="${index}" style="border:1px solid #e2e8f0;border-radius:4px;padding:8px;margin-bottom:8px">
      <div class="row" style="align-items:center;margin-bottom:8px">
        <span style="font-weight:500;color:#475569">比赛 ${index + 1}</span>
        <button type="button" class="btn warn" style="padding:2px 6px;font-size:10px;margin-left:auto" onclick="removeMatchInput(${index})">删除</button>
      </div>
      
      <div class="row" style="margin-bottom:8px">
        <div class="field" style="flex:1">
          <label>日期</label>
          <input type="date" data-field="date" data-index="${index}" value="${new Date().toISOString().slice(0,10)}">
        </div>
        <div class="field" style="flex:2">
          <label>联赛</label>
          <div style="position:relative">
            <input type="text" data-field="league" data-index="${index}" placeholder="如：英超" list="leagueDatalist" autocomplete="off">
            <datalist id="leagueDatalist">
              <!-- 联赛选项将在这里动态生成 -->
            </datalist>
          </div>
        </div>
      </div>
      
      <div class="row" style="margin-bottom:8px">
        <div class="field" style="flex:2">
          <label>比赛</label>
          <input type="text" data-field="match" data-index="${index}" placeholder="如：曼联 vs 利物浦">
        </div>
        <div class="field" style="flex:2">
          <label>投注内容</label>
          <input type="text" data-field="description" data-index="${index}" placeholder="如：主胜">
        </div>
        <div class="field" style="flex:1">
          <label>赔率</label>
          <input type="number" step="0.001" data-field="odds" data-index="${index}" placeholder="1.850">
        </div>
      </div>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', matchHtml);
  
  // 初始化currentMatches数组，包含默认日期值
  const defaultDate = new Date().toISOString().slice(0,10);
  currentMatches.push({
    date: defaultDate,
    league: '',
    match: '',
    description: '',
    odds: 0
  });
  
  // 添加事件监听器
  const inputs = container.querySelectorAll(`[data-index="${index}"]`);
  inputs.forEach(input => {
    input.addEventListener('input', updateMatchData);
  });
  
  updateTotalOdds();
  updateSaveButton();
}

function removeMatchInput(index) {
  const matchInput = $(`.match-input[data-index="${index}"]`);
  if (matchInput) {
    matchInput.remove();
    currentMatches.splice(index, 1);
    
    // 重新编号
    const remainingInputs = $('#matchInputs').querySelectorAll('.match-input');
    remainingInputs.forEach((input, newIndex) => {
      input.dataset.index = newIndex;
      input.querySelector('span').textContent = `比赛 ${newIndex + 1}`;
      
      const inputs = input.querySelectorAll('[data-index]');
      inputs.forEach(inp => {
        inp.dataset.index = newIndex;
      });
      
      const deleteBtn = input.querySelector('button');
      deleteBtn.setAttribute('onclick', `removeMatchInput(${newIndex})`);
    });
    
    updateTotalOdds();
    updateSaveButton();
  }
}

function updateMatchData(event) {
  const index = parseInt(event.target.dataset.index);
  const field = event.target.dataset.field;
  const value = event.target.value;
  
  if (!currentMatches[index]) {
    currentMatches[index] = {};
  }
  
  currentMatches[index][field] = field === 'odds' ? parseFloat(value) || 0 : value;
  
  updateTotalOdds();
  updateSaveButton();
}

function updateTotalOdds() {
  const validOdds = currentMatches
    .map(match => match.odds || 0)
    .filter(odds => odds > 0);
  
  const totalOdds = validOdds.length > 0 ? 
    validOdds.reduce((acc, odds) => acc * odds, 1) : 0;
  
  $('#totalOdds').value = totalOdds.toFixed(4);
  
  const stake = parseFloat($('#totalStake').value) || 0;
  const expectedReturn = totalOdds * stake;
  $('#expectedReturn').value = expectedReturn.toFixed(2);
}

function updateSaveButton() {
  // 检查是否有至少一个比赛输入框
  const matchInputs = $('#matchInputs').querySelectorAll('.match-input');
  const hasMatchInputs = matchInputs.length > 0;
  
  // 检查所有比赛输入框是否都填写完整
  let hasValidMatches = false;
  if (hasMatchInputs) {
    hasValidMatches = Array.from(matchInputs).every(matchInput => {
      const dateInput = matchInput.querySelector('[data-field="date"]');
      const leagueInput = matchInput.querySelector('[data-field="league"]');
      const matchNameInput = matchInput.querySelector('[data-field="match"]');
      const descriptionInput = matchInput.querySelector('[data-field="description"]');
      const oddsInput = matchInput.querySelector('[data-field="odds"]');
      
      return dateInput?.value && 
             leagueInput?.value.trim() && 
             matchNameInput?.value.trim() && 
             descriptionInput?.value.trim() && 
             parseFloat(oddsInput?.value) > 0;
    });
  }
  
  const hasStake = parseFloat($('#totalStake').value) > 0;
  const hasCategory = $('#categorySelect').value !== '';
  
  const saveButton = $('#saveMultiBet');
  if (saveButton) {
    saveButton.disabled = !(hasValidMatches && hasStake && hasCategory);
  }
}

// 事件处理函数
async function updateMatchResult(matchId, result) {
  try {
    showLoading();
    await multiBetDB.updateMatchResult(matchId, result);
    await loadData();
  } catch (error) {
    console.error('更新比赛结果失败:', error);
    alert('更新失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function deleteMultiBetGroup(groupId) {
  if (!confirm('确定要删除这个多重彩吗？此操作不可撤销。')) return;
  
  try {
    showLoading();
    await multiBetDB.deleteGroup(groupId);
    await loadData();
  } catch (error) {
    console.error('删除多重彩失败:', error);
    alert('删除失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function saveMultiBet() {
  try {
    showLoading();
    
    const groupData = {
      categoryId: parseInt($('#categorySelect').value),
      name: $('#groupName').value.trim() || null,
      stake: parseFloat($('#totalStake').value)
    };
    
    await multiBetDB.createGroup(groupData, currentMatches);
    
    // 清空表单
    clearForm();
    
    // 重新加载数据
    await loadData();
    
    alert('多重彩保存成功！');
  } catch (error) {
    console.error('保存多重彩失败:', error);
    alert('保存失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

function clearForm() {
  $('#categorySelect').value = '';
  $('#groupName').value = '';
  $('#totalStake').value = '';
  $('#matchInputs').innerHTML = '';
  $('#totalOdds').value = '';
  $('#expectedReturn').value = '';
  currentMatches = [];
  updateSaveButton();
}

// 统计函数
function updateKPIs() {
  // 根据当前分类过滤数据
  const categoryFilter = window.currentCategoryFilter;
  let filteredGroups = multiBetGroups;
  if (categoryFilter) {
    filteredGroups = multiBetGroups.filter(group => group.category_id == categoryFilter);
  }
  
  const totalGroups = filteredGroups.length;
  const settledGroups = filteredGroups.filter(g => g.result !== 'pending');
  const winGroups = filteredGroups.filter(g => g.result === 'win');
  
  // 只计算已结算的多重彩组的投入和返还
  const totalStake = settledGroups.reduce((sum, g) => sum + g.total_stake, 0);
  const totalReturn = winGroups.reduce((sum, g) => sum + (g.total_stake * g.total_odds), 0);
  const netProfit = totalReturn - totalStake;
  
  const winRate = settledGroups.length > 0 ? (winGroups.length / settledGroups.length * 100) : 0;
  const roi = totalStake > 0 ? (netProfit / totalStake * 100) : 0;
  
  $('#k_total_groups').textContent = totalGroups;
  $('#k_settled_groups').textContent = settledGroups.length;
  $('#k_win_rate').textContent = winRate.toFixed(1) + '%';
  $('#k_total_stake').textContent = '¥' + totalStake.toFixed(2);
  $('#k_total_return').textContent = '¥' + totalReturn.toFixed(2);
  $('#k_net_profit').textContent = '¥' + netProfit.toFixed(2);
  $('#k_net_profit').className = 'k-val ' + (netProfit >= 0 ? 'pos' : 'neg');
  $('#k_roi').textContent = roi.toFixed(1) + '%';
  $('#k_roi').className = 'k-val ' + (roi >= 0 ? 'pos' : 'neg');
}

function renderStats() {
  // 根据当前分类过滤数据
  const categoryFilter = window.currentCategoryFilter;
  let filteredGroups = multiBetGroups;
  if (categoryFilter) {
    filteredGroups = multiBetGroups.filter(group => group.category_id == categoryFilter);
  }
  
  // 整体统计
  const overallStats = {
    pending: filteredGroups.filter(g => g.result === 'pending'),
    win: filteredGroups.filter(g => g.result === 'win'),
    loss: filteredGroups.filter(g => g.result === 'loss')
  };
  
  const overallStatsHtml = Object.entries(overallStats).map(([status, groups]) => {
    const count = groups.length;
    // 待定状态不参与金额计算
    const stake = status === 'pending' ? 0 : groups.reduce((sum, g) => sum + g.total_stake, 0);
    const returns = status === 'win' ? groups.reduce((sum, g) => sum + (g.total_stake * g.total_odds), 0) : 0;
    const profit = returns - stake;
    const winRate = status === 'pending' ? '-' : (status === 'win' ? '100%' : '0%');
    
    const statusText = status === 'pending' ? '待定' : status === 'win' ? '已赢' : '已输';
    
    // 待定状态的金额显示为横线
    const stakeDisplay = status === 'pending' ? '-' : `¥${stake.toFixed(2)}`;
    const returnsDisplay = status === 'pending' ? '-' : `¥${returns.toFixed(2)}`;
    const profitDisplay = status === 'pending' ? '-' : `¥${profit.toFixed(2)}`;
    
    return `
      <tr>
        <td><span class="result-tag result-${status}">${statusText}</span></td>
        <td class="right">${count}</td>
        <td class="right">${stakeDisplay}</td>
        <td class="right">${returnsDisplay}</td>
        <td class="right ${status !== 'pending' && profit >= 0 ? 'pos' : status !== 'pending' && profit < 0 ? 'neg' : ''}">${profitDisplay}</td>
        <td class="right">${winRate}</td>
      </tr>
    `;
  }).join('');
  
  $('#overallStatsBody').innerHTML = overallStatsHtml;
  
  // 按联赛统计（只统计已结算的比赛）
  const leagueStats = {};
  filteredGroups.forEach(group => {
    (group.multi_bet_matches || []).forEach(match => {
      // 跳过待定状态的比赛
      if (match.result === 'pending') return;
      
      const league = match.league || '未知联赛';
      if (!leagueStats[league]) {
        leagueStats[league] = { total: 0, win: 0, loss: 0 };
      }
      leagueStats[league].total++;
      if (match.result === 'win') leagueStats[league].win++;
      if (match.result === 'loss') leagueStats[league].loss++;
    });
  });
  
  const leagueStatsHtml = Object.entries(leagueStats)
    .sort(([,a], [,b]) => b.total - a.total)
    .map(([league, stats]) => {
      const winRate = stats.total > 0 ? (stats.win / (stats.win + stats.loss) * 100) : 0;
      return `
        <tr>
          <td>${league}</td>
          <td class="right">${stats.total}</td>
          <td class="right">${stats.win}</td>
          <td class="right">${stats.loss}</td>
          <td class="right">${isNaN(winRate) ? '-' : winRate.toFixed(1) + '%'}</td>
        </tr>
      `;
    }).join('');
  
  $('#leagueStatsBody').innerHTML = leagueStatsHtml || '<tr><td colspan="5" class="muted" style="text-align:center">暂无数据</td></tr>';
  
  // 按内容统计（只统计已结算的比赛）
  const contentStats = {};
  filteredGroups.forEach(group => {
    (group.multi_bet_matches || []).forEach(match => {
      // 跳过待定状态的比赛
      if (match.result === 'pending') return;
      
      const content = match.description || '未知内容';
      if (!contentStats[content]) {
        contentStats[content] = { total: 0, win: 0, loss: 0 };
      }
      contentStats[content].total++;
      if (match.result === 'win') contentStats[content].win++;
      if (match.result === 'loss') contentStats[content].loss++;
    });
  });
  
  const contentStatsHtml = Object.entries(contentStats)
    .sort(([,a], [,b]) => b.total - a.total)
    .map(([content, stats]) => {
      const winRate = stats.total > 0 ? (stats.win / (stats.win + stats.loss) * 100) : 0;
      return `
        <tr>
          <td>${content}</td>
          <td class="right">${stats.total}</td>
          <td class="right">${stats.win}</td>
          <td class="right">${stats.loss}</td>
          <td class="right">${isNaN(winRate) ? '-' : winRate.toFixed(1) + '%'}</td>
        </tr>
      `;
    }).join('');
  
  $('#contentStatsBody').innerHTML = contentStatsHtml || '<tr><td colspan="5" class="muted" style="text-align:center">暂无数据</td></tr>';
}

// 加载分类数据
async function loadCategories() {
  try {
    const categories = await multiBetDB.getAllCategories();
    const categorySelect = $('#categorySelect');
    
    // 清空现有选项（保留默认选项）
    categorySelect.innerHTML = '<option value="">请选择分类</option>';
    
    // 添加分类选项
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      option.style.color = category.color;
      categorySelect.appendChild(option);
    });
  } catch (error) {
    console.error('加载分类失败:', error);
  }
}

// 数据加载
async function loadData() {
  try {
    showLoading();
    multiBetGroups = await multiBetDB.getAllGroups();
    renderMultiBetList();
    updateKPIs();
    renderStats();
  } catch (error) {
    console.error('加载数据失败:', error);
    alert('加载数据失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 渲染分类导航菜单
async function renderCategoryNav() {
  try {
    const categories = await multiBetDB.getAllCategories();
    const categoryNavEl = $('#categoryNav');
    
    // 添加"全部"选项
    let navHtml = `
      <a href="#" class="category-nav-link active" data-category-id="all">
        <span class="dot" style="background:#6b7280"></span>
        全部
      </a>
    `;
    
    // 添加各个分类
    categories.forEach(category => {
      navHtml += `
        <a href="#" class="category-nav-link" data-category-id="${category.id}">
          <span class="dot" style="background:${category.color}"></span>
          ${category.name}
        </a>
      `;
    });
    
    categoryNavEl.innerHTML = navHtml;
    
    // 绑定点击事件
    categoryNavEl.querySelectorAll('.category-nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        
        // 更新激活状态
        categoryNavEl.querySelectorAll('.category-nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        // 设置当前选中的分类
        const categoryId = link.dataset.categoryId;
        window.currentCategoryFilter = categoryId === 'all' ? null : categoryId;
        
        // 重新渲染列表和统计
        renderMultiBetList();
        updateKPIs();
        renderStats();
      });
    });
  } catch (error) {
    console.error('渲染分类导航失败:', error);
  }
}

// 渲染分类列表
async function renderCategoriesList() {
  try {
    const categories = await multiBetDB.getAllCategories();
    const categoriesListEl = $('#categoriesList');
    
    if (categories.length === 0) {
      categoriesListEl.innerHTML = '<p class="muted" style="text-align:center;padding:20px">暂无分类</p>';
      return;
    }
    
    const categoriesHtml = categories.map(category => `
      <div class="category-item" style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="category-color" style="width:16px;height:16px;border-radius:50%;background:${category.color}"></span>
          <div>
            <div style="font-weight:500;color:#334155">${category.name}</div>
            ${category.description ? `<div style="font-size:12px;color:#64748b">${category.description}</div>` : ''}
          </div>
        </div>
        <div style="display:flex;gap:4px">
          <button class="btn-small" onclick="editCategory(${category.id}, '${category.name}', '${category.description || ''}', '${category.color}')">编辑</button>
          <button class="btn-small sec" onclick="deleteCategory(${category.id})">删除</button>
        </div>
      </div>
    `).join('');
    
    categoriesListEl.innerHTML = categoriesHtml;
  } catch (error) {
    console.error('渲染分类列表失败:', error);
  }
}

// 添加分类
async function addCategory() {
  const name = $('#newCategoryName').value.trim();
  const color = $('#newCategoryColor').value;
  const description = $('#newCategoryDescription').value.trim();
  
  if (!name) {
    alert('请输入分类名称');
    return;
  }
  
  try {
    showLoading();
    await multiBetDB.createCategory({ name, color, description });
    
    // 清空表单
    $('#newCategoryName').value = '';
    $('#newCategoryColor').value = '#3b82f6';
    $('#newCategoryDescription').value = '';
    
    // 重新加载分类列表和下拉选项
    await Promise.all([renderCategoriesList(), loadCategories()]);
    
    alert('分类添加成功');
  } catch (error) {
    console.error('添加分类失败:', error);
    alert('添加分类失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 编辑分类
function editCategory(id, name, description, color) {
  const newName = prompt('请输入新的分类名称:', name);
  if (newName === null) return;
  if (!newName.trim()) {
    alert('分类名称不能为空');
    return;
  }
  
  const newDescription = prompt('请输入新的描述（可选）:', description);
  if (newDescription === null) return;
  
  const newColor = prompt('请输入新的颜色（十六进制）:', color);
  if (newColor === null) return;
  if (!/^#[0-9A-Fa-f]{6}$/.test(newColor)) {
    alert('请输入有效的十六进制颜色代码（如：#3b82f6）');
    return;
  }
  
  updateCategoryData(id, {
    name: newName.trim(),
    description: newDescription.trim(),
    color: newColor
  });
}

// 更新分类数据
async function updateCategoryData(id, categoryData) {
  try {
    showLoading();
    await multiBetDB.updateCategory(id, categoryData);
    
    // 重新加载分类列表和下拉选项
    await Promise.all([renderCategoriesList(), loadCategories()]);
    
    alert('分类更新成功');
  } catch (error) {
    console.error('更新分类失败:', error);
    alert('更新分类失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 删除分类
async function deleteCategory(id) {
  if (!confirm('确定要删除这个分类吗？如果该分类下有多重彩记录，将无法删除。')) {
    return;
  }
  
  try {
    showLoading();
    await multiBetDB.deleteCategory(id);
    
    // 重新加载分类列表和下拉选项
    await Promise.all([renderCategoriesList(), loadCategories()]);
    
    alert('分类删除成功');
  } catch (error) {
    console.error('删除分类失败:', error);
    alert('删除分类失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 联赛管理功能

// 加载联赛列表到下拉选项
async function loadLeagues() {
  try {
    const leagues = await multiBetDB.getAllLeagues();
    const datalist = $('#leagueDatalist');
    
    if (datalist) {
      datalist.innerHTML = leagues.map(league => 
        `<option value="${league.name}">${league.name} (${league.country || ''})</option>`
      ).join('');
    }
  } catch (error) {
    console.error('加载联赛列表失败:', error);
  }
}

// 渲染联赛管理列表
async function renderLeaguesList() {
  try {
    const leagues = await multiBetDB.getAllLeagues();
    const container = $('#leaguesList');
    
    if (leagues.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:20px;color:#64748b">暂无联赛</div>';
      return;
    }
    
    container.innerHTML = leagues.map(league => `
      <div style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:8px;background:white">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:500;color:#1e293b">${league.name}</div>
            <div style="font-size:12px;color:#64748b">${league.country || ''} ${league.description ? '• ' + league.description : ''}</div>
          </div>
          <div style="display:flex;gap:4px">
            <button class="btn" style="padding:4px 8px;font-size:12px" onclick="editLeague(${league.id}, '${league.name}', '${league.country || ''}', '${league.description || ''}')">编辑</button>
            <button class="btn warn" style="padding:4px 8px;font-size:12px" onclick="deleteLeague(${league.id})">删除</button>
          </div>
        </div>
      </div>
    `).join('');
  } catch (error) {
    console.error('渲染联赛列表失败:', error);
    $('#leaguesList').innerHTML = '<div style="text-align:center;padding:20px;color:#ef4444">加载失败</div>';
  }
}

// 添加新联赛
async function addLeague() {
  const name = $('#newLeagueName').value.trim();
  const country = $('#newLeagueCountry').value.trim();
  const description = $('#newLeagueDescription').value.trim();
  
  if (!name) {
    alert('请输入联赛名称');
    return;
  }
  
  try {
    showLoading();
    await multiBetDB.createLeague({ name, country, description });
    
    // 清空表单
    $('#newLeagueName').value = '';
    $('#newLeagueCountry').value = '';
    $('#newLeagueDescription').value = '';
    
    // 重新加载联赛列表和下拉选项
    await Promise.all([renderLeaguesList(), loadLeagues()]);
    
    alert('联赛添加成功');
  } catch (error) {
    console.error('添加联赛失败:', error);
    alert('添加联赛失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 编辑联赛
function editLeague(id, currentName, currentCountry, currentDescription) {
  const newName = prompt('联赛名称:', currentName);
  if (newName === null) return;
  
  const newCountry = prompt('国家/地区:', currentCountry);
  if (newCountry === null) return;
  
  const newDescription = prompt('描述:', currentDescription);
  if (newDescription === null) return;
  
  updateLeagueData(id, {
    name: newName.trim(),
    country: newCountry.trim(),
    description: newDescription.trim()
  });
}

// 更新联赛数据
async function updateLeagueData(id, leagueData) {
  try {
    showLoading();
    await multiBetDB.updateLeague(id, leagueData);
    
    // 重新加载联赛列表和下拉选项
    await Promise.all([renderLeaguesList(), loadLeagues()]);
    
    alert('联赛更新成功');
  } catch (error) {
    console.error('更新联赛失败:', error);
    alert('更新联赛失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 删除联赛
async function deleteLeague(id) {
  if (!confirm('确定要删除这个联赛吗？')) {
    return;
  }
  
  try {
    showLoading();
    await multiBetDB.deleteLeague(id);
    
    // 重新加载联赛列表和下拉选项
    await Promise.all([renderLeaguesList(), loadLeagues()]);
    
    alert('联赛删除成功');
  } catch (error) {
    console.error('删除联赛失败:', error);
    alert('删除联赛失败: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 联赛搜索功能
function initLeagueSearch() {
  const searchInput = $('#searchLeagues');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const leagueItems = $('#leaguesList').children;
      
      Array.from(leagueItems).forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
      });
    });
  }
}

// 标签页切换功能
function initTabs() {
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const targetTab = this.getAttribute('data-tab');
      
      // 移除所有活动状态
      tabBtns.forEach(b => {
        b.classList.remove('active');
        b.style.color = '#64748b';
        b.style.borderBottomColor = 'transparent';
      });
      
      tabContents.forEach(content => {
        content.style.display = 'none';
      });
      
      // 激活当前标签页
      this.classList.add('active');
      this.style.color = '#3b82f6';
      this.style.borderBottomColor = '#3b82f6';
      
      document.getElementById(targetTab).style.display = 'block';
      
      // 如果切换到联赛管理标签页，加载联赛列表
      if (targetTab === 'league-manage') {
        renderLeaguesList();
        initLeagueSearch();
      }
    });
  });
}

// 初始化
document.addEventListener('DOMContentLoaded', async () => {
  // 初始化标签页
  initTabs();
  
  // 绑定事件
  $('#addMatchBtn').addEventListener('click', addMatchInput);
  $('#saveMultiBet').addEventListener('click', saveMultiBet);
  $('#clearForm').addEventListener('click', clearForm);
  $('#totalStake').addEventListener('input', () => {
    updateTotalOdds();
    updateSaveButton();
  });
  $('#categorySelect').addEventListener('change', updateSaveButton);
  
  $('#searchGroups').addEventListener('input', renderMultiBetList);
  
  // 筛选按钮事件
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // 移除所有按钮的激活状态
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      // 激活当前按钮
      this.classList.add('active');
      // 重新渲染列表
      renderMultiBetList();
    });
  });

  // 使用setTimeout确保DOM完全加载
    setTimeout(() => {
      const formToggleBtn = $('#formIndentToggle');
      if (formToggleBtn) {
        formToggleBtn.addEventListener('click', function(e) {
          e.preventDefault();
          toggleFormCollapse();
        });
      }
    }, 100);
  
  // 分类管理事件
  $('#addCategoryBtn').addEventListener('click', addCategory);
  
  // 联赛管理事件
  $('#addLeagueBtn').addEventListener('click', addLeague);
  
  // 添加第一个比赛输入
  addMatchInput();
  
  // 初始化保存按钮状态
  updateSaveButton();
  
  // 初始化加载数据
    await loadCategories();
    await loadLeagues();
    await renderCategoryNav();
    await renderCategoriesList();
    await loadData();
});
</script>

</body>
</html>