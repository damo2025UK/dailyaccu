<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš½ å¤šé‡å½©è®°å½•ç°¿</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
/* åŸºç¡€æ ·å¼ */
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fafc;color:#334155;line-height:1.5}
.wrap{width:100%;margin:0;padding:12px}
.row{display:flex;gap:8px;align-items:stretch}
.col{display:flex;flex-direction:column;gap:8px}
.card{background:white;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.small{font-size:13px}
.muted{color:#64748b}

/* å¯¼èˆªæ  */
.navbar{position:sticky;top:0;z-index:10;background:#0f172a;color:#e5e7eb;border-bottom:1px solid rgba(255,255,255,.08);padding:8px 14px;margin-bottom:12px}
.navbar h1{font-size:24px;font-weight:700;color:#f1f5f9;margin:0}
.iconbar{display:flex;gap:10px;align-items:center}
.icon-btn{background:transparent;border:none;padding:4px;color:#e5e7eb;font-size:18px;cursor:pointer;transition:all 0.2s}
.icon-btn:hover{filter:brightness(1.2)}
.icon-btn.active{background:rgba(96,165,250,.18);border-color:#60a5fa;color:#fff}

/* æŒ‰é’®æ ·å¼ */
.btn{background:#3b82f6;color:white;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:14px;transition:all 0.2s}
.btn:hover{background:#2563eb}
.btn.sec{background:#f1f5f9;color:#475569;border:1px solid #e2e8f0}
.btn.sec:hover{background:#e2e8f0}
.btn.warn{background:#ef4444;color:white}
.btn.warn:hover{background:#dc2626}
.btn:disabled{opacity:0.5;cursor:not-allowed}

/* è¡¨å•å…ƒç´  */
input,select,textarea{border:1px solid #d1d5db;border-radius:6px;padding:8px 12px;font-size:14px;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:12px;font-weight:500;color:#374151}

/* å¤šé‡å½©ä¸“ç”¨å¸ƒå±€ */
.multi-bet-layout{display:grid;grid-template-columns:60% 1fr;gap:16px;min-height:calc(100vh - 120px)}
.left-panel{display:flex;flex-direction:column;gap:12px}
.right-panel{display:flex;flex-direction:column;gap:12px}

/* èµ›äº‹åˆ—è¡¨æ ·å¼ */
.match-list{max-height:600px;overflow-y:auto}
.match-item{border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
.match-item:hover{border-color:#3b82f6;background:#f8fafc}
.match-item.selected{border-color:#3b82f6;background:#eff6ff}
.match-item .match-header{font-weight:600;color:#1e293b;margin-bottom:4px}
.match-item .match-details{font-size:12px;color:#64748b}

/* å¤šé‡å½©ç»„æ ·å¼ */
.multi-bet-group{border:2px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px}
.multi-bet-group.win{border-color:#10b981;background:rgba(16,185,129,0.05)}
.multi-bet-group.loss{border-color:#ef4444;background:rgba(239,68,68,0.05)}
.multi-bet-group.pending{border-color:#f59e0b;background:rgba(245,158,11,0.05)}

.group-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.group-title{font-weight:600;color:#1e293b}
.group-stats{font-size:12px;color:#64748b}
.group-odds{font-weight:700;color:#3b82f6}

.match-in-group{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:4px;margin-bottom:4px;background:#f8fafc}
.match-in-group.win{background:rgba(16,185,129,0.1)}
.match-in-group.loss{background:rgba(239,68,68,0.1)}

/* ç»Ÿè®¡è¡¨æ ¼ */
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
th,td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);text-align:left}
thead th{position:sticky;top:0;background:#f1f5f9;z-index:1;cursor:pointer}
tbody tr:hover{background:#f8fafc}
.right{text-align:right}

/* ç»“æœæ ‡ç­¾ */
.result-tag{padding:2px 8px;border-radius:12px;font-size:11px;font-weight:500}
.result-win{background:#dcfce7;color:#166534}
.result-loss{background:#fee2e2;color:#991b1b}
.result-pending{background:#fef3c7;color:#000000}

/* KPIæ ·å¼ */
.kpi{display:flex;flex-direction:column;align-items:center;gap:2px}
.k-label{font-size:11px;color:#ffffff;text-transform:uppercase;letter-spacing:0.5px}
.k-val{font-size:16px;font-weight:700;color:#ffffff}
.pos{color:#16a34a}
.neg{color:#b91c1c}

/* ç­›é€‰æŒ‰é’®æ ·å¼ */
.filter-btn{
  padding:6px 12px;
  font-size:12px;
  border:1px solid #d1d5db;
  border-radius:4px;
  background:#fff;
  color:#374151;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
}
.filter-btn:hover{
  background:#f3f4f6;
  border-color:#9ca3af;
}
.filter-btn.active{
  background:#3b82f6;
  color:#fff;
  border-color:#3b82f6;
}

/* å°æŒ‰é’®æ ·å¼ */
.btn-small{
  padding:4px 8px;
  font-size:12px;
  border:1px solid #d1d5db;
  border-radius:4px;
  background:#fff;
  color:#374151;
  cursor:pointer;
  transition:all 0.2s;
}
.btn-small:hover{
  background:#f9fafb;
  border-color:#9ca3af;
}
.btn-small.sec{
  background:#f3f4f6;
  color:#6b7280;
}
.btn-small.sec:hover{
  background:#e5e7eb;
}

/* åˆ†ç±»å¯¼èˆªæ ·å¼ */
#categoryNav {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 15px;
}

.category-nav-link {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 20px;
  text-decoration: none;
  color: #495057;
  font-size: 13px;
  transition: all 0.2s ease;
}

.category-nav-link:hover {
  background: #e9ecef;
  text-decoration: none;
  color: #495057;
}

.category-nav-link.active {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

.category-nav-link .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}



/* å½•å…¥è¡¨å•æŠ˜å æ ·å¼ */
.form-collapsed .tab-nav,
.form-collapsed .tab-content {
  display: none !important;
}

.form-collapsed {
  transition: all 0.3s ease;
}



.category-nav-link.active .dot {
  background: white !important;
}

/* å¤šé‡å½©è¡¨æ ¼æ ·å¼ */
.multi-bet-table{width:100%;border-collapse:collapse;font-size:12px;background:white}
.multi-bet-table th,.multi-bet-table td{padding:6px 8px;border:1px solid #e2e8f0;text-align:left;vertical-align:middle}
.multi-bet-table th{background:#f8fafc;font-weight:600;color:#374151;position:sticky;top:0;z-index:10;font-size:11px;text-align:center}
.multi-bet-table tbody tr:hover{background:#f1f5f9}
.multi-bet-table .group-row{background:#f1f5f9;font-weight:600}
.multi-bet-table .match-row{background:white}
.multi-bet-table .result-cell{text-align:center}
.multi-bet-table .odds-cell{text-align:right;font-weight:600}
.multi-bet-table .stake-cell{text-align:right}
.multi-bet-table .result-win{background:rgba(34,197,94,0.05)}
.multi-bet-table .result-loss{background:rgba(239,68,68,0.05)}
.multi-bet-table .result-pending{background:rgba(148,163,184,0.05)}

/* ç»“æœè®¾å®šæŒ‰é’® */
.result-btn{padding:2px 6px;font-size:11px;border:1px solid #d1d5db;border-radius:3px;background:white;cursor:pointer;margin:0 1px;transition:all 0.2s;min-width:28px;font-family:inherit}
.result-btn:hover{opacity:0.8;transform:translateY(-1px)}
.result-btn.win{background:#dcfce7;color:#166534;border-color:#16a34a}
.result-btn.loss{background:#fee2e2;color:#991b1b;border-color:#dc2626}
.result-btn.pending{background:#fef3c7;color:#92400e;border-color:#f59e0b}
.tab-btn{transition:all 0.2s ease}
.tab-btn:hover{color:#3b82f6 !important;background:#f1f5f9}
.tab-btn.active:hover{background:transparent}
.result-buttons{white-space:nowrap}
.category-tag{white-space:nowrap}

/* å“åº”å¼è®¾è®¡ */
@media(max-width:1200px){
  .multi-bet-layout{grid-template-columns:55% 1fr}
}
@media(max-width:1000px){
  .multi-bet-layout{grid-template-columns:1fr;grid-template-rows:auto 1fr}
  .left-panel{max-height:400px}
}
</style>
</head>
<body>

<!-- å¯¼èˆªæ  -->
<div class="navbar">
  <div class="wrap">
    <div class="row" style="align-items:center;gap:12px">
      <h1>âš½ å¤šé‡å½©è®°å½•ç°¿</h1>
      <div class="iconbar">
        <button class="icon-btn" title="å•åœºå½©" onclick="window.location.href='index.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        </button>
        <button class="icon-btn active" title="å¤šé‡å½©">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M9 9h6v6H9z"/><path d="M9 3v6"/><path d="M21 9h-6"/><path d="M15 21v-6"/><path d="M3 15h6"/></svg>
        </button>
        <button class="icon-btn" title="é¢„æµ‹æ¥æºè®°å½•éªŒè¯" onclick="window.location.href='prediction-tracker.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4"/><path d="M20 16V7a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v1"/><path d="M15 2v5"/><path d="M9 2v5"/><path d="M3 9h18"/><circle cx="16" cy="16" r="2"/><path d="m21 21-1.5-1.5"/></svg>
        </button>
        <div style="width:1px;height:20px;background:#e2e8f0;margin:0 4px"></div>
        <button id="exportMultiBet" class="icon-btn" title="å¯¼å‡ºå¤šé‡å½©æ•°æ®">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="m8 11 4 4 4-4"/><path d="M21 21H3"/></svg>
        </button>
        <button id="clearAllMultiBet" class="icon-btn" title="æ¸…ç©ºæ‰€æœ‰å¤šé‡å½©">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
      

      
      <!-- KPIæŒ‡æ ‡ -->
      <div style="margin-left:auto;display:flex;gap:16px;align-items:center">
        <div class="kpi"><div class="k-label">å¤šé‡å½©æ€»æ•°</div><div class="k-val" id="k_total_groups">0</div></div>
        <div class="kpi"><div class="k-label">å·²ç»“ç®—</div><div class="k-val" id="k_settled_groups">0</div></div>
        <div class="kpi"><div class="k-label">èƒœç‡</div><div class="k-val" id="k_win_rate">0%</div></div>
        <div class="kpi"><div class="k-label">æ€»æŠ•å…¥</div><div class="k-val" id="k_total_stake">0</div></div>
        <div class="kpi"><div class="k-label">æ€»è¿”è¿˜</div><div class="k-val" id="k_total_return">0</div></div>
        <div class="kpi"><div class="k-label">å‡€æ”¶ç›Š</div><div class="k-val" id="k_net_profit">0</div></div>
        <div class="kpi"><div class="k-label">ROI</div><div class="k-val" id="k_roi">0%</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
<div class="wrap">
  <div class="multi-bet-layout">
    
    <!-- å·¦ä¾§é¢æ¿ï¼šå¤šé‡å½©è¡¨æ ¼ -->
    <div class="left-panel">
      <!-- åˆ†ç±»ç­›é€‰ -->
      <div class="card" style="margin-bottom:12px">
        <h4 style="margin:0 0 8px;color:#334155">ğŸ·ï¸ æŒ‰åˆ†ç±»ç­›é€‰</h4>
        <div id="categoryNav" class="category-nav" style="display:flex;flex-wrap:wrap;gap:6px">
          <!-- åˆ†ç±»å¯¼èˆªå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      
      <div class="card">
        <h3 style="margin:0 0 12px;color:#334155">ğŸ“‹ å¤šé‡å½©åˆ—è¡¨</h3>
        <div class="row" style="margin-bottom:12px;gap:8px">
          <input id="searchGroups" placeholder="æœç´¢å¤šé‡å½©..." style="width:200px">
          <button id="filterAll" class="filter-btn active" data-status="all">å…¨éƒ¨</button>
          <button id="filterPending" class="filter-btn" data-status="pending">å¾…å®š</button>
          <button id="filterWin" class="filter-btn" data-status="win">å·²èµ¢</button>
          <button id="filterLoss" class="filter-btn" data-status="loss">å·²è¾“</button>
        </div>
        <div>
          <table class="multi-bet-table" id="multiBetTable">
            <thead>
              <tr>
                <th style="width:80px">æ—¥æœŸ</th>
                <th style="width:100px">è”èµ›</th>
                <th style="width:150px">æ¯”èµ›</th>
                <th style="width:100px">æŠ•æ³¨å†…å®¹</th>
                <th style="width:60px">èµ”ç‡</th>
                <th style="width:80px">ç»“æœ</th>
                <th style="width:100px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="multiBetList">
              <!-- å¤šé‡å½©è¡¨æ ¼å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
          <!-- æ€»ç»“ä¿¡æ¯å®¹å™¨ -->
          <div id="multiBetSummary"></div>
        </div>
      </div>
    </div>
    
    <!-- å³ä¾§é¢æ¿ï¼šæ•°æ®å½•å…¥å’Œç»Ÿè®¡ -->
    <div class="right-panel">
      
      <!-- å¤šé‡å½©ç®¡ç†é¢æ¿ -->
      <div class="card">
        <div class="row" style="align-items:center;margin-bottom:16px">
          <h3 style="margin:0;color:#334155">ğŸ“ å¤šé‡å½©ç®¡ç†</h3>
          <button id="formIndentToggle" class="btn-small" style="margin-left:auto">ğŸ“ æŠ˜å </button>
        </div>
        
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tab-nav" style="display:flex;border-bottom:1px solid #e2e8f0;margin-bottom:16px">
          <button class="tab-btn active" data-tab="new-multibet" style="padding:8px 16px;border:none;background:none;color:#3b82f6;border-bottom:2px solid #3b82f6;cursor:pointer;font-weight:500">æ–°å»ºå¤šé‡å½©</button>
          <button class="tab-btn" data-tab="category-manage" style="padding:8px 16px;border:none;background:none;color:#64748b;border-bottom:2px solid transparent;cursor:pointer;font-weight:500">åˆ†ç±»ç®¡ç†</button>
          <button class="tab-btn" data-tab="league-manage" style="padding:8px 16px;border:none;background:none;color:#64748b;border-bottom:2px solid transparent;cursor:pointer;font-weight:500">è”èµ›ç®¡ç†</button>
        </div>
        
        <!-- æ–°å»ºå¤šé‡å½©æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="new-multibet" style="display:block">
          <!-- å¤šé‡å½©åŸºæœ¬ä¿¡æ¯ -->
          <div class="row" style="margin-bottom:12px">
            <div class="field" style="flex:1">
              <label>åˆ†ç±» <span style="color:#ef4444">*</span></label>
              <select id="categorySelect" required>
                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
              </select>
            </div>
            <div class="field" style="flex:2">
              <label>å¤šé‡å½©åç§°ï¼ˆå¯é€‰ï¼‰</label>
              <input id="groupName" placeholder="å¦‚ï¼šå‘¨æœ«ç²¾é€‰ä¸‰ä¸²ä¸€">
            </div>
            <div class="field" style="flex:1">
              <label>æ€»æŠ•æ³¨é‡‘é¢</label>
              <input id="totalStake" type="number" step="0.01" placeholder="100.00">
            </div>
          </div>
          
          <!-- æ¯”èµ›å½•å…¥åŒºåŸŸ -->
          <div style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:12px">
            <div class="row" style="align-items:center;margin-bottom:8px">
              <h4 style="margin:0;color:#475569">æ·»åŠ æ¯”èµ›</h4>
              <button id="addMatchBtn" class="btn" style="margin-left:auto">+ æ·»åŠ æ¯”èµ›</button>
            </div>
            
            <div id="matchInputs">
              <!-- æ¯”èµ›è¾“å…¥è¡¨å•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="row" style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0">
              <div class="field" style="flex:1">
                <label>æ€»èµ”ç‡</label>
                <input id="totalOdds" type="number" step="0.0001" readonly style="background:#f8fafc">
              </div>
              <div class="field" style="flex:1">
                <label>é¢„æœŸè¿”è¿˜</label>
                <input id="expectedReturn" type="number" step="0.01" readonly style="background:#f8fafc">
              </div>
            </div>
          </div>
          
          <div class="row">
            <button id="saveMultiBet" class="btn" disabled>ä¿å­˜å¤šé‡å½©</button>
            <button id="clearForm" class="btn sec">æ¸…ç©ºè¡¨å•</button>
          </div>
        </div>
        
        <!-- åˆ†ç±»ç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="category-manage" style="display:none">
          <!-- æ·»åŠ æ–°åˆ†ç±» -->
          <div style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:12px">
            <h4 style="margin:0 0 8px;color:#475569">æ·»åŠ æ–°åˆ†ç±»</h4>
            <div class="row" style="margin-bottom:8px">
              <div class="field" style="flex:2">
                <label>åˆ†ç±»åç§°</label>
                <input id="newCategoryName" placeholder="å¦‚ï¼šè¶³çƒ">
              </div>
              <div class="field" style="flex:1">
                <label>é¢œè‰²</label>
                <input id="newCategoryColor" type="color" value="#3b82f6">
              </div>
            </div>
            <div class="field" style="margin-bottom:8px">
              <label>æè¿°ï¼ˆå¯é€‰ï¼‰</label>
              <input id="newCategoryDescription" placeholder="å¦‚ï¼šè¶³çƒç›¸å…³çš„å¤šé‡å½©æŠ•æ³¨">
            </div>
            <button id="addCategoryBtn" class="btn">æ·»åŠ åˆ†ç±»</button>
          </div>
          
          <!-- ç°æœ‰åˆ†ç±»åˆ—è¡¨ -->
          <div>
            <h4 style="margin:0 0 8px;color:#475569">ç°æœ‰åˆ†ç±»</h4>
            <div id="categoriesList">
              <!-- åˆ†ç±»åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
        
        <!-- è”èµ›ç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="league-manage" style="display:none">
          <!-- æ·»åŠ æ–°è”èµ› -->
          <div style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:12px">
            <h4 style="margin:0 0 8px;color:#475569">æ·»åŠ æ–°è”èµ›</h4>
            <div class="row" style="margin-bottom:8px">
              <div class="field" style="flex:2">
                <label>è”èµ›åç§°</label>
                <input id="newLeagueName" placeholder="å¦‚ï¼šè‹±è¶…">
              </div>
              <div class="field" style="flex:1">
                <label>å›½å®¶/åœ°åŒº</label>
                <input id="newLeagueCountry" placeholder="å¦‚ï¼šè‹±æ ¼å…°">
              </div>
            </div>
            <div class="field" style="margin-bottom:8px">
              <label>æè¿°ï¼ˆå¯é€‰ï¼‰</label>
              <input id="newLeagueDescription" placeholder="å¦‚ï¼šè‹±æ ¼å…°è¶³çƒè¶…çº§è”èµ›">
            </div>
            <button id="addLeagueBtn" class="btn">æ·»åŠ è”èµ›</button>
          </div>
          
          <!-- ç°æœ‰è”èµ›åˆ—è¡¨ -->
          <div>
            <h4 style="margin:0 0 8px;color:#475569">ç°æœ‰è”èµ›</h4>
            <div style="margin-bottom:8px">
              <input id="searchLeagues" placeholder="æœç´¢è”èµ›..." style="width:100%">
            </div>
            <div id="leaguesList" style="max-height:300px;overflow-y:auto">
              <!-- è”èµ›åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- ç»Ÿè®¡æŠ¥è¡¨ -->
      <div class="card">
        <h3 style="margin:0 0 12px;color:#334155">ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨</h3>
        
        <!-- ä¸»ç»Ÿè®¡åŒº -->
        <div style="margin-bottom:16px">
          <h4 style="margin:0 0 8px;color:#475569">å¤šé‡å½©æ•´ä½“ç»Ÿè®¡</h4>
          <table class="small">
            <thead>
              <tr>
                <th>çŠ¶æ€</th>
                <th class="right">æ•°é‡</th>
                <th class="right">æŠ•å…¥é‡‘é¢</th>
                <th class="right">è¿”è¿˜é‡‘é¢</th>
                <th class="right">å‡€æ”¶ç›Š</th>
                <th class="right">èƒœç‡</th>
              </tr>
            </thead>
            <tbody id="overallStatsBody">
              <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
        
        <!-- æŒ‰è”èµ›ç»Ÿè®¡ -->
        <div style="margin-bottom:16px">
          <h4 style="margin:0 0 8px;color:#475569">æŒ‰è”èµ›ç»Ÿè®¡ï¼ˆåŸºäºå•åœºæ¯”èµ›ï¼‰</h4>
          <table class="small">
            <thead>
              <tr>
                <th>è”èµ›</th>
                <th class="right">å‚ä¸æ¬¡æ•°</th>
                <th class="right">èƒœåœº</th>
                <th class="right">è´Ÿåœº</th>
                <th class="right">èƒœç‡</th>
              </tr>
            </thead>
            <tbody id="leagueStatsBody">
              <!-- è”èµ›ç»Ÿè®¡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
        
        <!-- æŒ‰å†…å®¹ç»Ÿè®¡ -->
        <div>
          <h4 style="margin:0 0 8px;color:#475569">æŒ‰å†…å®¹ç»Ÿè®¡ï¼ˆåŸºäºå•åœºæ¯”èµ›ï¼‰</h4>
          <table class="small">
            <thead>
              <tr>
                <th>æŠ•æ³¨å†…å®¹</th>
                <th class="right">å‚ä¸æ¬¡æ•°</th>
                <th class="right">èƒœåœº</th>
                <th class="right">è´Ÿåœº</th>
                <th class="right">èƒœç‡</th>
              </tr>
            </thead>
            <tbody id="contentStatsBody">
              <!-- å†…å®¹ç»Ÿè®¡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å…¨å±€åŠ è½½æŒ‡ç¤ºå™¨ -->
<div id="loadingIndicator" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:8px;z-index:1000;display:none;text-align:center">
  <div style="margin-bottom:10px">æ•°æ®å¤„ç†ä¸­...</div>
  <div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
// Supabase é…ç½®
const SUPABASE_URL = 'https://hutlxrvwqrmidragxmtx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1dGx4cnZ3cXJtaWRyYWd4bXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMjk3ODMsImV4cCI6MjA3MTYwNTc4M30.KhDGniZHLEnmYJQWugq-U0o6EyZwmCPiXNbat_8Tyg4';

// åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
let supabase;
try {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
} catch (error) {
  console.error('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
  alert('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
}

// å…¨å±€å˜é‡
let multiBetGroups = [];
let currentMatches = [];
let profileKey = 'default'; // å¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•å¤šç”¨æˆ·æ”¯æŒ
let isFormCollapsed = false; // å½•å…¥è¡¨å•æŠ˜å çŠ¶æ€

// å·¥å…·å‡½æ•°
function $(selector) {
  return document.querySelector(selector);
}

function showLoading() {
  $('#loadingIndicator').style.display = 'block';
}

function hideLoading() {
  $('#loadingIndicator').style.display = 'none';
}



// åˆ‡æ¢å½•å…¥è¡¨å•æŠ˜å åŠŸèƒ½
function toggleFormCollapse() {
  isFormCollapsed = !isFormCollapsed;
  const managementPanel = $('#formIndentToggle').closest('.card');
  const formCollapseToggle = $('#formIndentToggle');
  
  if (isFormCollapsed) {
    managementPanel.classList.add('form-collapsed');
    formCollapseToggle.textContent = 'ğŸ“‚ å±•å¼€';
    formCollapseToggle.style.backgroundColor = '#10b981';
    formCollapseToggle.style.color = 'white';
  } else {
    managementPanel.classList.remove('form-collapsed');
    formCollapseToggle.textContent = 'ğŸ“ æŠ˜å ';
    formCollapseToggle.style.backgroundColor = '';
    formCollapseToggle.style.color = '';
  }
}

// æ•°æ®åº“æ“ä½œ
const multiBetDB = {
  // è·å–æ‰€æœ‰åˆ†ç±»
  async getAllCategories() {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { data, error } = await supabase
      .from('multi_bet_categories')
      .select('*')
      .eq('profile_key', profileKey)
      .order('name');
    
    if (error) throw error;
    return data || [];
  },
  
  // åˆ›å»ºæ–°åˆ†ç±»
  async createCategory(categoryData) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { data, error } = await supabase
      .from('multi_bet_categories')
      .insert({
        profile_key: profileKey,
        name: categoryData.name,
        description: categoryData.description,
        color: categoryData.color || '#3b82f6'
      })
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },
  
  // æ›´æ–°åˆ†ç±»
  async updateCategory(categoryId, categoryData) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { data, error } = await supabase
      .from('multi_bet_categories')
      .update({
        name: categoryData.name,
        description: categoryData.description,
        color: categoryData.color
      })
      .eq('id', categoryId)
      .eq('profile_key', profileKey)
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },
  
  // åˆ é™¤åˆ†ç±»
  async deleteCategory(categoryId) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å¤šé‡å½©ä½¿ç”¨æ­¤åˆ†ç±»
    const { data: groups, error: checkError } = await supabase
      .from('multi_bet_groups')
      .select('id')
      .eq('category_id', categoryId)
      .eq('profile_key', profileKey)
      .limit(1);
    
    if (checkError) throw checkError;
    if (groups && groups.length > 0) {
      throw new Error('æ— æ³•åˆ é™¤ï¼šè¯¥åˆ†ç±»ä¸‹è¿˜æœ‰å¤šé‡å½©è®°å½•');
    }
    
    const { error } = await supabase
      .from('multi_bet_categories')
      .delete()
      .eq('id', categoryId)
      .eq('profile_key', profileKey);
    
    if (error) throw error;
  },

  // è·å–æ‰€æœ‰è”èµ›
  async getAllLeagues() {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { data, error } = await supabase
      .from('leagues')
      .select('*')
      .eq('profile_key', profileKey)
      .order('name');
    
    if (error) throw error;
    return data || [];
  },

  // åˆ›å»ºæ–°è”èµ›
  async createLeague(leagueData) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { data, error } = await supabase
      .from('leagues')
      .insert({
        profile_key: profileKey,
        name: leagueData.name,
        country: leagueData.country,
        description: leagueData.description
      })
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },

  // æ›´æ–°è”èµ›
  async updateLeague(leagueId, leagueData) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { data, error } = await supabase
      .from('leagues')
      .update({
        name: leagueData.name,
        country: leagueData.country,
        description: leagueData.description
      })
      .eq('id', leagueId)
      .eq('profile_key', profileKey)
      .select()
      .single();
    
    if (error) throw error;
    return data;
  },

  // åˆ é™¤è”èµ›
  async deleteLeague(leagueId) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { error } = await supabase
      .from('leagues')
      .delete()
      .eq('id', leagueId)
      .eq('profile_key', profileKey);
    
    if (error) throw error;
  },

  // è·å–æ‰€æœ‰å¤šé‡å½©ç»„
  async getAllGroups() {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { data, error } = await supabase
      .from('multi_bet_groups')
      .select(`
        *,
        multi_bet_categories(name, color),
        multi_bet_matches(*)
      `)
      .eq('profile_key', profileKey)
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    return data || [];
  },
  
  // åˆ›å»ºæ–°çš„å¤šé‡å½©ç»„
  async createGroup(groupData, matches) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    // è®¡ç®—æ€»èµ”ç‡
    const totalOdds = matches.reduce((acc, match) => acc * match.odds, 1);
    
    // åˆ›å»ºå¤šé‡å½©ç»„
    const { data: group, error: groupError } = await supabase
      .from('multi_bet_groups')
      .insert({
        profile_key: profileKey,
        category_id: groupData.categoryId,
        group_name: groupData.name,
        total_odds: totalOdds,
        total_stake: groupData.stake,
        match_count: matches.length
      })
      .select()
      .single();
    
    if (groupError) throw groupError;
    
    // æ·»åŠ æ¯”èµ›è®°å½•
    const matchesWithGroupId = matches.map((match, index) => ({
      group_id: group.id,
      date: match.date,
      league: match.league,
      match: match.match,
      description: match.description,
      odds: match.odds,
      match_order: index + 1
    }));
    
    const { error: matchesError } = await supabase
      .from('multi_bet_matches')
      .insert(matchesWithGroupId);
    
    if (matchesError) throw matchesError;
    
    return group;
  },
  
  // æ›´æ–°æ¯”èµ›ç»“æœ
  async updateMatchResult(matchId, result) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    // æ›´æ–°å•åœºæ¯”èµ›ç»“æœ
    const { error } = await supabase
      .from('multi_bet_matches')
      .update({ result })
      .eq('id', matchId);
    
    if (error) throw error;
    
    // è·å–è¯¥æ¯”èµ›æ‰€å±çš„å¤šé‡å½©ç»„ID
    const { data: matchData, error: matchError } = await supabase
      .from('multi_bet_matches')
      .select('group_id')
      .eq('id', matchId)
      .single();
    
    if (matchError) throw matchError;
    
    // è·å–è¯¥ç»„æ‰€æœ‰æ¯”èµ›çš„ç»“æœ
    const { data: matches, error: matchesError } = await supabase
      .from('multi_bet_matches')
      .select('result')
      .eq('group_id', matchData.group_id);
    
    if (matchesError) throw matchesError;
    
    // è®¡ç®—æ•´ä¸ªå¤šé‡å½©ç»„çš„ç»“æœ
    let groupResult = 'pending';
    const results = matches.map(m => m.result);
    
    if (results.includes('loss')) {
      // æœ‰ä»»ä½•ä¸€åœºè¾“ï¼Œæ•´ä¸ªå¤šé‡å½©å°±æ˜¯è¾“
      groupResult = 'loss';
    } else if (results.every(r => r === 'win')) {
      // æ‰€æœ‰åœºæ¬¡éƒ½èµ¢ï¼Œæ•´ä¸ªå¤šé‡å½©æ‰ç®—èµ¢
      groupResult = 'win';
    } else {
      // æœ‰å¾…å®šåœºæ¬¡ï¼Œæ•´ä¸ªå¤šé‡å½©ä¸ºå¾…å®š
      groupResult = 'pending';
    }
    
    // æ›´æ–°å¤šé‡å½©ç»„çš„ç»“æœ
    const { error: groupError } = await supabase
      .from('multi_bet_groups')
      .update({ result: groupResult })
      .eq('id', matchData.group_id);
    
    if (groupError) throw groupError;
  },
  
  // åˆ é™¤å¤šé‡å½©ç»„
  async deleteGroup(groupId) {
    if (!supabase) throw new Error('Supabase æœªåˆå§‹åŒ–');
    
    const { error } = await supabase
      .from('multi_bet_groups')
      .delete()
      .eq('id', groupId);
    
    if (error) throw error;
  }
};

// UI æ¸²æŸ“å‡½æ•°
function renderMultiBetList() {
  const container = $('#multiBetList');
  const summaryContainer = $('#multiBetSummary');
  const searchTerm = $('#searchGroups').value.toLowerCase();
  const activeFilterBtn = document.querySelector('.filter-btn.active');
  const statusFilter = activeFilterBtn ? activeFilterBtn.dataset.status : 'all';
  const categoryFilter = window.currentCategoryFilter;
  
  let filteredGroups = multiBetGroups;
  
  // åº”ç”¨æœç´¢è¿‡æ»¤
  if (searchTerm) {
    filteredGroups = filteredGroups.filter(group => 
      (group.group_name || '').toLowerCase().includes(searchTerm) ||
      group.multi_bet_matches.some(match => 
        (match.league || '').toLowerCase().includes(searchTerm) ||
        (match.match || '').toLowerCase().includes(searchTerm) ||
        (match.description || '').toLowerCase().includes(searchTerm)
      )
    );
  }
  
  // åº”ç”¨çŠ¶æ€è¿‡æ»¤
  if (statusFilter !== 'all') {
    filteredGroups = filteredGroups.filter(group => group.result === statusFilter);
  }
  
  // åº”ç”¨åˆ†ç±»è¿‡æ»¤
  if (categoryFilter) {
    filteredGroups = filteredGroups.filter(group => group.category_id == categoryFilter);
  }
  
  if (filteredGroups.length === 0) {
    container.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#64748b">æš‚æ— å¤šé‡å½©è®°å½•</td></tr>';
    summaryContainer.innerHTML = '';
    return;
  }
  
  // ç”Ÿæˆåˆ†ç»„æ˜¾ç¤ºçš„å†…å®¹
  let allContent = [];
  
  // æŒ‰åˆ†ç±»å¯¹å¤šé‡å½©ç»„è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ä¸ºæ¯ä¸ªåˆ†ç±»å†…çš„ç»„åˆ†é…åºå·
  const groupsByCategory = {};
  filteredGroups.forEach(group => {
    const categoryId = group.category_id || 'uncategorized';
    if (!groupsByCategory[categoryId]) {
      groupsByCategory[categoryId] = [];
    }
    groupsByCategory[categoryId].push(group);
  });
  
  // ä¸ºæ¯ä¸ªåˆ†ç±»å†…çš„ç»„åˆ†é…åºå·å¹¶æ¸²æŸ“
  Object.values(groupsByCategory).forEach(categoryGroups => {
    categoryGroups.forEach((group, indexInCategory) => {
      const matches = group.multi_bet_matches || [];
      const categoryName = group.multi_bet_categories?.name || 'æœªåˆ†ç±»';
      const categoryColor = group.multi_bet_categories?.color || '#6b7280';
      const groupNumber = indexInCategory + 1; // ä»1å¼€å§‹ç¼–å·
      const groupName = group.group_name || `å¤šé‡å½© #${groupNumber}`;
    
    // æ ¹æ®ç»“æœè®¾ç½®èƒŒæ™¯é¢œè‰²
    const resultBgColor = group.result === 'win' ? '#dcfce7' : 
                         group.result === 'loss' ? '#fee2e2' : '#f1f5f9';
    const resultTextColor = group.result === 'win' ? '#166534' : 
                           group.result === 'loss' ? '#991b1b' : '#475569';
    
    // ç”Ÿæˆç»„æ ‡é¢˜ï¼ˆåˆå¹¶æ ‡é¢˜å’Œæ“ä½œåŒºåŸŸï¼‰
    const groupHeader = `
      <div style="background:${resultBgColor};color:${resultTextColor};padding:8px 12px;margin:16px 0 0 0;border-radius:4px;font-size:14px;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-left:4px solid ${categoryColor}">
        <span>
          <span class="category-tag" style="background:${categoryColor};color:white;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;margin-right:8px">
            ${categoryName}
          </span>
          <span style="margin-right:12px;font-weight:700">${groupName}</span>
          <span style="font-size:12px;opacity:0.8">${matches.length}åœºæ¯”èµ›</span>
        </span>
        <span style="display:flex;align-items:center;gap:16px">
          <span style="font-size:14px;font-weight:600;color:${resultTextColor}">
             èµ”ç‡ <span style="color:#1f2937;font-size:18px;font-weight:700">${group.total_odds.toFixed(2)}</span>
           </span>
           <span style="font-size:14px;font-weight:600">
             æœ¬é‡‘ Â¥${group.total_stake.toFixed(2)}
           </span>
           <span style="font-size:14px;font-weight:600">
             ${group.result === 'win' ? 
               'åˆ©æ¶¦ <span style="color:#16a34a;font-size:18px;font-weight:700">+Â¥' + ((group.total_odds * group.total_stake) - group.total_stake).toFixed(2) + '</span>' : 
               group.result === 'loss' ? 
               'äºæŸ <span style="color:#dc2626;font-size:18px;font-weight:700">-Â¥' + group.total_stake.toFixed(2) + '</span>' : 
               '<span style="color:#64748b">å¾…å®š</span>'}
           </span>
          <span class="result-tag" style="font-size:14px;padding:4px 12px;border-radius:6px;font-weight:700;background:${group.result === 'win' ? '#16a34a' : group.result === 'loss' ? '#dc2626' : '#64748b'};color:white">
            ${(group.result || 'pending') === 'win' ? 'âœ“ èµ¢' : (group.result || 'pending') === 'loss' ? 'âœ— è¾“' : 'â³ å¾…å®š'}
          </span>
          <button class="btn" style="padding:6px 12px;font-size:12px;background:#6b7280;border:1px solid #4b5563;color:white;border-radius:4px;cursor:pointer;font-weight:600" onclick="deleteMultiBetGroup(${group.id})">åˆ é™¤ç»„</button>
        </span>
      </div>
    `;
    
    // ç”Ÿæˆè¯¥ç»„çš„è¡¨æ ¼
    let groupTableRows = [];
    matches.forEach((match, index) => {
      const groupResultClass = (group.result || 'pending') === 'win' ? 'result-win' : 
                              (group.result || 'pending') === 'loss' ? 'result-loss' : 'result-pending';
      
      let row = '<tr class="' + groupResultClass + '">';
      
      row += `
        <td style="padding:6px;font-size:12px">${match.date || 'æœªçŸ¥'}</td>
        <td style="padding:6px;font-size:12px">${match.league || 'æœªçŸ¥è”èµ›'}</td>
        <td style="padding:6px;font-size:12px" title="${match.match || 'æœªçŸ¥æ¯”èµ›'}">
          ${match.match || 'æœªçŸ¥æ¯”èµ›'}
        </td>
        <td style="padding:6px;font-size:12px">${match.description || 'æœªçŸ¥å†…å®¹'}</td>
        <td style="padding:6px;font-size:12px;font-weight:500">${match.odds ? match.odds.toFixed(3) : '0.000'}</td>
        <td style="padding:6px;text-align:center">
          <span class="result-tag result-${match.result}" style="font-size:10px;padding:2px 6px;border-radius:3px">
            ${match.result === 'win' ? 'âœ“ èµ¢' : match.result === 'loss' ? 'âœ— è¾“' : 'â³ å¾…å®š'}
          </span>
        </td>
        <td style="padding:6px;text-align:center">
          <div class="result-buttons" style="display:flex;gap:2px;justify-content:center">
            <button class="result-btn ${match.result === 'win' ? 'active' : ''}" 
                    style="padding:2px 6px;font-size:10px;border:1px solid #22c55e;background:${match.result === 'win' ? '#22c55e' : 'white'};color:${match.result === 'win' ? 'white' : '#22c55e'};border-radius:3px;cursor:pointer" 
                    onclick="updateMatchResult(${match.id}, 'win')">èµ¢</button>
            <button class="result-btn ${match.result === 'loss' ? 'active' : ''}" 
                    style="padding:2px 6px;font-size:10px;border:1px solid #ef4444;background:${match.result === 'loss' ? '#ef4444' : 'white'};color:${match.result === 'loss' ? 'white' : '#ef4444'};border-radius:3px;cursor:pointer" 
                    onclick="updateMatchResult(${match.id}, 'loss')">è¾“</button>
            <button class="result-btn ${match.result === 'pending' ? 'active' : ''}" 
                    style="padding:2px 6px;font-size:10px;border:1px solid #94a3b8;background:${match.result === 'pending' ? '#94a3b8' : 'white'};color:${match.result === 'pending' ? 'white' : '#94a3b8'};border-radius:3px;cursor:pointer" 
                    onclick="updateMatchResult(${match.id}, 'pending')">å¾…å®š</button>
          </div>
        </td>
      </tr>`;
      
      groupTableRows.push(row);
    });
    
    const groupTable = `
      <table class="multi-bet-table" style="margin:0 0 16px 0;border:1px solid #e2e8f0;border-top:none;border-radius:0 0 4px 4px">
        <tbody>
          ${groupTableRows.join('')}
        </tbody>
      </table>
    `;
    
    // å°†è¯¥ç»„çš„å®Œæ•´å†…å®¹æ·»åŠ åˆ°æ•°ç»„ä¸­
    allContent.push(groupHeader + groupTable);
    });
  });
  
  // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ‰€æœ‰å†…å®¹
  container.innerHTML = '';
  summaryContainer.innerHTML = allContent.join('');
}

function addMatchInput() {
  const container = $('#matchInputs');
  const index = currentMatches.length;
  
  const matchHtml = `
    <div class="match-input" data-index="${index}" style="border:1px solid #e2e8f0;border-radius:4px;padding:8px;margin-bottom:8px">
      <div class="row" style="align-items:center;margin-bottom:8px">
        <span style="font-weight:500;color:#475569">æ¯”èµ› ${index + 1}</span>
        <button type="button" class="btn warn" style="padding:2px 6px;font-size:10px;margin-left:auto" onclick="removeMatchInput(${index})">åˆ é™¤</button>
      </div>
      
      <div class="row" style="margin-bottom:8px">
        <div class="field" style="flex:1">
          <label>æ—¥æœŸ</label>
          <input type="date" data-field="date" data-index="${index}" value="${new Date().toISOString().slice(0,10)}">
        </div>
        <div class="field" style="flex:2">
          <label>è”èµ›</label>
          <div style="position:relative">
            <input type="text" data-field="league" data-index="${index}" placeholder="å¦‚ï¼šè‹±è¶…" list="leagueDatalist" autocomplete="off">
            <datalist id="leagueDatalist">
              <!-- è”èµ›é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </datalist>
          </div>
        </div>
      </div>
      
      <div class="row" style="margin-bottom:8px">
        <div class="field" style="flex:2">
          <label>æ¯”èµ›</label>
          <input type="text" data-field="match" data-index="${index}" placeholder="å¦‚ï¼šæ›¼è” vs åˆ©ç‰©æµ¦">
        </div>
        <div class="field" style="flex:2">
          <label>æŠ•æ³¨å†…å®¹</label>
          <input type="text" data-field="description" data-index="${index}" placeholder="å¦‚ï¼šä¸»èƒœ">
        </div>
        <div class="field" style="flex:1">
          <label>èµ”ç‡</label>
          <input type="number" step="0.001" data-field="odds" data-index="${index}" placeholder="1.850">
        </div>
      </div>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', matchHtml);
  
  // åˆå§‹åŒ–currentMatchesæ•°ç»„ï¼ŒåŒ…å«é»˜è®¤æ—¥æœŸå€¼
  const defaultDate = new Date().toISOString().slice(0,10);
  currentMatches.push({
    date: defaultDate,
    league: '',
    match: '',
    description: '',
    odds: 0
  });
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  const inputs = container.querySelectorAll(`[data-index="${index}"]`);
  inputs.forEach(input => {
    input.addEventListener('input', updateMatchData);
  });
  
  updateTotalOdds();
  updateSaveButton();
}

function removeMatchInput(index) {
  const matchInput = $(`.match-input[data-index="${index}"]`);
  if (matchInput) {
    matchInput.remove();
    currentMatches.splice(index, 1);
    
    // é‡æ–°ç¼–å·
    const remainingInputs = $('#matchInputs').querySelectorAll('.match-input');
    remainingInputs.forEach((input, newIndex) => {
      input.dataset.index = newIndex;
      input.querySelector('span').textContent = `æ¯”èµ› ${newIndex + 1}`;
      
      const inputs = input.querySelectorAll('[data-index]');
      inputs.forEach(inp => {
        inp.dataset.index = newIndex;
      });
      
      const deleteBtn = input.querySelector('button');
      deleteBtn.setAttribute('onclick', `removeMatchInput(${newIndex})`);
    });
    
    updateTotalOdds();
    updateSaveButton();
  }
}

function updateMatchData(event) {
  const index = parseInt(event.target.dataset.index);
  const field = event.target.dataset.field;
  const value = event.target.value;
  
  if (!currentMatches[index]) {
    currentMatches[index] = {};
  }
  
  currentMatches[index][field] = field === 'odds' ? parseFloat(value) || 0 : value;
  
  updateTotalOdds();
  updateSaveButton();
}

function updateTotalOdds() {
  const validOdds = currentMatches
    .map(match => match.odds || 0)
    .filter(odds => odds > 0);
  
  const totalOdds = validOdds.length > 0 ? 
    validOdds.reduce((acc, odds) => acc * odds, 1) : 0;
  
  $('#totalOdds').value = totalOdds.toFixed(4);
  
  const stake = parseFloat($('#totalStake').value) || 0;
  const expectedReturn = totalOdds * stake;
  $('#expectedReturn').value = expectedReturn.toFixed(2);
}

function updateSaveButton() {
  // æ£€æŸ¥æ˜¯å¦æœ‰è‡³å°‘ä¸€ä¸ªæ¯”èµ›è¾“å…¥æ¡†
  const matchInputs = $('#matchInputs').querySelectorAll('.match-input');
  const hasMatchInputs = matchInputs.length > 0;
  
  // æ£€æŸ¥æ‰€æœ‰æ¯”èµ›è¾“å…¥æ¡†æ˜¯å¦éƒ½å¡«å†™å®Œæ•´
  let hasValidMatches = false;
  if (hasMatchInputs) {
    hasValidMatches = Array.from(matchInputs).every(matchInput => {
      const dateInput = matchInput.querySelector('[data-field="date"]');
      const leagueInput = matchInput.querySelector('[data-field="league"]');
      const matchNameInput = matchInput.querySelector('[data-field="match"]');
      const descriptionInput = matchInput.querySelector('[data-field="description"]');
      const oddsInput = matchInput.querySelector('[data-field="odds"]');
      
      return dateInput?.value && 
             leagueInput?.value.trim() && 
             matchNameInput?.value.trim() && 
             descriptionInput?.value.trim() && 
             parseFloat(oddsInput?.value) > 0;
    });
  }
  
  const hasStake = parseFloat($('#totalStake').value) > 0;
  const hasCategory = $('#categorySelect').value !== '';
  
  const saveButton = $('#saveMultiBet');
  if (saveButton) {
    saveButton.disabled = !(hasValidMatches && hasStake && hasCategory);
  }
}

// äº‹ä»¶å¤„ç†å‡½æ•°
async function updateMatchResult(matchId, result) {
  try {
    showLoading();
    await multiBetDB.updateMatchResult(matchId, result);
    await loadData();
  } catch (error) {
    console.error('æ›´æ–°æ¯”èµ›ç»“æœå¤±è´¥:', error);
    alert('æ›´æ–°å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function deleteMultiBetGroup(groupId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤šé‡å½©å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
  
  try {
    showLoading();
    await multiBetDB.deleteGroup(groupId);
    await loadData();
  } catch (error) {
    console.error('åˆ é™¤å¤šé‡å½©å¤±è´¥:', error);
    alert('åˆ é™¤å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function saveMultiBet() {
  try {
    showLoading();
    
    const groupData = {
      categoryId: parseInt($('#categorySelect').value),
      name: $('#groupName').value.trim() || null,
      stake: parseFloat($('#totalStake').value)
    };
    
    await multiBetDB.createGroup(groupData, currentMatches);
    
    // æ¸…ç©ºè¡¨å•
    clearForm();
    
    // é‡æ–°åŠ è½½æ•°æ®
    await loadData();
    
    alert('å¤šé‡å½©ä¿å­˜æˆåŠŸï¼');
  } catch (error) {
    console.error('ä¿å­˜å¤šé‡å½©å¤±è´¥:', error);
    alert('ä¿å­˜å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

function clearForm() {
  $('#categorySelect').value = '';
  $('#groupName').value = '';
  $('#totalStake').value = '';
  $('#matchInputs').innerHTML = '';
  $('#totalOdds').value = '';
  $('#expectedReturn').value = '';
  currentMatches = [];
  updateSaveButton();
}

// ç»Ÿè®¡å‡½æ•°
function updateKPIs() {
  // æ ¹æ®å½“å‰åˆ†ç±»è¿‡æ»¤æ•°æ®
  const categoryFilter = window.currentCategoryFilter;
  let filteredGroups = multiBetGroups;
  if (categoryFilter) {
    filteredGroups = multiBetGroups.filter(group => group.category_id == categoryFilter);
  }
  
  const totalGroups = filteredGroups.length;
  const settledGroups = filteredGroups.filter(g => g.result !== 'pending');
  const winGroups = filteredGroups.filter(g => g.result === 'win');
  
  // åªè®¡ç®—å·²ç»“ç®—çš„å¤šé‡å½©ç»„çš„æŠ•å…¥å’Œè¿”è¿˜
  const totalStake = settledGroups.reduce((sum, g) => sum + g.total_stake, 0);
  const totalReturn = winGroups.reduce((sum, g) => sum + (g.total_stake * g.total_odds), 0);
  const netProfit = totalReturn - totalStake;
  
  const winRate = settledGroups.length > 0 ? (winGroups.length / settledGroups.length * 100) : 0;
  const roi = totalStake > 0 ? (netProfit / totalStake * 100) : 0;
  
  $('#k_total_groups').textContent = totalGroups;
  $('#k_settled_groups').textContent = settledGroups.length;
  $('#k_win_rate').textContent = winRate.toFixed(1) + '%';
  $('#k_total_stake').textContent = 'Â¥' + totalStake.toFixed(2);
  $('#k_total_return').textContent = 'Â¥' + totalReturn.toFixed(2);
  $('#k_net_profit').textContent = 'Â¥' + netProfit.toFixed(2);
  $('#k_net_profit').className = 'k-val ' + (netProfit >= 0 ? 'pos' : 'neg');
  $('#k_roi').textContent = roi.toFixed(1) + '%';
  $('#k_roi').className = 'k-val ' + (roi >= 0 ? 'pos' : 'neg');
}

function renderStats() {
  // æ ¹æ®å½“å‰åˆ†ç±»è¿‡æ»¤æ•°æ®
  const categoryFilter = window.currentCategoryFilter;
  let filteredGroups = multiBetGroups;
  if (categoryFilter) {
    filteredGroups = multiBetGroups.filter(group => group.category_id == categoryFilter);
  }
  
  // æ•´ä½“ç»Ÿè®¡
  const overallStats = {
    pending: filteredGroups.filter(g => g.result === 'pending'),
    win: filteredGroups.filter(g => g.result === 'win'),
    loss: filteredGroups.filter(g => g.result === 'loss')
  };
  
  const overallStatsHtml = Object.entries(overallStats).map(([status, groups]) => {
    const count = groups.length;
    // å¾…å®šçŠ¶æ€ä¸å‚ä¸é‡‘é¢è®¡ç®—
    const stake = status === 'pending' ? 0 : groups.reduce((sum, g) => sum + g.total_stake, 0);
    const returns = status === 'win' ? groups.reduce((sum, g) => sum + (g.total_stake * g.total_odds), 0) : 0;
    const profit = returns - stake;
    const winRate = status === 'pending' ? '-' : (status === 'win' ? '100%' : '0%');
    
    const statusText = status === 'pending' ? 'å¾…å®š' : status === 'win' ? 'å·²èµ¢' : 'å·²è¾“';
    
    // å¾…å®šçŠ¶æ€çš„é‡‘é¢æ˜¾ç¤ºä¸ºæ¨ªçº¿
    const stakeDisplay = status === 'pending' ? '-' : `Â¥${stake.toFixed(2)}`;
    const returnsDisplay = status === 'pending' ? '-' : `Â¥${returns.toFixed(2)}`;
    const profitDisplay = status === 'pending' ? '-' : `Â¥${profit.toFixed(2)}`;
    
    return `
      <tr>
        <td><span class="result-tag result-${status}">${statusText}</span></td>
        <td class="right">${count}</td>
        <td class="right">${stakeDisplay}</td>
        <td class="right">${returnsDisplay}</td>
        <td class="right ${status !== 'pending' && profit >= 0 ? 'pos' : status !== 'pending' && profit < 0 ? 'neg' : ''}">${profitDisplay}</td>
        <td class="right">${winRate}</td>
      </tr>
    `;
  }).join('');
  
  $('#overallStatsBody').innerHTML = overallStatsHtml;
  
  // æŒ‰è”èµ›ç»Ÿè®¡ï¼ˆåªç»Ÿè®¡å·²ç»“ç®—çš„æ¯”èµ›ï¼‰
  const leagueStats = {};
  filteredGroups.forEach(group => {
    (group.multi_bet_matches || []).forEach(match => {
      // è·³è¿‡å¾…å®šçŠ¶æ€çš„æ¯”èµ›
      if (match.result === 'pending') return;
      
      const league = match.league || 'æœªçŸ¥è”èµ›';
      if (!leagueStats[league]) {
        leagueStats[league] = { total: 0, win: 0, loss: 0 };
      }
      leagueStats[league].total++;
      if (match.result === 'win') leagueStats[league].win++;
      if (match.result === 'loss') leagueStats[league].loss++;
    });
  });
  
  const leagueStatsHtml = Object.entries(leagueStats)
    .sort(([,a], [,b]) => b.total - a.total)
    .map(([league, stats]) => {
      const winRate = stats.total > 0 ? (stats.win / (stats.win + stats.loss) * 100) : 0;
      return `
        <tr>
          <td>${league}</td>
          <td class="right">${stats.total}</td>
          <td class="right">${stats.win}</td>
          <td class="right">${stats.loss}</td>
          <td class="right">${isNaN(winRate) ? '-' : winRate.toFixed(1) + '%'}</td>
        </tr>
      `;
    }).join('');
  
  $('#leagueStatsBody').innerHTML = leagueStatsHtml || '<tr><td colspan="5" class="muted" style="text-align:center">æš‚æ— æ•°æ®</td></tr>';
  
  // æŒ‰å†…å®¹ç»Ÿè®¡ï¼ˆåªç»Ÿè®¡å·²ç»“ç®—çš„æ¯”èµ›ï¼‰
  const contentStats = {};
  filteredGroups.forEach(group => {
    (group.multi_bet_matches || []).forEach(match => {
      // è·³è¿‡å¾…å®šçŠ¶æ€çš„æ¯”èµ›
      if (match.result === 'pending') return;
      
      const content = match.description || 'æœªçŸ¥å†…å®¹';
      if (!contentStats[content]) {
        contentStats[content] = { total: 0, win: 0, loss: 0 };
      }
      contentStats[content].total++;
      if (match.result === 'win') contentStats[content].win++;
      if (match.result === 'loss') contentStats[content].loss++;
    });
  });
  
  const contentStatsHtml = Object.entries(contentStats)
    .sort(([,a], [,b]) => b.total - a.total)
    .map(([content, stats]) => {
      const winRate = stats.total > 0 ? (stats.win / (stats.win + stats.loss) * 100) : 0;
      return `
        <tr>
          <td>${content}</td>
          <td class="right">${stats.total}</td>
          <td class="right">${stats.win}</td>
          <td class="right">${stats.loss}</td>
          <td class="right">${isNaN(winRate) ? '-' : winRate.toFixed(1) + '%'}</td>
        </tr>
      `;
    }).join('');
  
  $('#contentStatsBody').innerHTML = contentStatsHtml || '<tr><td colspan="5" class="muted" style="text-align:center">æš‚æ— æ•°æ®</td></tr>';
}

// åŠ è½½åˆ†ç±»æ•°æ®
async function loadCategories() {
  try {
    const categories = await multiBetDB.getAllCategories();
    const categorySelect = $('#categorySelect');
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
    categorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
    
    // æ·»åŠ åˆ†ç±»é€‰é¡¹
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      option.style.color = category.color;
      categorySelect.appendChild(option);
    });
  } catch (error) {
    console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
  }
}

// æ•°æ®åŠ è½½
async function loadData() {
  try {
    showLoading();
    multiBetGroups = await multiBetDB.getAllGroups();
    renderMultiBetList();
    updateKPIs();
    renderStats();
  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    alert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// æ¸²æŸ“åˆ†ç±»å¯¼èˆªèœå•
async function renderCategoryNav() {
  try {
    const categories = await multiBetDB.getAllCategories();
    const categoryNavEl = $('#categoryNav');
    
    // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
    let navHtml = `
      <a href="#" class="category-nav-link active" data-category-id="all">
        <span class="dot" style="background:#6b7280"></span>
        å…¨éƒ¨
      </a>
    `;
    
    // æ·»åŠ å„ä¸ªåˆ†ç±»
    categories.forEach(category => {
      navHtml += `
        <a href="#" class="category-nav-link" data-category-id="${category.id}">
          <span class="dot" style="background:${category.color}"></span>
          ${category.name}
        </a>
      `;
    });
    
    categoryNavEl.innerHTML = navHtml;
    
    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    categoryNavEl.querySelectorAll('.category-nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        
        // æ›´æ–°æ¿€æ´»çŠ¶æ€
        categoryNavEl.querySelectorAll('.category-nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        // è®¾ç½®å½“å‰é€‰ä¸­çš„åˆ†ç±»
        const categoryId = link.dataset.categoryId;
        window.currentCategoryFilter = categoryId === 'all' ? null : categoryId;
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨å’Œç»Ÿè®¡
        renderMultiBetList();
        updateKPIs();
        renderStats();
      });
    });
  } catch (error) {
    console.error('æ¸²æŸ“åˆ†ç±»å¯¼èˆªå¤±è´¥:', error);
  }
}

// æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
async function renderCategoriesList() {
  try {
    const categories = await multiBetDB.getAllCategories();
    const categoriesListEl = $('#categoriesList');
    
    if (categories.length === 0) {
      categoriesListEl.innerHTML = '<p class="muted" style="text-align:center;padding:20px">æš‚æ— åˆ†ç±»</p>';
      return;
    }
    
    const categoriesHtml = categories.map(category => `
      <div class="category-item" style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="category-color" style="width:16px;height:16px;border-radius:50%;background:${category.color}"></span>
          <div>
            <div style="font-weight:500;color:#334155">${category.name}</div>
            ${category.description ? `<div style="font-size:12px;color:#64748b">${category.description}</div>` : ''}
          </div>
        </div>
        <div style="display:flex;gap:4px">
          <button class="btn-small" onclick="editCategory(${category.id}, '${category.name}', '${category.description || ''}', '${category.color}')">ç¼–è¾‘</button>
          <button class="btn-small sec" onclick="deleteCategory(${category.id})">åˆ é™¤</button>
        </div>
      </div>
    `).join('');
    
    categoriesListEl.innerHTML = categoriesHtml;
  } catch (error) {
    console.error('æ¸²æŸ“åˆ†ç±»åˆ—è¡¨å¤±è´¥:', error);
  }
}

// æ·»åŠ åˆ†ç±»
async function addCategory() {
  const name = $('#newCategoryName').value.trim();
  const color = $('#newCategoryColor').value;
  const description = $('#newCategoryDescription').value.trim();
  
  if (!name) {
    alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
    return;
  }
  
  try {
    showLoading();
    await multiBetDB.createCategory({ name, color, description });
    
    // æ¸…ç©ºè¡¨å•
    $('#newCategoryName').value = '';
    $('#newCategoryColor').value = '#3b82f6';
    $('#newCategoryDescription').value = '';
    
    // é‡æ–°åŠ è½½åˆ†ç±»åˆ—è¡¨å’Œä¸‹æ‹‰é€‰é¡¹
    await Promise.all([renderCategoriesList(), loadCategories()]);
    
    alert('åˆ†ç±»æ·»åŠ æˆåŠŸ');
  } catch (error) {
    console.error('æ·»åŠ åˆ†ç±»å¤±è´¥:', error);
    alert('æ·»åŠ åˆ†ç±»å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ç¼–è¾‘åˆ†ç±»
function editCategory(id, name, description, color) {
  const newName = prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:', name);
  if (newName === null) return;
  if (!newName.trim()) {
    alert('åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º');
    return;
  }
  
  const newDescription = prompt('è¯·è¾“å…¥æ–°çš„æè¿°ï¼ˆå¯é€‰ï¼‰:', description);
  if (newDescription === null) return;
  
  const newColor = prompt('è¯·è¾“å…¥æ–°çš„é¢œè‰²ï¼ˆåå…­è¿›åˆ¶ï¼‰:', color);
  if (newColor === null) return;
  if (!/^#[0-9A-Fa-f]{6}$/.test(newColor)) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åå…­è¿›åˆ¶é¢œè‰²ä»£ç ï¼ˆå¦‚ï¼š#3b82f6ï¼‰');
    return;
  }
  
  updateCategoryData(id, {
    name: newName.trim(),
    description: newDescription.trim(),
    color: newColor
  });
}

// æ›´æ–°åˆ†ç±»æ•°æ®
async function updateCategoryData(id, categoryData) {
  try {
    showLoading();
    await multiBetDB.updateCategory(id, categoryData);
    
    // é‡æ–°åŠ è½½åˆ†ç±»åˆ—è¡¨å’Œä¸‹æ‹‰é€‰é¡¹
    await Promise.all([renderCategoriesList(), loadCategories()]);
    
    alert('åˆ†ç±»æ›´æ–°æˆåŠŸ');
  } catch (error) {
    console.error('æ›´æ–°åˆ†ç±»å¤±è´¥:', error);
    alert('æ›´æ–°åˆ†ç±»å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// åˆ é™¤åˆ†ç±»
async function deleteCategory(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿå¦‚æœè¯¥åˆ†ç±»ä¸‹æœ‰å¤šé‡å½©è®°å½•ï¼Œå°†æ— æ³•åˆ é™¤ã€‚')) {
    return;
  }
  
  try {
    showLoading();
    await multiBetDB.deleteCategory(id);
    
    // é‡æ–°åŠ è½½åˆ†ç±»åˆ—è¡¨å’Œä¸‹æ‹‰é€‰é¡¹
    await Promise.all([renderCategoriesList(), loadCategories()]);
    
    alert('åˆ†ç±»åˆ é™¤æˆåŠŸ');
  } catch (error) {
    console.error('åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
    alert('åˆ é™¤åˆ†ç±»å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// è”èµ›ç®¡ç†åŠŸèƒ½

// åŠ è½½è”èµ›åˆ—è¡¨åˆ°ä¸‹æ‹‰é€‰é¡¹
async function loadLeagues() {
  try {
    const leagues = await multiBetDB.getAllLeagues();
    const datalist = $('#leagueDatalist');
    
    if (datalist) {
      datalist.innerHTML = leagues.map(league => 
        `<option value="${league.name}">${league.name} (${league.country || ''})</option>`
      ).join('');
    }
  } catch (error) {
    console.error('åŠ è½½è”èµ›åˆ—è¡¨å¤±è´¥:', error);
  }
}

// æ¸²æŸ“è”èµ›ç®¡ç†åˆ—è¡¨
async function renderLeaguesList() {
  try {
    const leagues = await multiBetDB.getAllLeagues();
    const container = $('#leaguesList');
    
    if (leagues.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:20px;color:#64748b">æš‚æ— è”èµ›</div>';
      return;
    }
    
    container.innerHTML = leagues.map(league => `
      <div style="border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:8px;background:white">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:500;color:#1e293b">${league.name}</div>
            <div style="font-size:12px;color:#64748b">${league.country || ''} ${league.description ? 'â€¢ ' + league.description : ''}</div>
          </div>
          <div style="display:flex;gap:4px">
            <button class="btn" style="padding:4px 8px;font-size:12px" onclick="editLeague(${league.id}, '${league.name}', '${league.country || ''}', '${league.description || ''}')">ç¼–è¾‘</button>
            <button class="btn warn" style="padding:4px 8px;font-size:12px" onclick="deleteLeague(${league.id})">åˆ é™¤</button>
          </div>
        </div>
      </div>
    `).join('');
  } catch (error) {
    console.error('æ¸²æŸ“è”èµ›åˆ—è¡¨å¤±è´¥:', error);
    $('#leaguesList').innerHTML = '<div style="text-align:center;padding:20px;color:#ef4444">åŠ è½½å¤±è´¥</div>';
  }
}

// æ·»åŠ æ–°è”èµ›
async function addLeague() {
  const name = $('#newLeagueName').value.trim();
  const country = $('#newLeagueCountry').value.trim();
  const description = $('#newLeagueDescription').value.trim();
  
  if (!name) {
    alert('è¯·è¾“å…¥è”èµ›åç§°');
    return;
  }
  
  try {
    showLoading();
    await multiBetDB.createLeague({ name, country, description });
    
    // æ¸…ç©ºè¡¨å•
    $('#newLeagueName').value = '';
    $('#newLeagueCountry').value = '';
    $('#newLeagueDescription').value = '';
    
    // é‡æ–°åŠ è½½è”èµ›åˆ—è¡¨å’Œä¸‹æ‹‰é€‰é¡¹
    await Promise.all([renderLeaguesList(), loadLeagues()]);
    
    alert('è”èµ›æ·»åŠ æˆåŠŸ');
  } catch (error) {
    console.error('æ·»åŠ è”èµ›å¤±è´¥:', error);
    alert('æ·»åŠ è”èµ›å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ç¼–è¾‘è”èµ›
function editLeague(id, currentName, currentCountry, currentDescription) {
  const newName = prompt('è”èµ›åç§°:', currentName);
  if (newName === null) return;
  
  const newCountry = prompt('å›½å®¶/åœ°åŒº:', currentCountry);
  if (newCountry === null) return;
  
  const newDescription = prompt('æè¿°:', currentDescription);
  if (newDescription === null) return;
  
  updateLeagueData(id, {
    name: newName.trim(),
    country: newCountry.trim(),
    description: newDescription.trim()
  });
}

// æ›´æ–°è”èµ›æ•°æ®
async function updateLeagueData(id, leagueData) {
  try {
    showLoading();
    await multiBetDB.updateLeague(id, leagueData);
    
    // é‡æ–°åŠ è½½è”èµ›åˆ—è¡¨å’Œä¸‹æ‹‰é€‰é¡¹
    await Promise.all([renderLeaguesList(), loadLeagues()]);
    
    alert('è”èµ›æ›´æ–°æˆåŠŸ');
  } catch (error) {
    console.error('æ›´æ–°è”èµ›å¤±è´¥:', error);
    alert('æ›´æ–°è”èµ›å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// åˆ é™¤è”èµ›
async function deleteLeague(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè”èµ›å—ï¼Ÿ')) {
    return;
  }
  
  try {
    showLoading();
    await multiBetDB.deleteLeague(id);
    
    // é‡æ–°åŠ è½½è”èµ›åˆ—è¡¨å’Œä¸‹æ‹‰é€‰é¡¹
    await Promise.all([renderLeaguesList(), loadLeagues()]);
    
    alert('è”èµ›åˆ é™¤æˆåŠŸ');
  } catch (error) {
    console.error('åˆ é™¤è”èµ›å¤±è´¥:', error);
    alert('åˆ é™¤è”èµ›å¤±è´¥: ' + error.message);
  } finally {
    hideLoading();
  }
}

// è”èµ›æœç´¢åŠŸèƒ½
function initLeagueSearch() {
  const searchInput = $('#searchLeagues');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const leagueItems = $('#leaguesList').children;
      
      Array.from(leagueItems).forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
      });
    });
  }
}

// æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
function initTabs() {
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const targetTab = this.getAttribute('data-tab');
      
      // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
      tabBtns.forEach(b => {
        b.classList.remove('active');
        b.style.color = '#64748b';
        b.style.borderBottomColor = 'transparent';
      });
      
      tabContents.forEach(content => {
        content.style.display = 'none';
      });
      
      // æ¿€æ´»å½“å‰æ ‡ç­¾é¡µ
      this.classList.add('active');
      this.style.color = '#3b82f6';
      this.style.borderBottomColor = '#3b82f6';
      
      document.getElementById(targetTab).style.display = 'block';
      
      // å¦‚æœåˆ‡æ¢åˆ°è”èµ›ç®¡ç†æ ‡ç­¾é¡µï¼ŒåŠ è½½è”èµ›åˆ—è¡¨
      if (targetTab === 'league-manage') {
        renderLeaguesList();
        initLeagueSearch();
      }
    });
  });
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
  // åˆå§‹åŒ–æ ‡ç­¾é¡µ
  initTabs();
  
  // ç»‘å®šäº‹ä»¶
  $('#addMatchBtn').addEventListener('click', addMatchInput);
  $('#saveMultiBet').addEventListener('click', saveMultiBet);
  $('#clearForm').addEventListener('click', clearForm);
  $('#totalStake').addEventListener('input', () => {
    updateTotalOdds();
    updateSaveButton();
  });
  $('#categorySelect').addEventListener('change', updateSaveButton);
  
  $('#searchGroups').addEventListener('input', renderMultiBetList);
  
  // ç­›é€‰æŒ‰é’®äº‹ä»¶
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      // æ¿€æ´»å½“å‰æŒ‰é’®
      this.classList.add('active');
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      renderMultiBetList();
    });
  });

  // ä½¿ç”¨setTimeoutç¡®ä¿DOMå®Œå…¨åŠ è½½
    setTimeout(() => {
      const formToggleBtn = $('#formIndentToggle');
      if (formToggleBtn) {
        formToggleBtn.addEventListener('click', function(e) {
          e.preventDefault();
          toggleFormCollapse();
        });
      }
    }, 100);
  
  // åˆ†ç±»ç®¡ç†äº‹ä»¶
  $('#addCategoryBtn').addEventListener('click', addCategory);
  
  // è”èµ›ç®¡ç†äº‹ä»¶
  $('#addLeagueBtn').addEventListener('click', addLeague);
  
  // æ·»åŠ ç¬¬ä¸€ä¸ªæ¯”èµ›è¾“å…¥
  addMatchInput();
  
  // åˆå§‹åŒ–ä¿å­˜æŒ‰é’®çŠ¶æ€
  updateSaveButton();
  
  // åˆå§‹åŒ–åŠ è½½æ•°æ®
    await loadCategories();
    await loadLeagues();
    await renderCategoryNav();
    await renderCategoriesList();
    await loadData();
});
</script>

</body>
</html>