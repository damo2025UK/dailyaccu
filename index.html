<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>足球下注记录簿</title>
<!-- Supabase JavaScript Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--panel:#fff;--muted:#64748b;--text:#0f172a;--pri:#0ea5e9;--pri2:#0284c7;--accent:#2563eb}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#f8fafc,#f1f5f9 35%,#eef2f7);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text)}
.navbar{position:sticky;top:0;z-index:10;background:#0f172a;color:#e5e7eb;border-bottom:1px solid rgba(255,255,255,.08);padding:8px 14px}
.navbar h1{margin:0;color:#f1f5f9}
.wrap{max-width:none;width:100%;margin:0;padding:16px}
.row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1}
.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(15,23,42,.12);background:var(--pri);color:#ecfeff;font-weight:600;cursor:pointer}
.btn.sec{background:#f8fafc;border-color:rgba(15,23,42,.12);color:#0f172a}.btn.warn{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.icon-btn{background:transparent;border:none;padding:4px;color:#e5e7eb;font-size:18px;cursor:pointer}
.icon-btn:hover{filter:brightness(1.2)}
input,select,button,textarea{font:inherit}input,select,textarea{width:100%;padding:8px 10px;border:1px solid rgba(15,23,42,.15);background:#fff;color:var(--text);border-radius:10px;outline:none}
.card{background:var(--panel);border:1px solid rgba(15,23,42,.08);border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(15,23,42,.06)}
.result-tag{padding:2px 6px;border-radius:999px;font-weight:600;font-size:12px}.result-win{color:#166534;background:rgba(22,101,52,.1)}.result-loss{color:#991b1b;background:rgba(185,28,28,.1)}.result-pending{color:#64748b;background:rgba(100,116,139,.12)}
.link{background:transparent;border:none;color:var(--accent);padding:0 2px;cursor:pointer}.link.win{color:#166534}.link.loss{color:#b91c1c}
.controls{display:flex;gap:8px;align-items:center}.controls .field{display:inline-flex;gap:6px;align-items:center;flex:0 0 auto}.controls input{width:100px}#currency{width:80px}
.small{font-size:12px}.muted{color:var(--muted)}.balance strong{font-size:1em;color:#16a34a;font-style:italic}
.layout{display:grid;grid-template-columns:3fr 2fr;gap:12px;align-items:start}
.layout.narrow-right{grid-template-columns:3fr 0.5fr}
#entryCardContent{transition:all 0.3s ease;overflow:hidden}
#entryCardContent.collapsed{max-height:0;opacity:0;margin:0;padding:0}
#toggleEntryCard svg{transition:transform 0.3s ease}
#toggleEntryCard.collapsed svg{transform:rotate(-90deg)}
.navlinks{display:flex;gap:10px;flex-wrap:wrap}
.navlinks a{color:#cbd5e1;text-decoration:none;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);display:inline-flex;gap:6px;align-items:center}
.navlinks a .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.navlinks a.active{color:#fff;background:rgba(96,165,250,.18);border-color:#60a5fa}
    /* KPI 样式 */
    .meta-line .kpi{display:flex;flex-direction:column;align-items:flex-end;min-width:72px}
    .meta-line .kpi .k-label{font-size:11px;color:var(--muted)}
    .meta-line .kpi .k-val{font-weight:600}
    .meta-line .kpi.balance .k-val{font-size:200%;font-weight:700}

.ops-line .link:hover{text-decoration:underline}
/* 输入区域样式 */.under input,.under select{border:none;border-bottom:1px solid rgba(15,23,42,.25);border-radius:0;background:transparent;padding-left:0;padding-right:0}
.under input:focus,.under select:focus{border-bottom-color:var(--accent);box-shadow:none}.under label{display:block;color:#1f2937;font-weight:700;margin-bottom:4px}
/* 抽屉样式 */
.drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px);z-index:40;display:none}
.drawer{position:fixed;top:0;right:0;height:100%;width:340px;max-width:90vw;background:#fff;color:#0f172a;border-left:1px solid rgba(15,23,42,.12);box-shadow:-8px 0 24px rgba(15,23,42,.15);transform:translateX(100%);transition:transform .25s ease;z-index:41;display:flex;flex-direction:column}
.drawer.open{transform:translateX(0)}
.drawer-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(15,23,42,.08)}
.drawer-body{padding:12px 14px;display:grid;gap:10px;align-content:start}
.drawer .field{display:grid;gap:6px}
.drawer hr{border:none;border-top:1px solid rgba(15,23,42,.08);margin:6px 0}
.icon-btn svg{display:block}

/* 表格 */table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}th,td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);text-align:left}
thead th{position:sticky;top:0;background:#f1f5f9;z-index:1;cursor:pointer}tbody tr:hover{background:#f8fafc}.right{text-align:right}
tbody tr.win{background:rgba(16,185,129,.08)}
tbody tr.loss{background:rgba(239,68,68,.08)}
.pos{color:#16a34a;font-style:italic}
.neg{color:#b91c1c;font-style:italic}

/* 统计小表格 */.stats-table{width:100%;border-collapse:collapse;margin-top:4px;table-layout:fixed;border:1px solid rgba(15,23,42,.18)}
.stats-table th,.stats-table td{padding:6px 8px;border-bottom:1px solid rgba(15,23,42,.08);font-size:13px}.stats-table th{background:#f8fafc;color:#334155;text-align:left}.stats-table td.right,.stats-table th.right{text-align:right}
@media(max-width:1000px){.layout{grid-template-columns:1fr}}@media(max-width:800px){.g-2{grid-template-columns:1fr}}
.tab-btn {
  transition: all 0.2s ease;
}
.tab-btn:hover {
  background: #e2e8f0 !important;
}
.tab-btn.active {
  background: white !important;
  color: #334155 !important;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* 视图切换按钮样式 */
.view-btn {
  padding: 6px 8px;
  border: 1px solid #e2e8f0;
  background: #f8fafc;
  color: #64748b;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}
.view-btn:hover {
  background: #e2e8f0;
  color: #334155;
}
.view-btn.active {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

/* 日期视图容器样式 */
.date-view-container .date-card.total-summary {
    border: 2px solid #3b82f6;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    margin-top: 20px;
  }
  
  .date-view-container .date-card.total-summary .date-header {
    background: #3b82f6;
    color: white;
  }
  
  .date-view-container .date-card.total-summary .date-title {
    font-weight: bold;
    font-size: 16px;
  }
  
  .date-view-container .date-card.total-summary .date-stats .stat-item {
    color: rgba(255, 255, 255, 0.9);
  }

  .date-view-container {
  display: none;
}
.date-view-container.active {
  display: block;
}
.date-card {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
}
.date-header {
  background: #e2e8f0;
  padding: 12px 16px;
  font-weight: 600;
  color: #334155;
  border-bottom: 1px solid #cbd5e1;
}
.date-content {
  padding: 0;
}
.date-table {
  width: 100%;
  border-collapse: collapse;
}
.date-table th,
.date-table td {
  padding: 8px 12px;
  border-bottom: 1px solid #e2e8f0;
  text-align: left;
}
.date-table th {
  background: #f1f5f9;
  font-weight: 600;
  color: #475569;
  font-size: 12px;
}
.date-table tbody tr:hover {
  background: #f1f5f9;
}
.date-table .right {
  text-align: right;
}
.date-table tbody tr.win {
  background: rgba(16,185,129,.08);
}
.date-table tbody tr.loss {
  background: rgba(239,68,68,.08);
}
</style></head><body>
<div class="navbar"><div class="row" style="align-items:center;gap:12px">
  <div style="display:flex;flex-direction:column;gap:6px;flex:1 1 auto">
    <div class="row" style="align-items:center;gap:10px;flex-wrap:nowrap">
      <h1 style="margin:0">⚽ 足球下注记录簿</h1>
      <div class="iconbar" style="display:flex;gap:10px;align-items:center">
        <button id="singleBetBtn" class="icon-btn" title="单场彩" aria-label="单场彩" onclick="window.location.href='index.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        </button>
        <button id="multiBetBtn" class="icon-btn" title="多重彩" aria-label="多重彩" onclick="window.location.href='multi-bet.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M9 9h6v6H9z"/><path d="M9 3v6"/><path d="M21 9h-6"/><path d="M15 21v-6"/><path d="M3 15h6"/></svg>
        </button>
        <button id="predictionTrackerBtn" class="icon-btn" title="预测来源记录验证" aria-label="预测来源记录验证" onclick="window.location.href='prediction-tracker.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4"/><path d="M20 16V7a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v1"/><path d="M15 2v5"/><path d="M9 2v5"/><path d="M3 9h18"/><circle cx="16" cy="16" r="2"/><path d="m21 21-1.5-1.5"/></svg>
        </button>
        <button id="xgTrackerBtn" class="icon-btn" title="xG 追踪分析" aria-label="xG 追踪分析" onclick="window.location.href='xg-tracker.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 12l3-3 3 3 5-5"/><circle cx="7" cy="12" r="1"/><circle cx="10" cy="9" r="1"/><circle cx="13" cy="12" r="1"/><circle cx="18" cy="7" r="1"/></svg>
        </button>
        <button id="notebookBtn" class="icon-btn" title="记事本" aria-label="记事本" onclick="window.location.href='notebook.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
        </button>
        <div style="width:1px;height:20px;background:#e2e8f0;margin:0 4px"></div>
        <button id="exportCsv" class="icon-btn" title="导出 CSV" aria-label="导出">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="m8 11 4 4 4-4"/><path d="M21 21H3"/></svg>
        </button>
        <button id="importCsvBtn" class="icon-btn" title="导入 CSV" aria-label="导入">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21V9"/><path d="m16 13-4-4-4 4"/><path d="M21 3H3"/></svg>
        </button>
        <button id="clearAll" class="icon-btn" title="清空当前分类" aria-label="清空">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
        <button id="manageProfiles" class="icon-btn" title="设置 / 新增分类" aria-label="设置">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16l-3.9-3.9a5 5 0 1 1-6.2-6.2L14 9"/><path d="M22 22l-5.5-5.5"/></svg>
        </button>
      </div>
    </div>
    <div class="navlinks" id="nav"></div>
  </div>
  <div class="controls" style="margin-left:auto;flex-direction:column;align-items:flex-end">
    <div class="row controls-line" style="gap:8px;align-items:center;justify-content:flex-end">




      </div>
      <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none"/>
    </div>
    <div class="meta-line small" style="margin-top:6px;display:flex;gap:16px;align-items:flex-end;justify-content:flex-end">
      <span style="margin-right:auto"></span>
      <div class="kpi"><div class="k-label">总笔数</div><div class="k-val" id="k_total">0</div></div>
      <div class="kpi"><div class="k-label">已结算</div><div class="k-val" id="k_settled">0</div></div>
      <div class="kpi"><div class="k-label">胜率</div><div class="k-val" id="k_wr">0%</div></div>
      <div class="kpi"><div class="k-label">总投入</div><div class="k-val" id="k_stake">0</div></div>
      <div class="kpi"><div class="k-label">总返还</div><div class="k-val" id="k_return">0</div></div>
      <div class="kpi"><div class="k-label">净收益</div><div class="k-val" id="k_profit">0</div></div>
      <div class="kpi"><div class="k-label">ROI</div><div class="k-val" id="k_roi">0%</div></div>
      <div class="kpi balance"><div class="k-label">余额</div><div class="k-val" id="balance">—</div></div>
    </div>
  </div>
</div></div>
<!-- 全局加载指示器 -->
<div id="loadingIndicator" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:8px;z-index:1000;display:none;text-align:center">
  <div style="margin-bottom:10px">数据处理中...</div>
  <div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<div class="wrap"><div class="layout">
  <div class="card">
    <div class="row"><input id="search" placeholder="搜索（按内容/结果/日期/联赛/比赛）"/>
      <div class="row" style="flex:0 0 auto;align-items:center;gap:6px">
        <!-- 视图切换按钮 -->
        <div class="view-toggle-buttons" style="display:flex;gap:4px;margin-right:8px">
          <button id="tableViewBtn" class="view-btn active" title="表格视图">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
            </svg>
          </button>
          <button id="dateViewBtn" class="view-btn" title="按日期分组">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </button>
        </div>
        <label style="align-self:center;margin:0;flex:0 0 auto">每页</label><select id="pageSize" style="width:auto;min-width:72px;max-width:120px;margin:0;flex:0 0 auto"><option>200</option><option selected>500</option><option>1000</option><option value="0">所有</option></select></div>
    </div>
    <!-- 表格视图 -->
    <div id="tableView" class="table-view-container">
      <table id="table"><thead><tr id="tableHeader">
        <th data-sort="date" style="width:110px">日期</th>
        <th data-sort="league" style="width:180px">联赛</th>
        <th data-sort="match" style="width:200px">比赛</th>
        <th data-sort="description" style="width:160px">内容</th>
        <th id="oddsHeader" data-sort="odds" class="right" style="width:90px">赔率</th>
        <th id="stakeHeader" data-sort="stake" class="right" style="width:90px">金额</th>
        <th data-sort="result" style="width:70px">结果</th>
        <th id="returnHeader" class="right" style="width:110px">返还</th>
        <th id="profitHeader" class="right" style="width:110px">收益</th>
        <th class="right" style="width:110px">余额</th>
        <th style="width:140px">操作</th>
      </tr></thead><tbody id="tbody"></tbody></table>
      <div class="row" style="margin-top:8px;align-items:center"><div class="small muted" id="pagerInfo">—</div><div style="margin-left:auto;display:flex;gap:6px"><button class="btn sec" id="prevPage">上一页</button><button class="btn sec" id="nextPage">下一页</button></div></div>
    </div>
    
    <!-- 日期视图 -->
    <div id="dateView" class="date-view-container">
      <!-- 日期分组的内容将在这里动态生成 -->
    </div>
    
    <div class="small" style="margin:12px 0;color:#64748b">数据保存在Supabase云数据库中。导出 CSV 可备份/迁移。</div>
  </div>
<!-- 抽屉与遮罩 -->
<div id="drawerBackdrop" class="drawer-backdrop"></div>
<div id="settingsDrawer" class="drawer" aria-hidden="true">
  <div class="drawer-header"><strong>设置 / 分类</strong>
    <button id="closeDrawer" class="icon-btn" title="关闭">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>
  <div class="drawer-body">
    <div class="field"><label>初始余额</label><input id="drawer_initial" type="number" min="0" step="0.01" placeholder="1000"/></div>
    <div class="field"><label>币种（前缀，如 CNY、$、€）</label><input id="drawer_currency" type="text" placeholder="CNY"/></div>
    <div class="row" style="gap:8px">
      <button id="drawer_save" class="btn" style="justify-self:start">保存设置</button>
      <button id="test_db_connection" class="btn sec" style="justify-self:start">测试数据库连接</button>
      <button id="debug_database" class="btn sec" style="justify-self:start">调试数据库</button>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button id="remove_duplicates_btn" class="btn warn" style="justify-self:start">一键去重</button>
    </div>
    <hr>
    <div class="field"><label>新增分类（显示名称）</label><input id="drawer_label" type="text" placeholder="如 My Tips"/></div>
    <div class="field"><label>英文标识（slug）</label><input id="drawer_slug" type="text" placeholder="如 my-tips"/></div>
    <button id="drawer_add_profile" class="btn sec" style="justify-self:start">新增分类</button>
    <hr>
    <div class="field"><label>分类列表</label>
      <div id="profileList" class="small" style="display:grid;gap:6px"></div>
    </div>
    <div class="field">
      <label>导入/导出全部数据</label>
      <div class="row" style="gap:8px">
        <button id="drawer_export_all" class="btn sec">导出全部 (soccer.csv)</button>
        <button id="drawer_import_all_btn" class="btn">导入全部 (soccer.csv)</button>
      </div>
      <input id="drawer_import_all_file" type="file" accept=".csv,text/csv" style="display:none"/>
    </div>
  </div>
</div>

  <div class="grid g-2" style="display:grid;grid-template-columns:1fr;gap:12px">
    <div class="card" id="entryCard">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="tab-buttons" style="display:flex;gap:2px;background:#f1f5f9;border-radius:6px;padding:2px">
            <button id="tabSingle" class="tab-btn active" style="padding:4px 12px;border:none;background:white;border-radius:4px;font-size:12px;cursor:pointer;color:#334155">单条录入</button>
            <button id="tabBatch" class="tab-btn" style="padding:4px 12px;border:none;background:transparent;border-radius:4px;font-size:12px;cursor:pointer;color:#64748b">xGScore批量</button>
            <button id="tabDailyBatch" class="tab-btn" style="padding:4px 12px;border:none;background:transparent;border-radius:4px;font-size:12px;cursor:pointer;color:#64748b">每日批量</button>
          </div>
        </div>
        <div style="display:flex;gap:4px">
          <button id="toggleEntryCard" class="icon-btn" title="折叠/展开" style="color:#64748b;font-size:16px">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </button>
          <button id="toggleRightPanel" class="icon-btn" title="调整面板宽度" style="color:#64748b;font-size:16px">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
          </button>
        </div>
        <!-- 每日批量录入面板 -->
        <div id="dailyBatchEntryPanel" style="display:none">
          <div style="margin-bottom:8px">
            <label style="display:block;margin-bottom:4px;font-size:12px;color:#334155">每日批量数据 (简化格式)</label>
            <textarea id="dailyBatchData" placeholder="请输入每日比赛数据，格式：&#10;联赛 | 时间 | 比赛 | 预测&#10;&#10;示例：&#10;英超 | 20:00 | 曼城 vs 阿森纳 | 主胜&#10;西甲 | 22:30 | 皇马 vs 巴萨 | 客胜&#10;德甲 | 21:30 | 拜仁 vs 多特 | 大2.5球&#10;&#10;注意：赔率默认2.0，金额默认50" style="width:100%;height:120px;resize:vertical;font-family:monospace;font-size:11px"></textarea>
          </div>
          <div class="row" style="margin-top:10px;gap:8px">
            <button id="parseDailyBatch" class="btn">解析数据</button>
            <button id="importDailyBatch" class="btn sec" disabled>批量导入</button>
            <button id="clearDailyBatch" class="btn sec">清空</button>
          </div>
          <div id="dailyBatchPreview" style="margin-top:12px;display:none">
            <div style="font-size:12px;color:#334155;margin-bottom:6px">预览 (<span id="dailyPreviewCount">0</span> 条记录)</div>
            <div style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;background:#f8fafc">
              <table style="width:100%;font-size:11px" id="dailyPreviewTable">
                <thead style="background:#e2e8f0;position:sticky;top:0">
                  <tr><th style="padding:4px;text-align:left">日期</th><th style="padding:4px;text-align:left">联赛</th><th style="padding:4px;text-align:left">比赛</th><th style="padding:4px;text-align:left">预测</th><th style="padding:4px;text-align:left">赔率</th><th style="padding:4px;text-align:left">金额</th></tr>
                </thead>
                <tbody id="dailyPreviewBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div id="entryCardContent">
        <!-- 单条录入面板 -->
        <div id="singleEntryPanel">
          <div class="row under"><div><label>日期</label><input id="date" type="date"/></div><div><label>联赛</label><div style="position:relative"><input id="league" type="text" placeholder="例如 英超" list="leagueList" autocomplete="off"/><datalist id="leagueList"></datalist></div></div><div><label>比赛</label><input id="match" type="text" placeholder="例如 曼城 vs 阿森纳"/></div></div>
          <div class="row under" style="margin-top:8px">
            <div><label>下注内容</label><div style="position:relative"><input id="description" type="text" placeholder="例：曼城胜" list="descList" autocomplete="off"/><datalist id="descList"></datalist></div></div>
            <div id="oddsField"><label>赔率 (小数)</label><input id="odds" type="number" step="0.01" min="1" placeholder="例如 1.85"/></div>
            <div id="stakeField"><label>金额</label><input id="stake" type="number" step="0.01" min="0" placeholder="例如 50"/></div>
            <div><label>结果</label><select id="result"><option value="pending">待定</option><option value="win">赢</option><option value="loss">输</option></select></div>
          </div>
          <div class="row" style="margin-top:10px"><button id="add" class="btn">+ 录入</button><button id="resetForm" class="btn sec">清空表单</button></div>
        </div>
        <!-- xGScore批量录入面板 -->
        <div id="batchEntryPanel" style="display:none">
          <div style="margin-bottom:8px">
            <label style="display:block;margin-bottom:4px;font-size:12px;color:#334155">批量数据 (表格格式，包含表头)</label>
            <textarea id="batchData" placeholder="请粘贴包含以下列的表格数据：&#10;日期 | 赛事 | 主队 | 客队 | 比分 | 投注内容 | 结果 | Odds | Percentage&#10;&#10;注意：&#10;- Percentage会转换为投注金额 (3%=30, 4%=40)&#10;- Odds会从欧式赔率转换为小数赔率" style="width:100%;height:120px;resize:vertical;font-family:monospace;font-size:11px"></textarea>
          </div>
          <div class="row" style="margin-top:10px;gap:8px">
            <button id="parseBatch" class="btn">解析数据</button>
            <button id="importBatch" class="btn sec" disabled>批量导入</button>
            <button id="clearBatch" class="btn sec">清空</button>
          </div>
          <div id="batchPreview" style="margin-top:12px;display:none">
            <div style="font-size:12px;color:#334155;margin-bottom:6px">预览 (<span id="previewCount">0</span> 条记录)</div>
            <div style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;background:#f8fafc">
              <table style="width:100%;font-size:11px" id="previewTable">
                <thead style="background:#e2e8f0;position:sticky;top:0">
                  <tr><th style="padding:4px;text-align:left">日期</th><th style="padding:4px;text-align:left">联赛</th><th style="padding:4px;text-align:left">比赛</th><th style="padding:4px;text-align:left">内容</th><th style="padding:4px;text-align:left">赔率</th><th style="padding:4px;text-align:left">金额</th><th style="padding:4px;text-align:left">结果</th></tr>
                </thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3 class="small" style="margin:0 0 8px;color:#334155;display:flex;align-items:center;justify-content:space-between">
        金额统计
        <button class="collapse-btn" onclick="toggleTable('stakeTable')" style="background:none;border:none;font-size:14px;cursor:pointer;color:#64748b">▼</button>
      </h3>
      <table class="small stats-table" id="stakeTable"></table>
      
      <h3 class="small" style="margin:8px 0 8px;color:#334155;display:flex;align-items:center;justify-content:space-between">
        内容准确率
        <button class="collapse-btn" onclick="toggleTable('underTable')" style="background:none;border:none;font-size:14px;cursor:pointer;color:#64748b">▼</button>
      </h3>
      <table class="small stats-table" id="underTable"></table>
      
      <h3 class="small" style="margin:8px 0 8px;color:#334155;display:flex;align-items:center;justify-content:space-between">
        赔率准确度（按区间）
        <button class="collapse-btn" onclick="toggleTable('oddsTable')" style="background:none;border:none;font-size:14px;cursor:pointer;color:#64748b">▼</button>
      </h3>
      <table class="small stats-table" id="oddsTable"></table>
      
      <h3 class="small" style="margin:8px 0 8px;color:#334155;display:flex;align-items:center;justify-content:space-between">
        联赛统计
        <button class="collapse-btn" onclick="toggleTable('leagueTable')" style="background:none;border:none;font-size:14px;cursor:pointer;color:#64748b">▼</button>
      </h3>
      <table class="small stats-table" id="leagueTable"></table>
    </div>
  </div>
</div></div>
<script>
// Supabase 配置
const SUPABASE_URL = 'https://hutlxrvwqrmidragxmtx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1dGx4cnZ3cXJtaWRyYWd4bXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMjk3ODMsImV4cCI6MjA3MTYwNTc4M30.KhDGniZHLEnmYJQWugq-U0o6EyZwmCPiXNbat_8Tyg4';

// 初始化 Supabase 客户端
let supabase;
try {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('Supabase 客户端初始化成功');
} catch (error) {
  console.error('Supabase 客户端初始化失败:', error);
  alert('数据库连接失败，请检查配置');
}

// 已移除localStorage保存函数，现在只使用Supabase

// 数据库操作对象
const db = {
  // 获取所有投注记录
  async getBets(profileKey) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { data, error } = await supabase
        .from('betting_records')
        .select('*')
        .eq('profile_key', profileKey)
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      return data || [];
    } catch (error) {
      console.error('获取投注记录失败:', error);
      return [];
    }
  },

  // 添加投注记录
  async addBet(bet, profileKey) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { data, error } = await supabase
        .from('betting_records')
        .insert([{
          profile_key: profileKey,
          date: bet.date,
          league: bet.league,
          match: bet.match,
          description: bet.description,
          odds: bet.odds,
          stake: bet.stake,
          result: bet.result
        }])
        .select();
      
      if (error) throw error;
      return data[0];
    } catch (error) {
      console.error('添加投注记录失败:', error);
      throw error;
    }
  },

  // 添加投注记录（带去重检查）
  async addBetWithDeduplication(bet, profileKey) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      // 检查是否存在重复记录（基于联赛、比赛、内容、赔率）
      const { data: existing, error: checkError } = await supabase
        .from('betting_records')
        .select('id')
        .eq('profile_key', profileKey)
        .eq('league', bet.league || '')
        .eq('match', bet.match || '')
        .eq('description', bet.description)
        .eq('odds', bet.odds)
        .maybeSingle();
      
      if (checkError) throw checkError;
      
      // 如果记录已存在，跳过插入
      if (existing) {
        console.log('跳过重复记录:', bet);
        return null;
      }
      
      // 插入新记录
      return await this.addBet(bet, profileKey);
    } catch (error) {
      console.error('添加投注记录（去重）失败:', error);
      throw error;
    }
  },

  // 删除重复记录
  async removeDuplicates(profileKey) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      // 获取所有记录
      const { data: allRecords, error } = await supabase
        .from('betting_records')
        .select('*')
        .eq('profile_key', profileKey)
        .order('created_at', { ascending: true });
      
      if (error) throw error;
      
      const seen = new Set();
      const duplicates = [];
      
      // 找出重复记录（基于联赛、比赛、内容、赔率）
      for (const record of allRecords) {
        const key = `${record.league || ''}-${record.match || ''}-${record.description}-${record.odds}`;
        if (seen.has(key)) {
          duplicates.push(record.id);
        } else {
          seen.add(key);
        }
      }
      
      // 删除重复记录
      if (duplicates.length > 0) {
        const { error: deleteError } = await supabase
          .from('betting_records')
          .delete()
          .in('id', duplicates);
        
        if (deleteError) throw deleteError;
      }
      
      return { deletedCount: duplicates.length };
    } catch (error) {
      console.error('删除重复记录失败:', error);
      throw error;
    }
  },

  // 更新投注记录
  async updateBet(id, updates) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { data, error } = await supabase
        .from('betting_records')
        .update(updates)
        .eq('id', id)
        .select();
      
      if (error) throw error;
      return data[0];
    } catch (error) {
      console.error('更新投注记录失败:', error);
      throw error;
    }
  },

  // 删除投注记录
  async deleteBet(id) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { error } = await supabase
        .from('betting_records')
        .delete()
        .eq('id', id);
      
      if (error) throw error;
      return true;
    } catch (error) {
      console.error('删除投注记录失败:', error);
      throw error;
    }
  },

  // 获取设置
  async getSettings(profileKey) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { data, error } = await supabase
        .from('user_settings')
        .select('*')
        .eq('profile_key', profileKey)
        .maybeSingle();
      
      if (error) throw error;
      return data ? { initial: data.initial_balance, currency: data.currency } : { initial: 0, currency: 'CNY' };
    } catch (error) {
      console.error('获取设置失败:', error);
      return { initial: 0, currency: 'CNY' };
    }
  },

  // 保存设置
  async saveSettings(settings, profileKey) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { data, error } = await supabase
        .from('user_settings')
        .upsert({
          profile_key: profileKey,
          initial_balance: settings.initial,
          currency: settings.currency
        }, {
          onConflict: 'profile_key'
        })
        .select();
      
      if (error) throw error;
      return data[0];
    } catch (error) {
      console.error('保存设置失败:', error);
      throw error;
    }
  },

  // 清空所有数据
  async clearAllData(profileKey) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      // 删除投注记录
      const { error: betsError } = await supabase
        .from('betting_records')
        .delete()
        .eq('profile_key', profileKey);
      
      if (betsError) throw betsError;
      
      // 删除设置
      const { error: settingsError } = await supabase
        .from('user_settings')
        .delete()
        .eq('profile_key', profileKey);
      
      if (settingsError) throw settingsError;
      
      return true;
    } catch (error) {
      console.error('清空数据失败:', error);
      throw error;
    }
  },

  // 获取所有profiles配置
  async getProfiles() {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { data, error } = await supabase
        .from('profiles_config')
        .select('*')
        .order('created_at', { ascending: true });
      
      if (error) throw error;
      
      // 转换为PROFILES格式
      const profiles = {};
      (data || []).forEach(profile => {
        profiles[profile.slug] = {
          label: profile.label,
          settingsKey: profile.settings_key,
          betsKey: profile.bets_key,
          exportName: profile.export_name,
          color: profile.color,
          categorizer: (b) => {
            const d = String(b.description || '');
            const m = d.match(/\b(under|over)\s*([0-9]+(?:\.[0-9]+)?)\b/i);
            if (m) {
              return [(m[1][0].toUpperCase() + m[1].slice(1).toLowerCase()) + " " + (+m[2]).toFixed(m[2].includes('.') ? 1 : 0)];
            }
            return firstWordCats(d);
          }
        };
      });
      
      return Object.keys(profiles).length > 0 ? profiles : DEFAULT_PROFILES;
    } catch (error) {
      console.error('获取profiles配置失败:', error);
      return DEFAULT_PROFILES;
    }
  },

  // 保存profile配置
  async saveProfile(slug, profileData) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { data, error } = await supabase
        .from('profiles_config')
        .upsert({
          slug: slug,
          label: profileData.label,
          settings_key: profileData.settingsKey,
          bets_key: profileData.betsKey,
          export_name: profileData.exportName,
          color: profileData.color || '#94a3b8',
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'slug'
        })
        .select();
      
      if (error) throw error;
      return data[0];
    } catch (error) {
      console.error('保存profile配置失败:', error);
      throw error;
    }
  },

  // 删除profile配置
  async deleteProfile(slug) {
    if (!supabase) {
      throw new Error('Supabase 未初始化');
    }
    try {
      const { error } = await supabase
        .from('profiles_config')
        .delete()
        .eq('slug', slug);
      
      if (error) throw error;
      return true;
    } catch (error) {
      console.error('删除profile配置失败:', error);
      throw error;
    }
  }
}; // 修复db对象的闭合大括号

const DEFAULT_PROFILES={
  "under95":{label:"Under 95",settingsKey:"bet_settings_under95",betsKey:"bet_records_under95",exportName:"under 95.csv",categorizer:(b)=>{const d=String(b.description||"");const m=d.match(/\\b(under|over)\\s*([0-9]+(?:\\.[0-9]+)?)\\b/i);if(m){const k=(m[1][0].toUpperCase()+m[1].slice(1).toLowerCase())+" "+(+m[2]).toFixed(m[2].includes('.')?1:0);return [k]}return firstWordCats(d)}},
  "hoods-web":{label:"hoods-web",settingsKey:"bet_settings_hoods_web",betsKey:"bet_records_hoods_web",exportName:"hoods-web.csv",categorizer:(b)=>{const d=String(b.description||"");const ks=[/home\s*win/i,/away\s*win/i,/draw/i,/btts\s*yes/i,/btts\s*no/i].filter(k=>k.test(d)).map(k=>d.match(k)[0].replace(/\s+/g,' ').trim());return ks.length?ks:firstWordCats(d)}},
  "hoods-whatsapp":{label:"hoods-whatsapp",settingsKey:"bet_settings_hoods_whatsapp",betsKey:"bet_records_hoods_whatsapp",exportName:"hoods-whatsapp.csv",categorizer:(b)=>{const d=String(b.description||"");const ks=[/first\s*half/i,/second\s*half/i,/corner/i,/card/i,/over\s*[0-9]+(\.[0-9]+)?/i,/under\s*[0-9]+(\.[0-9]+)?/i].filter(k=>k.test(d)).map(k=>d.match(k)[0].replace(/\s+/g,' ').trim());return ks.length?ks:firstWordCats(d)}},
  "supertips":{label:"SuperTipsAPP",settingsKey:"bet_settings_supertips",betsKey:"bet_records_supertips",exportName:"supertips.csv",categorizer:(b)=>{const d=String(b.description||"");const ks=[/over\s*[0-9]+(\.[0-9]+)?/i,/under\s*[0-9]+(\.[0-9]+)?/i,/home\s*win/i,/away\s*win/i,/draw/i].filter(k=>k.test(d)).map(k=>d.match(k)[0].replace(/\s+/g,' ').trim());return ks.length?ks:firstWordCats(d)}},
  "daily-match":{label:"每日比赛整理",settingsKey:"bet_settings_daily_match",betsKey:"bet_records_daily_match",exportName:"daily-match.csv",isSpecial:true,categorizer:(b)=>{const d=String(b.description||"");return firstWordCats(d)}}
};
const $=s=>document.querySelector(s);const navEl=$('#nav');
let PROFILES=DEFAULT_PROFILES; // 临时初始化，将从数据库加载
let current=location.hash.slice(1);
// 已移除localStorage函数，现在只使用Supabase

// 从数据库加载PROFILES配置
async function loadProfiles() {
  try {
    PROFILES = await db.getProfiles();
    if(!current || !PROFILES[current]){ 
      current=Object.keys(PROFILES)[0]; 
      if(current) location.hash = current;
    }
    renderNav();
    // 确保everyday分类存在
    await ensureEverydayProfile();
  } catch (error) {
    console.error('加载profiles配置失败:', error);
    PROFILES = DEFAULT_PROFILES;
    if(!current || !PROFILES[current]){ 
      current=Object.keys(PROFILES)[0]; 
      if(current) location.hash = current;
    }
    renderNav();
    // 确保everyday分类存在
    await ensureEverydayProfile();
  }
}

// 确保特殊分类存在
async function ensureEverydayProfile() {
  try {
    // 确保daily-match分类存在并具有isSpecial属性
    if (!PROFILES['daily-match']) {
      const dailyMatchProfile = {
        label: '每日比赛整理',
        settingsKey: 'bet_settings_daily_match',
        betsKey: 'bet_records_daily_match',
        exportName: 'daily-match.csv',
        color: '#8b5cf6',
        isSpecial: true, // 标记为特殊分类，不可删除和修改
        categorizer: (b) => {
          const d = String(b.description || '');
          return firstWordCats(d);
        }
      };
      
      await db.saveProfile('daily-match', dailyMatchProfile);
      PROFILES = { ...PROFILES, 'daily-match': dailyMatchProfile };
      renderNav();
      console.log('已创建每日比赛整理分类');
    } else {
      // 如果分类已存在，确保它有isSpecial属性
      if (!PROFILES['daily-match'].isSpecial) {
        PROFILES['daily-match'].isSpecial = true;
        await db.saveProfile('daily-match', PROFILES['daily-match']);
        console.log('已更新每日比赛整理分类的isSpecial属性');
      }
    }
    
    // 保持向后兼容，如果有旧的everyday分类也保留
    if (!PROFILES['everyday']) {
      const everydayProfile = {
        label: '每日比赛整理(旧)',
        settingsKey: 'bet_settings_everyday',
        betsKey: 'bet_records_everyday',
        exportName: 'everyday.csv',
        color: '#8b5cf6',
        isSpecial: true,
        categorizer: (b) => {
          const d = String(b.description || '');
          return firstWordCats(d);
        }
      };
      
      await db.saveProfile('everyday', everydayProfile);
      PROFILES = { ...PROFILES, everyday: everydayProfile };
      renderNav();
    }
  } catch (error) {
    console.error('创建特殊分类失败:', error);
  }
}

// 加载指示器辅助函数
function showLoading() {
  document.getElementById('loadingIndicator').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

// 新的异步数据操作函数 - 只使用Supabase
async function loadData() {
  showLoading();
  try {
    if (!supabase) {
      throw new Error('Supabase客户端未初始化');
    }
    
    const profileKey = current;
    console.log('正在加载profile数据:', profileKey);
    
    const [loadedSettings, loadedBets] = await Promise.all([
      db.getSettings(profileKey),
      db.getBets(profileKey)
    ]);
    
    console.log('加载的设置:', loadedSettings);
    console.log('加载的投注记录:', loadedBets);
    
    settings = loadedSettings;
    bets = loadedBets.map((bet, index) => ({
      date: bet.date,
      league: bet.league,
      match: bet.match,
      description: bet.description,
      odds: bet.odds,
      stake: bet.stake,
      result: bet.result,
      id: bet.id,
      i: index
    }));
    
    render();
  } catch (error) {
    console.error('加载数据失败:', error);
    alert('数据加载失败：' + error.message + '\n请检查数据库连接或联系管理员。');
    // 设置默认值但不使用localStorage
    settings = {initial: 0, currency: 'CNY'};
    bets = [];
    render();
  } finally {
    hideLoading();
  }
}
function firstWordCats(d){const m=d.match(/^[^,，\s]+/);return m?[m[0]]:[]}
const PROFILE_COLORS={"under95":"#60a5fa","hoods-web":"#f59e0b","hoods-whatsapp":"#10b981","supertips":"#ef4444"};
function renderNav(){navEl.innerHTML=Object.entries(PROFILES).map(([slug,p])=>{ const c=PROFILE_COLORS[slug]||"#94a3b8"; return `<a href="#${slug}" class="${slug===current?'active':''}"><span class="dot" style="background:${c}"></span><span>${p.label}</span></a>`; }).join('')}
window.addEventListener('hashchange',()=>{const slug=location.hash.slice(1);if(slug&&PROFILES[slug]){current=slug;renderNav();applyProfile();render()}});
function prof(){return PROFILES[current]} // shorthand
let settings={initial:0,currency:'CNY'};let bets=[];let sortBy='date',sortDir='desc',page=1;
async function applyProfile(){
  page=1;
  await loadData();
  
  // 检查当前分类是否为特殊分类
  const profileObj = prof();
  const isSpecialCategory = profileObj.isSpecial;
  console.log('当前分类:', current, '是否特殊分类:', isSpecialCategory);
  console.log('完整Profile对象:', JSON.stringify(profileObj, null, 2));
  console.log('PROFILES对象:', JSON.stringify(PROFILES, null, 2));
  
  // 检查是否为"每日比赛整理"分类，如果是则默认显示日期视图
  if (current === 'everyday-profile' || profileObj.label === '每日比赛整理') {
    switchView('date');
  } else {
    // 其他分类默认显示表格视图
    switchView('table');
  }
  
  // 动态隐藏/显示赔率和金额字段
  const oddsField = document.getElementById('oddsField');
  const stakeField = document.getElementById('stakeField');
  
  console.log('找到的元素:', {oddsField, stakeField});
  
  if (oddsField) {
    oddsField.style.display = isSpecialCategory ? 'none' : 'block';
    console.log('设置oddsField显示:', isSpecialCategory ? 'none' : 'block');
  }
  if (stakeField) {
    stakeField.style.display = isSpecialCategory ? 'none' : 'block';
    console.log('设置stakeField显示:', isSpecialCategory ? 'none' : 'block');
  }
  
  // 动态隐藏/显示表格列头
  const oddsHeader = document.getElementById('oddsHeader');
  const stakeHeader = document.getElementById('stakeHeader');
  const returnHeader = document.getElementById('returnHeader');
  const profitHeader = document.getElementById('profitHeader');
  
  console.log('找到的表头元素:', {oddsHeader, stakeHeader, returnHeader, profitHeader});
  
  if (oddsHeader) {
    oddsHeader.style.display = isSpecialCategory ? 'none' : 'table-cell';
    console.log('设置oddsHeader显示:', isSpecialCategory ? 'none' : 'table-cell');
  }
  if (stakeHeader) {
    stakeHeader.style.display = isSpecialCategory ? 'none' : 'table-cell';
    console.log('设置stakeHeader显示:', isSpecialCategory ? 'none' : 'table-cell');
  }
  if (returnHeader) {
    returnHeader.style.display = isSpecialCategory ? 'none' : 'table-cell';
    console.log('设置returnHeader显示:', isSpecialCategory ? 'none' : 'table-cell');
  }
  if (profitHeader) {
    profitHeader.style.display = isSpecialCategory ? 'none' : 'table-cell';
    console.log('设置profitHeader显示:', isSpecialCategory ? 'none' : 'table-cell');
  }
}
function symbol(){return settings.currency||''}
function fmtNum(n){return Number(n).toLocaleString(undefined,{maximumFractionDigits:2})}
function compute(b){let ret=null,profit=null;if(b.result==='win'){ret=+b.stake*+b.odds;profit=ret-+b.stake}else if(b.result==='loss'){ret=0;profit=-+b.stake}return {ret,profit}}
function sum(a){return a.reduce((x,y)=>x+(+y||0),0)}
function updateKPIs(){const cur=$('#search').value.trim().toLowerCase();const rows=bets.filter(b=>[b.date,b.league,b.match,b.description,b.result].some(x=>String(x||'').toLowerCase().includes(cur)));const settled=rows.filter(b=>b.result!=='pending');const wins=rows.filter(b=>b.result==='win');const stake=sum(settled.map(b=>+b.stake));const totalReturn=sum(settled.map(b=>compute(b).ret??0));const profit=totalReturn-stake;const wr=settled.length?Math.round(wins.length/settled.length*100):0;const roi=stake?Math.round(profit/stake*100):0;$('#k_total').textContent=rows.length;$('#k_settled').textContent=settled.length;$('#k_wr').textContent=wr+'%';$('#k_stake').textContent=symbol()+fmtNum(stake);$('#k_return').textContent=symbol()+fmtNum(totalReturn);$('#k_profit').textContent=symbol()+fmtNum(profit);$('#k_roi').textContent=roi+'%';const allProfit=sum(bets.filter(b=>b.result!=='pending').map(b=>compute(b).profit??0));const bal=+settings.initial+allProfit;const bel=$('#balance');bel.textContent=symbol()+Number(bal).toFixed(2);bel.classList.remove('pos','neg');if(bal>0)bel.classList.add('pos');else if(bal<0)bel.classList.add('neg');renderStats()}
function updateBalances(pageRows) {
  // 获取当前排序后的所有数据
  const cur = $('#search').value.trim().toLowerCase();
  let allRows = bets.map((b,i)=>({...b,i})).filter(b=>[b.date,b.league,b.match,b.description,b.result].some(x=>String(x||'').toLowerCase().includes(cur)));
  allRows.sort((a,b)=>{
    let r=0;
    if(sortBy==='created')r=a.i-b.i;
    else if(sortBy==='date')r=new Date(a.date||'1900-01-01') - new Date(b.date||'1900-01-01');
    else{
      const va=a[sortBy]??'';
      const vb=b[sortBy]??'';
      r=(typeof va==='number'||typeof vb==='number')?((+va)-(+vb)):String(va).localeCompare(String(vb))
    }
    if(r===0)r=a.i-b.i;
    return sortDir==='asc'?r:-r
  });
  
  // 从最后一行开始计算余额
  let runningBalance = +settings.initial;
  for(let i = allRows.length - 1; i >= 0; i--) {
    const b = allRows[i];
    const {profit} = compute(b);
    if(profit !== null) runningBalance += profit;
    
    // 如果这一行在当前页面中，更新显示
    const pageRow = pageRows.find(pr => pr.i === b.i);
    if(pageRow) {
      const balanceEl = $(`#balance-${b.i}`);
      if(balanceEl) {
        balanceEl.textContent = symbol() + runningBalance.toFixed(2);
        balanceEl.style.color = runningBalance >= 0 ? '#16a34a' : '#b91c1c';
      }
    }
  }
}

function render(){const cur=$('#search').value.trim().toLowerCase();let rows=bets.map((b,i)=>({...b,i})).filter(b=>[b.date,b.league,b.match,b.description,b.result].some(x=>String(x||'').toLowerCase().includes(cur)));rows.sort((a,b)=>{let r=0;if(sortBy==='created')r=a.i-b.i;else if(sortBy==='date')r=new Date(a.date||'1900-01-01') - new Date(b.date||'1900-01-01');else{const va=a[sortBy]??'';const vb=b[sortBy]??'';r=(typeof va==='number'||typeof vb==='number')?((+va)-(+vb)):String(va).localeCompare(String(vb))}if(r===0)r=a.i-b.i;return sortDir==='asc'?r:-r});const psValue=$('#pageSize').value;const ps=psValue==='0'?rows.length:(+psValue||500);const total=rows.length;const pages=Math.max(1,Math.ceil(total/ps));if(page>pages)page=pages;const start=(page-1)*ps;const pageRows=rows.slice(start,start+ps);$('#tbody').innerHTML=pageRows.map(r=>rowHTML(r)).join('')||`<tr><td colspan="12" class="muted">暂无数据</td></tr>`;$('#pagerInfo').textContent=psValue==='0'?`显示全部 ${total} 条`:`第 ${page}/${pages} 页，共 ${total} 条`;$('#prevPage').disabled=page<=1||psValue==='0';$('#nextPage').disabled=page>=pages||psValue==='0';updateBalances(pageRows);updateKPIs();updateLeagueList();updateDescList()}
function rowHTML(b){
  const {ret,profit}=compute(b);
  const retTxt=ret==null?'—':symbol()+Number(ret).toFixed(2);
  const pTxt=profit==null?'—':(profit>=0?'+':'')+symbol()+Number(Math.abs(profit)).toFixed(2);
  const pColor=profit==null?'':(profit>=0?'#16a34a':'#b91c1c');
  const isSpecialCategory = PROFILES[current] && PROFILES[current].isSpecial; // 检查是否为特殊分类
  
  return `<tr class="${b.result==='win'?'win':(b.result==='loss'?'loss':'')}">
    <td contenteditable data-act="edit" data-field="date" data-idx="${b.i}">${b.date||''}</td>
    <td contenteditable data-act="edit" data-field="league" data-idx="${b.i}">${escapeHTML(b.league||'')}</td>
    <td contenteditable data-act="edit" data-field="match" data-idx="${b.i}">${escapeHTML(b.match||'')}</td>
    <td contenteditable data-act="edit" data-field="description" data-idx="${b.i}">${escapeHTML(b.description||'')}</td>
    ${isSpecialCategory ? '' : `<td class="right" contenteditable data-act="edit" data-field="odds" data-idx="${b.i}">${(+b.odds).toFixed(3)}</td>`}
    ${isSpecialCategory ? '' : `<td class="right" contenteditable data-act="edit" data-field="stake" data-idx="${b.i}">${symbol()+Number(b.stake).toFixed(2)}</td>`}
    <td><span class="result-tag ${b.result==='win'?'result-win':(b.result==='loss'?'result-loss':'result-pending')}">${b.result==='win'?'赢':(b.result==='loss'?'输':'待定')}</span></td>
    ${isSpecialCategory ? '' : `<td class="right">${retTxt}</td>`}
    ${isSpecialCategory ? '' : `<td class="right" style="color:${pColor};font-weight:700;font-size:15px">${pTxt}</td>`}
    <td class="right" id="balance-${b.i}">${symbol()}0.00</td>
    <td><div class="row ops-line" style="gap:8px;align-items:center;flex-wrap:nowrap"><button class="link" data-act="set" data-value="pending" data-idx="${b.i}">待</button><button class="link win" data-act="set" data-value="win" data-idx="${b.i}">✓</button><button class="link loss" data-act="set" data-value="loss" data-idx="${b.i}">✗</button><button class="link" data-act="del" data-idx="${b.i}">🗑</button></div></td>
  </tr>`;
}

// 抽屉开关
const drawer=$('#settingsDrawer'), backdrop=$('#drawerBackdrop');
function openDrawer(){drawer.classList.add('open');backdrop.style.display='block';drawer.setAttribute('aria-hidden','false')}
function closeDrawer(){drawer.classList.remove('open');backdrop.style.display='none';drawer.setAttribute('aria-hidden','true')}
backdrop.onclick=closeDrawer;$('#closeDrawer').onclick=closeDrawer;
// 填充当前设置
function fillSettings(){ $('#drawer_initial').value=settings.initial||0; $('#drawer_currency').value=settings.currency||''; }
// 保存设置
$('#drawer_save').onclick=async()=>{ 
  const newSettings = {initial:+$('#drawer_initial').value||0, currency:$('#drawer_currency').value.trim()||''};
  showLoading();
  try{
    await db.saveSettings(newSettings, current);
    settings = newSettings;
    render();
    alert('已保存');
  }catch(error){
    console.error('保存设置失败:', error);
    alert('保存设置失败，请重试');
  }finally{
    hideLoading();
  }
};
$('#test_db_connection').onclick=async()=>{
  showLoading();
  try{
    const testSettings = await db.getSettings(current);
    const testBets = await db.getBets(current);
    alert('数据库连接成功！\n设置数据：' + (testSettings ? '已找到' : '未找到') + '\n投注记录：' + (testBets ? testBets.length + ' 条' : '0 条'));
  }catch(error){
    console.error('数据库连接测试失败:', error);
    alert('数据库连接失败：' + error.message);
  }finally{
    hideLoading();
  }
};

// 调试数据库函数
$('#debug_database').onclick=async()=>{
  showLoading();
  try{
    console.log('=== 数据库调试信息 ===');
    console.log('当前profile:', current);
    console.log('Supabase客户端状态:', supabase ? '已初始化' : '未初始化');
    
    // 检查所有profile的数据
    const allProfiles = Object.keys(PROFILES);
    let debugInfo = `当前profile: ${current}\nSupabase状态: ${supabase ? '已初始化' : '未初始化'}\n\n=== Supabase数据 ===\n`;
    
    for(const profileKey of allProfiles) {
      try {
        const settings = await db.getSettings(profileKey);
        const bets = await db.getBets(profileKey);
        debugInfo += `Profile: ${profileKey}\n`;
        debugInfo += `- 设置: ${settings ? JSON.stringify(settings) : '不存在'}\n`;
        debugInfo += `- 投注记录: ${bets ? bets.length : 0} 条\n`;
        if(bets && bets.length > 0) {
          debugInfo += `- 最新记录: ${bets[0].description}\n`;
        }
        debugInfo += '\n';
        console.log(`Profile ${profileKey}:`, { settings, bets });
      } catch(err) {
        debugInfo += `Profile: ${profileKey}\n- 错误: ${err.message}\n\n`;
        console.error(`Profile ${profileKey} 错误:`, err);
      }
    }
    
    alert(debugInfo);
  }catch(error){
    console.error('调试失败:', error);
    alert('调试失败：' + error.message);
  }finally{
    hideLoading();
  }
};

// 一键去重按钮事件处理
$('#remove_duplicates_btn').onclick = async () => {
  if (!confirm('确定要删除重复的投注记录吗？\n\n去重规则：基于联赛、比赛、内容、赔率四个字段判断重复\n系统将保留最早添加的记录，删除后续的重复项。\n此操作不可恢复！')) {
    return;
  }
  
  showLoading();
  try {
    const result = await db.removeDuplicates(current);
    if (result && result.deletedCount > 0) {
      alert(`去重完成！删除了 ${result.deletedCount} 条重复记录。`);
      render(); // 刷新显示
    } else {
      alert('没有发现重复记录。');
    }
  } catch (error) {
    console.error('去重失败:', error);
    alert('去重失败：' + error.message);
  } finally {
    hideLoading();
  }
};
// 新增分类
$('#drawer_add_profile').onclick=async()=>{ const label=$('#drawer_label').value.trim(); const slug=($('#drawer_slug').value||'').trim(); if(!label||!slug){alert('请填写名称和标识');return} if(!/^[a-z0-9-]{2,}$/.test(slug)){alert('标识不合法');return} if(PROFILES[slug]){alert('该标识已存在');return} const p={label,settingsKey:`bet_settings_${slug}`,betsKey:`bet_records_${slug}`,exportName:`${slug}.csv`,categorizer:(b)=>{const d=String(b.description||'');const m=d.match(/\b(under|over)\s*([0-9]+(?:\.[0-9]+)?)\b/i);if(m){return[(m[1][0].toUpperCase()+m[1].slice(1).toLowerCase())+" "+(+m[2]).toFixed(m[2].includes('.')?1:0)]}return firstWordCats(d)}}; try{showLoading();await db.saveProfile(slug,p);PROFILES={...PROFILES,[slug]:p};hideLoading();}catch(error){console.error('保存分类失败:',error);alert('保存分类失败，请重试');hideLoading();return;} 
  // 不再使用localStorage，PROFILES只在内存中管理
  renderNav(); location.hash=slug; alert('已新增分类'); };
// 入口：打开抽屉
$('#manageProfiles').onclick=()=>{ fillSettings(); renderProfileList(); openDrawer(); };

// 分类管理渲染与交互
function renderProfileList(){
  const el=$('#profileList');
  const rows=Object.entries(PROFILES).map(([slug,p])=>{
    const c=(p.color||PROFILE_COLORS[slug]||'#94a3b8');
    const active=slug===current;
    const isSpecial = p.isSpecial; // 检查是否为特殊分类
    return `<div style="display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center">
      <input data-k="label" data-slug="${slug}" value="${escapeHTML(p.label)}" ${isSpecial ? 'readonly' : ''}/>
      <input data-k="color" data-slug="${slug}" value="${c}" style="width:80px" ${isSpecial ? 'readonly' : ''}/>
      <button data-act="switch" data-slug="${slug}" class="icon-btn" title="切换到此分类">${active?'✅':'↪️'}</button>
      ${isSpecial ? '<span class="icon-btn" title="特殊分类，不可删除" style="color:#94a3b8">🔒</span>' : `<button data-act="delete" data-slug="${slug}" class="icon-btn" title="删除分类">🗑</button>`}
    </div>`
  }).join('');
  el.innerHTML=rows||'<div class="muted">暂无分类</div>';
}
$('#profileList').addEventListener('input',e=>{
  const t=e.target; const slug=t.getAttribute('data-slug'); const k=t.getAttribute('data-k'); if(!slug||!k) return;
  if(!PROFILES[slug] || PROFILES[slug].isSpecial) return; // 禁止修改特殊分类
  PROFILES[slug]={...PROFILES[slug],[k]:t.value}; 
  // 不再使用localStorage，PROFILES只在内存中管理
  renderNav();
});
$('#profileList').addEventListener('click',e=>{
  const t=e.target; const act=t.getAttribute('data-act'); const slug=t.getAttribute('data-slug'); if(!act||!slug) return;
  if(act==='switch'){ if(PROFILES[slug]){ location.hash=slug; } }
  if(act==='delete'){
    if(!PROFILES[slug] || PROFILES[slug].isSpecial) return; // 禁止删除特殊分类
    if(!confirm('删除该分类？此操作将同时删除数据库中该分类的所有数据，包括投注记录和设置。此操作不可恢复！')) return;
    
    // 删除数据库中的所有数据和配置
    showLoading();
    Promise.all([
      db.clearAllData(slug),
      db.deleteProfile(slug)
    ]).then(() => {
      // 删除成功后移除内存中的配置
      let newProfiles={...PROFILES}; delete newProfiles[slug];
      if(Object.keys(newProfiles).length===0){ 
        alert('已删除最后一个分类，系统将恢复默认分类'); 
        newProfiles={...DEFAULT_PROFILES}; 
      }
      PROFILES=newProfiles;
      if(!PROFILES[current]){ 
        const first=Object.keys(PROFILES)[0]; 
        if(first){ location.hash=first; } 
      }
      renderNav(); renderProfileList();
      alert('分类及其所有数据已成功删除');
    }).catch(error => {
      console.error('删除分类失败:', error);
      alert('删除失败：' + error.message);
    }).finally(() => {
      hideLoading();
    });
  }
});
// 打开抽屉时填充列表
function openDrawerAndFill(){ fillSettings(); renderProfileList(); openDrawer(); }
// 替换入口
$('#manageProfiles').onclick=openDrawerAndFill;

function escapeHTML(s){return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function normalizeLeagueName(name){return name.trim().replace(/\s+/g,' ').toLowerCase()}
function updateLeagueList(){const leagueMap=new Map();bets.forEach(b=>{if(b.league&&b.league.trim()){const original=b.league.trim();const normalized=normalizeLeagueName(original);if(!leagueMap.has(normalized)||leagueMap.get(normalized).length>original.length){leagueMap.set(normalized,original)}}});const uniqueLeagues=Array.from(leagueMap.values()).sort();const datalist=$('#leagueList');datalist.innerHTML=uniqueLeagues.map(league=>`<option value="${escapeHTML(league)}"></option>`).join('')}
function updateDescList(){const descMap=new Map();bets.forEach(b=>{if(b.description&&b.description.trim()){const original=b.description.trim();const normalized=original.toLowerCase();if(!descMap.has(normalized)||descMap.get(normalized).length>original.length){descMap.set(normalized,original)}}});const uniqueDescs=Array.from(descMap.values()).sort();const datalist=$('#descList');datalist.innerHTML=uniqueDescs.map(description=>`<option value="${escapeHTML(description)}"></option>`).join('')}
let leagueSortAlpha=false;function renderStats(){const stakeTable=$('#stakeTable'),underTable=$('#underTable'),oddsTable=$('#oddsTable'),leagueTable=$('#leagueTable');if(!stakeTable||!underTable||!oddsTable||!leagueTable)return;const settled=bets.filter(b=>b.result!=='pending');const allBets=bets.filter(b=>b.stake>0);const stakeMap={};let totalStake=0,totalReturn=0;allBets.forEach(b=>{const stake=+b.stake;const stakeRange=getStakeRange(stake);totalStake+=stake;if(b.result==='win'){totalReturn+=stake*b.odds}else if(b.result==='loss'){totalReturn+=0}else{totalReturn+=stake}(stakeMap[stakeRange]??={t:0,w:0,totalStake:0,totalReturn:0}).t++;if(b.result==='win')stakeMap[stakeRange].w++;stakeMap[stakeRange].totalStake+=stake;if(b.result==='win'){stakeMap[stakeRange].totalReturn+=stake*b.odds}else if(b.result==='loss'){stakeMap[stakeRange].totalReturn+=0}else{stakeMap[stakeRange].totalReturn+=stake}});const profit=totalReturn-totalStake;const stakeRows=Object.entries(stakeMap).sort((a,b)=>parseFloat(a[0].split('-')[0])-parseFloat(b[0].split('-')[0])).map(([range,v])=>{const rangeProfit=v.totalReturn-v.totalStake;const profitColor=rangeProfit>=0?'color:#059669':'color:#dc2626';return `<tr><td>${range}</td><td class="right">${v.w}/${v.t}</td><td class="right">${v.t?Math.round(v.w/v.t*100):0}%</td><td class="right">${v.totalStake.toFixed(0)}</td><td class="right" style="${profitColor}">${rangeProfit>=0?'+':''}${rangeProfit.toFixed(0)}</td></tr>`}).join('');const totalProfitColor=profit>=0?'color:#059669':'color:#dc2626';stakeTable.innerHTML=`<colgroup><col><col style="width:70px"><col style="width:60px"><col style="width:70px"><col style="width:80px"></colgroup><thead><tr><th>金额范围</th><th class="right">胜/总</th><th class="right">胜率</th><th class="right">总投注</th><th class="right">盈亏</th></tr></thead><tbody>${stakeRows||'<tr><td colspan=5 class="muted">—</td></tr>'}<tr style="border-top:2px solid #e2e8f0;font-weight:bold"><td>总计</td><td class="right">${allBets.filter(b=>b.result==='win').length}/${allBets.length}</td><td class="right">${allBets.length?Math.round(allBets.filter(b=>b.result==='win').length/allBets.length*100):0}%</td><td class="right">${totalStake.toFixed(0)}</td><td class="right" style="${totalProfitColor}">${profit>=0?'+':''}${profit.toFixed(0)}</td></tr></tbody>`;const getCats=(prof()&&typeof prof().categorizer==='function')?prof().categorizer:(b)=>{const description=String(b.description||'').trim();if(!description)return [];return [description];};const mapCats={};settled.forEach(b=>{(getCats(b)||[]).forEach(k=>{if(!k)return;(mapCats[k]??={t:0,w:0}).t++;if(b.result==='win')mapCats[k].w++})});const catRows=Object.entries(mapCats).sort((a,b)=>b[1].t-a[1].t).map(([name,v])=>`<tr><td>${name}</td><td class="right">${v.w}/${v.t}</td><td class="right">${v.t?Math.round(v.w/v.t*100):0}%</td></tr>`).join('');underTable.innerHTML=`<colgroup><col><col style="width:90px"><col style="width:70px"></colgroup><thead><tr><th>类型</th><th class="right">胜/总</th><th class="right">胜率</th></tr></thead><tbody>${catRows||'<tr><td colspan=3 class="muted">—</td></tr>'}</tbody>`;const map={};settled.forEach(b=>{const odds=+b.odds;let k;if(odds<=1.2)k='≤1.2';else if(odds<=1.5)k='1.21-1.5';else if(odds<=1.8)k='1.51-1.80';else if(odds<=2.0)k='1.81-2.0';else if(odds<=2.5)k='2.01-2.5';else k='2.51+';(map[k]??={t:0,w:0}).t++;if(b.result==='win')map[k].w++});const oddsOrder=['≤1.2','1.21-1.5','1.51-1.80','1.81-2.0','2.01-2.5','2.51+'];const oddsRows=oddsOrder.filter(k=>map[k]).map(k=>{const v=map[k];return `<tr><td>${k}</td><td class="right">${v.w}/${v.t}</td><td class="right">${v.t?Math.round(v.w/v.t*100):0}%</td></tr>`}).join('');oddsTable.innerHTML=`<thead><tr><th>赔率</th><th class="right">胜/总</th><th class="right">胜率</th></tr></thead><tbody>${oddsRows||'<tr><td colspan=3 class="muted">—</td></tr>'}</tbody>`;const leagueMap=new Map();const leagues={};settled.forEach(b=>{const original=b.league||'未填';const normalized=normalizeLeagueName(original);if(!leagueMap.has(normalized)||leagueMap.get(normalized).length>original.length){leagueMap.set(normalized,original)}const displayName=leagueMap.get(normalized);(leagues[displayName]??={t:0,w:0}).t++;if(b.result==='win')leagues[displayName].w++});const leagueRows=Object.entries(leagues).sort(leagueSortAlpha?(a,b)=>a[0].localeCompare(b[0]):(a,b)=>b[1].t-a[1].t).map(([k,v])=>`<tr><td style="cursor:pointer" onclick="toggleLeagueSort()">${k}</td><td class="right">${v.w}/${v.t}</td><td class="right">${v.t?Math.round(v.w/v.t*100):0}%</td></tr>`).join('');leagueTable.innerHTML=`<thead><tr><th style="cursor:pointer" onclick="toggleLeagueSort()">联赛 ${leagueSortAlpha?'(A-Z)':'(按数量)'}</th><th class="right">胜/总</th><th class="right">胜率</th></tr></thead><tbody>${leagueRows||'<tr><td colspan=3 class="muted">—</td></tr>'}</tbody>`}function toggleLeagueSort(){leagueSortAlpha=!leagueSortAlpha;renderStats()}

// 表格折叠/展开功能
function toggleTable(tableId) {
  const table = document.getElementById(tableId);
  const button = document.querySelector(`button[onclick="toggleTable('${tableId}')"]`);
  
  if (table.style.display === 'none') {
    table.style.display = 'table';
    button.textContent = '▼';
    button.title = '折叠表格';
  } else {
    table.style.display = 'none';
    button.textContent = '▶';
    button.title = '展开表格';
  }
}
function getStakeRange(stake){if(stake<=10)return '0-10';if(stake<=20)return '11-20';if(stake<=30)return '21-30';if(stake<=50)return '31-50';if(stake<=100)return '51-100';if(stake<=200)return '101-200';if(stake<=500)return '201-500';return '500+'}
async function addBet(){
  const isSpecialCategory = PROFILES[current] && PROFILES[current].isSpecial;
  
  const b={
    date:$('#date').value||new Date().toISOString().slice(0,10),
    league:($('#league').value||'').trim(),
    match:($('#match').value||'').trim(),
    description:($('#description').value||'').trim(),
    odds: isSpecialCategory ? 2.0 : (+$('#odds').value),
    stake: isSpecialCategory ? 0 : (+$('#stake').value),
    result:$('#result').value
  };
  
  if(!b.description){alert('请填写下注内容');return}
  
  // 对于特殊分类，跳过赔率和金额验证
  if(!isSpecialCategory) {
    if(!(b.odds>=1)){alert('请填写正确的赔率');return}
    if(!(b.stake>0)){alert('请填写正确的金额');return}
  }
  
  showLoading();
  try{
    const newBet=await db.addBet(b,current);
    bets.unshift({...b,id:newBet.id,i:0});
    bets.forEach((bet,index)=>bet.i=index);
    sortBy='date';
    sortDir='desc';
    page=1;
    render();
    $('#description').value='';
    $('#odds').value='';
    $('#stake').value='';
    $('#result').value='pending'
  }catch(error){
    console.error('添加记录失败:',error);
    alert('添加记录失败，请重试')
  }finally{
    hideLoading()
  }
}
async function setResult(i,v){showLoading();try{const bet=bets[i];await db.updateBet(bet.id,{result:v});bets[i].result=v;render()}catch(error){console.error('更新结果失败:',error);alert('更新失败，请重试')}finally{hideLoading()}}async function delBet(i){if(confirm('确定删除该记录？')){showLoading();try{const bet=bets[i];await db.deleteBet(bet.id);bets.splice(i,1);bets.forEach((bet,index)=>bet.i=index);render()}catch(error){console.error('删除记录失败:',error);alert('删除失败，请重试')}finally{hideLoading()}}}
async function onInlineEdit(e){const td=e.target;if(td.dataset.act!=='edit')return;const i=+td.dataset.idx;const field=td.dataset.field;let val=td.textContent.trim();if(field==='odds'||field==='stake'){val=val.replace(/[^0-9.\-]/g,'');const num=+val;if(!isFinite(num)){alert('数值不正确');render();return}val=num}showLoading();try{const bet=bets[i];await db.updateBet(bet.id,{[field]:val});bets[i][field]=val;render()}catch(error){console.error('更新失败:',error);alert('更新失败，请重试');render()}finally{hideLoading()}}
async function saveSettings(){const newSettings={initial:+$('#initial').value||0,currency:$('#currency').value.trim()||''};showLoading();try{await db.saveSettings(newSettings,current);settings=newSettings;render()}catch(error){console.error('保存设置失败:',error);alert('保存设置失败，请重试')}finally{hideLoading()}}
function exportCSV(){const rows=[["kind","date","league","match","description","odds","stake","result"],["settings","initial",settings.initial,",,,,"],["settings","currency",settings.currency,",,,,"]];bets.forEach(b=>rows.push(["bet",b.date,b.league||'',b.match||'',b.description,b.odds,b.stake,b.result]));const csv=toCSV(rows);download(prof().exportName,csv)}
async function importCSV(ev){const f=ev.target.files[0];if(!f)return;const reader=new FileReader();reader.onload=async()=>{try{const rows=parseCSV(String(reader.result||''));if(!rows.length){alert('CSV 内容为空');return}const header=rows[0].map(s=>s.toLowerCase());if(header[0]!=="kind"){alert('CSV 格式不兼容');return}if(header[1]==="profile"){showLoading();try{const R={},S={};let profilesUpdated=false;for(let i=1;i<rows.length;i++){const r=rows[i];const kind=(r[0]||'').toLowerCase();let slug=(r[1]||'').trim().toLowerCase();if(!/^[a-z0-9-]{2,}$/.test(slug)) continue;if(!PROFILES[slug]){const p={label:slug,settingsKey:`bet_settings_${slug}`,betsKey:`bet_records_${slug}`,exportName:`${slug}.csv`,categorizer:(b)=>{const d=String(b.description||'');return firstWordCats(d)}};PROFILES={...PROFILES,[slug]:p};profilesUpdated=true;}if(kind==="settings"){const k=(r[2]||'').toLowerCase();const v=r[3]||'';(S[slug]||(S[slug]={initial:0,currency:''}))[k]=k==='initial'?+v||0:v;}if(kind==="bet"){const descIndex=header.indexOf('desc')!==-1?header.indexOf('desc'):header.indexOf('description');(R[slug]||(R[slug]=[])).push({date:r[2]||today(),league:r[3]||'',match:r[4]||'',description:r[descIndex]||'',odds:+r[6]||0,stake:+r[7]||0,result:(r[8]||'pending').toLowerCase()});}}for(const [slug,settingsData] of Object.entries(S)){try{await db.saveSettings(settingsData,slug);}catch(error){console.warn(`保存设置失败 ${slug}:`,error);if(error.message&&error.message.includes('duplicate key')){try{await supabase.from('user_settings').delete().eq('profile_key',slug);await db.saveSettings(settingsData,slug);}catch(retryError){console.error(`重试保存设置失败 ${slug}:`,retryError);throw retryError;}}else{throw error;}}}for(const [slug,betsData] of Object.entries(R)){for(const bet of betsData){try{await db.addBet(bet,slug);}catch(error){console.warn(`保存投注记录失败:`,error);}}}if(profilesUpdated){renderNav();}await applyProfile();render();alert('导入成功');}catch(error){console.error('导入失败:',error);alert('导入失败，请重试')}finally{hideLoading()}return;}const newSettings={...settings};const newBets=[];const descIndex=header.indexOf('desc')!==-1?header.indexOf('desc'):header.indexOf('description');for(let i=1;i<rows.length;i++){const r=rows[i];const kind=(r[0]||'').toLowerCase();if(kind==='settings'){const key=(r[1]||'').toLowerCase();const val=r[2]||'';if(key==='initial')newSettings.initial=+val||0;if(key==='currency')newSettings.currency=val}else if(kind==='bet'){let b={};if(rows[0].length>=8){b={date:r[1]||today(),league:r[2]||'',match:r[3]||'',description:r[descIndex]||'',odds:+r[5]||0,stake:+r[6]||0,result:(r[7]||'pending').toLowerCase()}} if(b.description)newBets.push(b)}}showLoading();try{await db.saveSettings(newSettings,current);for(const bet of newBets){await db.addBet(bet,current);}settings=newSettings;const allBets=await db.getBets(current);bets=allBets.map((bet,index)=>({date:bet.date,league:bet.league,match:bet.match,description:bet.description,odds:bet.odds,stake:bet.stake,result:bet.result,id:bet.id,i:index}));sortBy='date';sortDir='desc';page=1;render();alert('导入成功')}catch(error){console.error('导入失败:',error);alert('导入失败，请重试')}finally{hideLoading()}}catch(e){console.error(e);alert('导入失败：'+e.message)}finally{ev.target.value=''}};reader.readAsText(f)} // 修复：添加缺失的闭合大括号
function today(){return new Date().toISOString().slice(0,10)}
function download(name,content){const blob=new Blob(["\uFEFF"+content],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href)}
function toCSV(rows){return rows.map(r=>r.map(csvEscape).join(',')).join('\n')}function csvEscape(s){if(s==null)s='';s=String(s);if(/[",\n]/.test(s))s='"'+s.replace(/"/g,'""')+'"';return s}
function parseCSV(text){const out=[];let row=[],field='',q=false;for(let i=0;i<text.length;i++){const c=text[i];if(q){if(c==='"'){if(text[i+1]==='"'){field+='"';i++;}else q=false}else field+=c}else{if(c==='"')q=true;else if(c===','){row.push(field);field='';}else if(c==='\n'){row.push(field);out.push(row);row=[];field='';}else if(c==='\r'){}else field+=c}}if(field!==''||row.length){row.push(field);out.push(row)}return out}

async function buildUI(){
  // 首先从数据库加载profiles配置
  await loadProfiles();
  
  // 然后执行其他初始化操作
  await applyProfile();render();updateLeagueList();updateDescList();
document.querySelectorAll('th[data-sort]').forEach(th=>{th.addEventListener('click',()=>{const key=th.getAttribute('data-sort');if(sortBy===key){sortDir=sortDir==='asc'?'desc':'asc'}else{sortBy=key;sortDir=key==='date'?'desc':'asc'};render()})});;
$('#prevPage').onclick=()=>{if(page>1){page--;render()}};$('#nextPage').onclick=()=>{page++;render()};

async function exportAllCSV(){
  showLoading();
  try {
    const rows=[["kind","profile","date","league","match","description","odds","stake","result"]];
    
    for (const [slug, p] of Object.entries(PROFILES)) {
      try {
        // 获取设置
        const settings = await db.getSettings(slug);
        rows.push(["settings",slug,"initial",settings.initial||0]);
        rows.push(["settings",slug,"currency",settings.currency||""]);
        
        // 获取投注记录
        const bets = await db.getBets(slug);
        bets.forEach(b=>rows.push(["bet",slug,b.date,b.league||"",b.match||"",b.description,b.odds,b.stake,b.result]));
      } catch (error) {
        console.warn(`导出 ${slug} 数据失败:`, error);
      }
    }
    
    download("soccer.csv",toCSV(rows));
  } catch (error) {
    console.error('导出失败:', error);
    alert('导出失败：' + error.message);
  } finally {
    hideLoading();
  }
}

async function importAllCSV(ev){
  const f=ev.target.files[0]; if(!f)return;
  const reader=new FileReader(); reader.onload=async()=>{ 
    showLoading();
    try{
      const rows=parseCSV(String(reader.result||'')); if(!rows.length){alert('CSV 内容为空');return}
      const H=rows[0].map(s=>s.toLowerCase()); if(H[0]!=="kind"||H[1]!=="profile"){alert("CSV 不兼容");return}
      
      const R={},S={};
      let profilesUpdated = false;
      for(let i=1;i<rows.length;i++){
        const r=rows[i]; const kind=(r[0]||'').toLowerCase(); let slug=(r[1]||'').trim().toLowerCase();
        if(!/^[a-z0-9-]{2,}$/.test(slug)) continue;
        if(!PROFILES[slug]){
          const p={label:slug,settingsKey:`bet_settings_${slug}`,betsKey:`bet_records_${slug}`,exportName:`${slug}.csv`,categorizer:(b)=>{const d=String(b.description||'');const m=d.match(/\b(under|over)\s*([0-9]+(?:\.[0-9]+)?)\b/i);if(m){return[(m[1][0].toUpperCase()+m[1].slice(1).toLowerCase())+" "+(+m[2]).toFixed(m[2].includes('.')?1:0)]}return firstWordCats(d)}};
          PROFILES={...PROFILES,[slug]:p};
          profilesUpdated = true;
          // 保存新的profile到数据库
          try{
            await db.saveProfile(slug,p);
          }catch(error){
            console.warn(`保存profile配置失败 ${slug}:`,error);
          }
        }
        if(kind==="settings"){
          const k=(r[2]||'').toLowerCase(); const v=r[3]||'';
          (S[slug]||(S[slug]={initial:0,currency:''}))[k]=k==='initial'?+v||0:v;
        }
        if(kind==="bet"){
          (R[slug]||(R[slug]=[])).push({date:r[2]||today(),league:r[3]||'',match:r[4]||'',description:r[5]||'',odds:+r[6]||0,stake:+r[7]||0,result:(r[8]||'pending').toLowerCase()});
        }
      }
      
      // 保存到Supabase
      for(const [slug,settingsData] of Object.entries(S)){
        try {
          await db.saveSettings(settingsData,slug);
        } catch (error) {
          console.warn(`保存设置失败 ${slug}:`, error);
          // 如果是重复键错误，尝试先删除再插入
          if (error.message && error.message.includes('duplicate key')) {
            try {
              await supabase.from('user_settings').delete().eq('profile_key', slug);
              await db.saveSettings(settingsData,slug);
            } catch (retryError) {
              console.error(`重试保存设置失败 ${slug}:`, retryError);
              throw retryError;
            }
          } else {
            throw error;
          }
        }
      }
      for(const [slug,betsData] of Object.entries(R)){
        for(const bet of betsData){
          try {
            await db.addBetWithDeduplication(bet,slug);
          } catch (error) {
            console.warn(`保存投注记录失败:`, error);
            // 继续处理其他记录，不中断整个导入过程
          }
        }
      }
      
      // 如果有新的profile被创建，重新渲染导航
      if (profilesUpdated) {
        renderNav();
      }
      
      await applyProfile(); render(); alert('导入成功');
    }catch(e){console.error(e);alert('导入失败：'+e.message)} finally{ ev.target.value=''; hideLoading(); } };
  reader.readAsText(f);
}

$('#add').onclick=addBet;$('#resetForm').onclick=()=>{$('#description').value='';$('#odds').value='';$('#stake').value='';$('#result').value='pending'};$('#search').oninput=()=>{page=1;render()};
$('#exportCsv').onclick=exportCSV;$('#importCsvBtn').onclick=()=>$('input#csvFile').click();$('#csvFile').onchange=importCSV;$('#clearAll').onclick=async()=>{if(confirm('这将清空当前分类的所有设定与记录，确定？')){showLoading();try{await db.clearAllData(current);await applyProfile();}catch(error){console.error('清空数据失败:',error);alert('清空数据失败：'+error.message);}finally{hideLoading();}}};
$('#drawer_export_all').onclick=exportAllCSV;$('#drawer_import_all_btn').onclick=()=>$('input#drawer_import_all_file').click();$('#drawer_import_all_file').onchange=importAllCSV;

$('#tbody').addEventListener('click',e=>{const t=e.target;const a=t.dataset.act;const i=+t.dataset.idx;if(a==='del')delBet(i);if(a==='set')setResult(i,t.dataset.value)});
$('#tbody').addEventListener('blur',onInlineEdit,true);$('#tbody').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();e.target.blur();}});

// 折叠/展开新增记录卡片
$('#toggleEntryCard').onclick=()=>{
  const content=$('#entryCardContent');
  const btn=$('#toggleEntryCard');
  if(content.classList.contains('collapsed')){
    content.classList.remove('collapsed');
    btn.classList.remove('collapsed');
  }else{
    content.classList.add('collapsed');
    btn.classList.add('collapsed');
  }
};

// 调整右侧面板宽度
$('#toggleRightPanel').onclick=()=>{
  const layout=document.querySelector('.layout');
  if(layout.classList.contains('narrow-right')){
    layout.classList.remove('narrow-right');
  }else{
    layout.classList.add('narrow-right');
  }
};

// 视图切换功能
$('#tableViewBtn').onclick=()=>{
  switchView('table');
};

$('#dateViewBtn').onclick=()=>{
  switchView('date');
};

// 选项卡切换功能
$('#tabSingle').onclick=()=>{
  $('#tabSingle').classList.add('active');
  $('#tabBatch').classList.remove('active');
  $('#tabDailyBatch').classList.remove('active');
  $('#singleEntryPanel').style.display='block';
  $('#batchEntryPanel').style.display='none';
  $('#dailyBatchEntryPanel').style.display='none';
};

$('#tabBatch').onclick=()=>{
  $('#tabBatch').classList.add('active');
  $('#tabSingle').classList.remove('active');
  $('#tabDailyBatch').classList.remove('active');
  $('#singleEntryPanel').style.display='none';
  $('#batchEntryPanel').style.display='block';
  $('#dailyBatchEntryPanel').style.display='none';
};

$('#tabDailyBatch').onclick=()=>{
  $('#tabDailyBatch').classList.add('active');
  $('#tabSingle').classList.remove('active');
  $('#tabBatch').classList.remove('active');
  $('#singleEntryPanel').style.display='none';
  $('#batchEntryPanel').style.display='none';
  $('#dailyBatchEntryPanel').style.display='block';
};

// 批量数据处理功能
let parsedBatchData=[];

$('#parseBatch').onclick=()=>{
  const data=$('#batchData').value.trim();
  if(!data){
    alert('请输入批量数据');
    return;
  }
  
  try{
    parsedBatchData=parseBatchData(data);
    if(parsedBatchData.length===0){
      alert('未找到有效数据');
      return;
    }
    
    // 显示预览
    $('#previewCount').textContent=parsedBatchData.length;
    const tbody=$('#previewBody');
    tbody.innerHTML=parsedBatchData.map(item=>
      `<tr>
        <td style="padding:4px">${item.date}</td>
        <td style="padding:4px">${item.league}</td>
        <td style="padding:4px">${item.match}</td>
        <td style="padding:4px">${item.description}</td>
        <td style="padding:4px">${item.odds}</td>
        <td style="padding:4px">${item.stake}</td>
        <td style="padding:4px">${item.result}</td>
      </tr>`
    ).join('');
    
    $('#batchPreview').style.display='block';
    $('#importBatch').disabled=false;
  }catch(e){
    alert('数据解析失败：'+e.message);
  }
};

$('#importBatch').onclick=async()=>{
  if(parsedBatchData.length===0){
    alert('没有可导入的数据');
    return;
  }
  
  if(confirm(`确定导入${parsedBatchData.length}条记录？`)){
    showLoading();
    let successCount = 0;
    let skipCount = 0;
    let errorCount = 0;
    const errors = [];
    
    try {
      // 检查当前profile是否有效
      if (!current || !PROFILES[current]) {
        throw new Error('请先选择一个有效的配置文件');
      }
      
      // 逐个添加记录到数据库（带去重）
      for(let i = 0; i < parsedBatchData.length; i++) {
        const bet = parsedBatchData[i];
        try {
          const newBet = await db.addBetWithDeduplication(bet, current);
          if (newBet) {
            // 成功添加新记录
            bets.unshift({...bet, id: newBet.id, i: 0});
            successCount++;
          } else {
            // 跳过重复记录
            skipCount++;
          }
        } catch(error) {
          console.error(`导入第${i+1}条记录失败:`, error);
          errors.push(`第${i+1}条: ${error.message}`);
          errorCount++;
        }
      }
      
      // 重新排序索引
      bets.forEach((bet, index) => bet.i = index);
      
      sortBy='date';
      sortDir='desc';
      page=1;
      render();
      
      // 清空批量输入
      $('#batchData').value='';
      $('#batchPreview').style.display='none';
      $('#importBatch').disabled=true;
      parsedBatchData=[];
      
      // 显示导入结果
      let message = `导入完成！\n成功: ${successCount}条\n跳过重复: ${skipCount}条`;
      if (errorCount > 0) {
        message += `\n失败: ${errorCount}条`;
        if (errors.length > 0) {
          message += `\n错误详情:\n${errors.slice(0, 5).join('\n')}`;
          if (errors.length > 5) {
            message += `\n...还有${errors.length - 5}个错误`;
          }
        }
      }
      alert(message);
      
    } catch(error) {
      console.error('批量导入过程失败:', error);
      alert(`批量导入失败: ${error.message}`);
    } finally {
      hideLoading();
    }
  }
};

$('#clearBatch').onclick=()=>{
  $('#batchData').value='';
  $('#batchPreview').style.display='none';
  $('#importBatch').disabled=true;
  parsedBatchData=[];
};

// 每日批量数据处理功能
let parsedDailyBatchData=[];

$('#parseDailyBatch').onclick=()=>{
  const data=$('#dailyBatchData').value.trim();
  if(!data){
    alert('请输入每日批量数据');
    return;
  }
  
  try{
    parsedDailyBatchData=parseDailyBatchData(data);
    if(parsedDailyBatchData.length===0){
      alert('未找到有效数据');
      return;
    }
    
    // 显示预览
    $('#dailyPreviewCount').textContent=parsedDailyBatchData.length;
    const tbody=$('#dailyPreviewBody');
    tbody.innerHTML=parsedDailyBatchData.map(item=>
      `<tr>
        <td style="padding:4px">${item.date}</td>
        <td style="padding:4px">${item.league}</td>
        <td style="padding:4px">${item.match}</td>
        <td style="padding:4px">${item.description}</td>
        <td style="padding:4px">${item.odds}</td>
        <td style="padding:4px">${item.stake}</td>
      </tr>`
    ).join('');
    
    $('#dailyBatchPreview').style.display='block';
    $('#importDailyBatch').disabled=false;
  }catch(e){
    alert('数据解析失败：'+e.message);
  }
};

$('#importDailyBatch').onclick=async()=>{
  if(parsedDailyBatchData.length===0){
    alert('没有可导入的数据');
    return;
  }
  
  if(confirm(`确定导入${parsedDailyBatchData.length}条记录到everyday分类？`)){
    showLoading();
    let successCount = 0;
    let skipCount = 0;
    let errorCount = 0;
    const errors = [];
    
    try {
      // 强制使用everyday分类
      const targetProfile = 'everyday';
      if (!PROFILES[targetProfile]) {
        throw new Error('everyday分类不存在，请刷新页面重试');
      }
      
      // 逐个添加记录到数据库（带去重）
      for(let i = 0; i < parsedDailyBatchData.length; i++) {
        const bet = parsedDailyBatchData[i];
        try {
          const newBet = await db.addBetWithDeduplication(bet, targetProfile);
          if (newBet) {
            // 成功添加新记录
            if (current === targetProfile) {
              bets.unshift({...bet, id: newBet.id, i: 0});
            }
            successCount++;
          } else {
            // 跳过重复记录
            skipCount++;
          }
        } catch(error) {
          console.error(`导入第${i+1}条记录失败:`, error);
          errors.push(`第${i+1}条: ${error.message}`);
          errorCount++;
        }
      }
      
      // 如果当前不是everyday分类，提示用户切换
      if (current !== targetProfile) {
        const switchToEveryday = confirm(`记录已导入到everyday分类。是否切换到everyday分类查看？`);
        if (switchToEveryday) {
          location.hash = targetProfile;
          return; // 页面会自动刷新，不需要继续执行
        }
      } else {
        // 重新排序索引
        bets.forEach((bet, index) => bet.i = index);
        
        sortBy='date';
        sortDir='desc';
        page=1;
        render();
      }
      
      sortBy='date';
      sortDir='desc';
      page=1;
      render();
      
      // 清空每日批量输入
      $('#dailyBatchData').value='';
      $('#dailyBatchPreview').style.display='none';
      $('#importDailyBatch').disabled=true;
      parsedDailyBatchData=[];
      
      // 显示导入结果
      let message = `导入完成！\n成功: ${successCount}条\n跳过重复: ${skipCount}条`;
      if (errorCount > 0) {
        message += `\n失败: ${errorCount}条`;
        if (errors.length > 0) {
          message += `\n错误详情:\n${errors.slice(0, 5).join('\n')}`;
          if (errors.length > 5) {
            message += `\n...还有${errors.length - 5}个错误`;
          }
        }
      }
      alert(message);
      
    } catch(error) {
      console.error('每日批量导入过程失败:', error);
      alert(`每日批量导入失败: ${error.message}`);
    } finally {
      hideLoading();
    }
  }
};

$('#clearDailyBatch').onclick=()=>{
  $('#dailyBatchData').value='';
  $('#dailyBatchPreview').style.display='none';
  $('#importDailyBatch').disabled=true;
  parsedDailyBatchData=[];
};

// 解析批量数据函数
function parseBatchData(text){
  const lines=text.split('\n').map(line=>line.trim()).filter(line=>line);
  if(lines.length<2)throw new Error('数据格式不正确，至少需要表头和一行数据');
  
  const results=[];
  
  for(let i=1;i<lines.length;i++){
    const line=lines[i];
    // 支持制表符或多个空格分隔
    const parts=line.split(/\t|\s{2,}/).map(p=>p.trim()).filter(p=>p);
    
    if(parts.length<9)continue; // 跳过不完整的行
    
    try{
      const dateStr=parts[0];
      const league=parts[1];
      const homeTeam=parts[2];
      const awayTeam=parts[3];
      const score=parts[4];
      const description=parts[5];
      const resultStr=parts[6];
      const oddsStr=parts[7].replace(',','.');
      const percentageStr=parts[8];
      
      // 转换日期格式
      let date=dateStr;
      if(dateStr.includes('年')){
        // 处理中文日期格式
        const match=dateStr.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
        if(match){
          const year=match[1];
          const month=match[2].padStart(2,'0');
          const day=match[3].padStart(2,'0');
          date=`${year}-${month}-${day}`;
        }
      }
      
      // 转换赔率（从欧式赔率到小数赔率，实际上欧式赔率就是小数赔率）
      const odds=parseFloat(oddsStr);
      if(isNaN(odds)||odds<1)continue;
      
      // 转换百分比为金额
      const percentage=parseFloat(percentageStr.replace('%',''));
      if(isNaN(percentage)||percentage<=0)continue;
      const stake=percentage*10; // 3%=30, 4%=40
      
      // 转换结果
      let result='pending';
      if(resultStr==='赢')result='win';
      else if(resultStr==='输')result='loss';
      else if(resultStr==='平')result='push';
      
      // 跳过结果为"平"的记录
      if(result==='push'){
        console.log('跳过平局记录:', `${homeTeam} vs ${awayTeam}`);
        continue;
      }
      
      results.push({
        date:date,
        league:league,
        match:`${homeTeam} vs ${awayTeam}`,
        description:description,
        odds:odds,
        stake:stake,
        result:result
      });
    }catch(e){
      console.warn('跳过无效行：',line,e.message);
    }
  }
  
  return results;
}

} // buildUI函数的闭合大括号

// 解析每日批量数据函数（专门用于everyday分类）
function parseDailyBatchData(text){
  const lines=text.split('\n').map(line=>line.trim()).filter(line=>line);
  if(lines.length<1)throw new Error('请输入有效的每日批量数据');
  
  const results=[];
  const today = new Date().toISOString().split('T')[0]; // 获取今天的日期
  
  for(let i=0;i<lines.length;i++){
    const line=lines[i];
    // 支持 | 分隔符，格式：联赛|时间|比赛|预测
    const parts=line.split('|').map(p=>p.trim()).filter(p=>p);
    
    if(parts.length<4)continue; // 跳过不完整的行
    
    try{
      const league=parts[0];
      const time=parts[1];
      const match=parts[2];
      const prediction=parts[3];
      
      // 验证数据有效性
      if(!league || !time || !match || !prediction)continue;
      
      results.push({
        date: today, // 使用今天的日期
        league: league,
        match: match,
        description: prediction, // 预测作为投注内容
        odds: 2.0, // 默认赔率2.0
        stake: 50, // 默认投注金额50
        result: 'pending' // 默认结果为待定
      });
    }catch(e){
      console.warn('跳过无效行：',line,e.message);
    }
  }
  
  return results;
}

// 视图切换功能
let currentView = 'table'; // 'table' 或 'date'

function switchView(view) {
  currentView = view;
  
  // 更新按钮状态
  document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
  document.getElementById('dateViewBtn').classList.toggle('active', view === 'date');
  
  // 切换视图容器
  document.getElementById('tableView').classList.toggle('active', view === 'table');
  document.getElementById('dateView').classList.toggle('active', view === 'date');
  
  if (view === 'date') {
    renderDateView();
  }
}

// 按日期分组渲染函数
function renderDateView() {
  const cur = document.getElementById('search').value.trim().toLowerCase();
  
  // 过滤数据
  let filteredBets = bets.filter(b => 
    [b.date, b.league, b.match, b.description, b.result]
      .some(x => String(x || '').toLowerCase().includes(cur))
  );
  
  // 按日期分组
  const groupedByDate = {};
  filteredBets.forEach(bet => {
    const date = bet.date || '未知日期';
    if (!groupedByDate[date]) {
      groupedByDate[date] = [];
    }
    groupedByDate[date].push(bet);
  });
  
  // 按日期排序（最新的在前）
  const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
    if (a === '未知日期') return 1;
    if (b === '未知日期') return -1;
    return new Date(b) - new Date(a);
  });
  
  // 生成HTML - 先显示按日期分组的表格
  let html = '';
  if (sortedDates.length === 0) {
    html = '<div class="date-card"><div class="date-content">暂无数据</div></div>';
  } else {
    // 按日期分组的表格
    sortedDates.forEach(date => {
      const dayBets = groupedByDate[date];
      const dayStats = calculateDayStats(dayBets);
      
      html += `
        <div class="date-card">
          <div class="date-header">
            <div class="date-title">${formatDateTitle(date)}</div>
            <div class="date-stats">
              <span class="stat-item">共${dayBets.length}场</span>
              <span class="stat-item">胜率${dayStats.winRate}%</span>
              <span class="stat-item ${dayStats.profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                收益${dayStats.profit >= 0 ? '+' : ''}${dayStats.profit.toFixed(2)}
              </span>
            </div>
          </div>
          <div class="date-content">
            <table class="date-table">
              <thead>
                <tr>
                  <th>联赛</th>
                  <th>比赛</th>
                  <th>内容</th>
                  <th class="right">赔率</th>
                  <th class="right">金额</th>
                  <th>结果</th>
                  <th class="right">收益</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                ${dayBets.map(bet => renderDateRowHTML(bet)).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    });
    
    // 在最下方添加总表格
    const totalStats = calculateTotalStats(filteredBets);
    html += `
      <div class="date-card total-summary">
        <div class="date-header">
          <div class="date-title">总计汇总</div>
          <div class="date-stats">
            <span class="stat-item">共${filteredBets.length}场</span>
            <span class="stat-item">胜率${totalStats.winRate}%</span>
            <span class="stat-item ${totalStats.profit >= 0 ? 'profit-positive' : 'profit-negative'}">
              总收益${totalStats.profit >= 0 ? '+' : ''}${totalStats.profit.toFixed(2)}
            </span>
          </div>
        </div>
        <div class="date-content">
          <table class="date-table">
            <thead>
              <tr>
                <th>日期</th>
                <th>联赛</th>
                <th>比赛</th>
                <th>内容</th>
                <th class="right">赔率</th>
                <th class="right">金额</th>
                <th>结果</th>
                <th class="right">收益</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${filteredBets.map(bet => renderTotalRowHTML(bet)).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  document.getElementById('dateView').innerHTML = html;
}

// 计算总统计
function calculateTotalStats(allBets) {
  const totalBets = allBets.length;
  const winBets = allBets.filter(bet => bet.result === 'win').length;
  const winRate = totalBets > 0 ? Math.round((winBets / totalBets) * 100) : 0;
  
  let profit = 0;
  allBets.forEach(bet => {
    if (bet.result === 'win') {
      profit += (bet.odds - 1) * bet.stake;
    } else if (bet.result === 'loss') {
      profit -= bet.stake;
    }
  });
  
  return { totalBets, winBets, winRate, profit };
}

// 渲染总表格中的行HTML
function renderTotalRowHTML(bet) {
  const profit = bet.result === 'win' ? (bet.odds - 1) * bet.stake : 
                 bet.result === 'loss' ? -bet.stake : 0;
  
  const resultClass = bet.result === 'win' ? 'win' : 
                     bet.result === 'loss' ? 'loss' : '';
  
  return `
    <tr class="${resultClass}">
      <td>${bet.date || ''}</td>
      <td>${bet.league || ''}</td>
      <td>${bet.match || ''}</td>
      <td>${bet.description || ''}</td>
      <td class="right">${bet.odds ? bet.odds.toFixed(2) : ''}</td>
      <td class="right">${bet.stake ? bet.stake.toFixed(0) : ''}</td>
      <td>
        <select onchange="updateResult(${bet.i}, this.value)" style="width:70px;padding:2px;font-size:12px">
          <option value="pending" ${bet.result === 'pending' ? 'selected' : ''}>待定</option>
          <option value="win" ${bet.result === 'win' ? 'selected' : ''}>赢</option>
          <option value="loss" ${bet.result === 'loss' ? 'selected' : ''}>输</option>
          <option value="push" ${bet.result === 'push' ? 'selected' : ''}>平</option>
        </select>
      </td>
      <td class="right ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
        ${profit !== 0 ? (profit >= 0 ? '+' : '') + profit.toFixed(2) : ''}
      </td>
      <td>
        <button onclick="editBet(${bet.i})" class="btn sec small">编辑</button>
        <button onclick="deleteBet(${bet.i})" class="btn sec small" style="margin-left:4px">删除</button>
      </td>
    </tr>
  `;
}

// 计算单日统计
function calculateDayStats(dayBets) {
  const totalBets = dayBets.length;
  const winBets = dayBets.filter(bet => bet.result === 'win').length;
  const winRate = totalBets > 0 ? Math.round((winBets / totalBets) * 100) : 0;
  
  let profit = 0;
  dayBets.forEach(bet => {
    if (bet.result === 'win') {
      profit += (bet.odds - 1) * bet.stake;
    } else if (bet.result === 'loss') {
      profit -= bet.stake;
    }
  });
  
  return { totalBets, winBets, winRate, profit };
}

// 格式化日期标题
function formatDateTitle(date) {
  if (date === '未知日期') return date;
  
  try {
    const d = new Date(date);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (d.toDateString() === today.toDateString()) {
      return `今天 (${date})`;
    } else if (d.toDateString() === yesterday.toDateString()) {
      return `昨天 (${date})`;
    } else {
      const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
      return `${date} ${weekdays[d.getDay()]}`;
    }
  } catch (e) {
    return date;
  }
}

// 渲染日期视图中的行HTML
function renderDateRowHTML(bet) {
  const profit = bet.result === 'win' ? (bet.odds - 1) * bet.stake : 
                 bet.result === 'loss' ? -bet.stake : 0;
  
  const resultClass = bet.result === 'win' ? 'win' : 
                     bet.result === 'loss' ? 'loss' : '';
  
  return `
    <tr class="${resultClass}">
      <td>${bet.league || ''}</td>
      <td>${bet.match || ''}</td>
      <td>${bet.description || ''}</td>
      <td class="right">${bet.odds ? bet.odds.toFixed(2) : ''}</td>
      <td class="right">${bet.stake ? bet.stake.toFixed(0) : ''}</td>
      <td>
        <select onchange="updateResult(${bet.i}, this.value)" style="width:70px;padding:2px;font-size:12px">
          <option value="pending" ${bet.result === 'pending' ? 'selected' : ''}>待定</option>
          <option value="win" ${bet.result === 'win' ? 'selected' : ''}>赢</option>
          <option value="loss" ${bet.result === 'loss' ? 'selected' : ''}>输</option>
          <option value="push" ${bet.result === 'push' ? 'selected' : ''}>平</option>
        </select>
      </td>
      <td class="right ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
        ${profit !== 0 ? (profit >= 0 ? '+' : '') + profit.toFixed(2) : ''}
      </td>
      <td>
        <button onclick="editBet(${bet.i})" class="btn sec small">编辑</button>
        <button onclick="deleteBet(${bet.i})" class="btn sec small" style="margin-left:4px">删除</button>
      </td>
    </tr>
  `;
}

document.addEventListener('DOMContentLoaded', function() {
  // 不再自动跳转，直接初始化页面
  buildUI();
}); // 添加缺失的闭合大括号
</script></body></html>

