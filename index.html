<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>è¶³çƒä¸‹æ³¨è®°å½•ç°¿</title>
<!-- Supabase JavaScript Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--panel:#fff;--muted:#64748b;--text:#0f172a;--pri:#0ea5e9;--pri2:#0284c7;--accent:#2563eb}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#f8fafc,#f1f5f9 35%,#eef2f7);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text)}
.navbar{position:sticky;top:0;z-index:10;background:#0f172a;color:#e5e7eb;border-bottom:1px solid rgba(255,255,255,.08);padding:8px 14px}
.navbar h1{margin:0;color:#f1f5f9}
.wrap{max-width:none;width:100%;margin:0;padding:16px}
.row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1}
.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(15,23,42,.12);background:var(--pri);color:#ecfeff;font-weight:600;cursor:pointer}
.btn.sec{background:#f8fafc;border-color:rgba(15,23,42,.12);color:#0f172a}.btn.warn{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.icon-btn{background:transparent;border:none;padding:4px;color:#e5e7eb;font-size:18px;cursor:pointer}
.icon-btn:hover{filter:brightness(1.2)}
input,select,button,textarea{font:inherit}input,select,textarea{width:100%;padding:8px 10px;border:1px solid rgba(15,23,42,.15);background:#fff;color:var(--text);border-radius:10px;outline:none}
.card{background:var(--panel);border:1px solid rgba(15,23,42,.08);border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(15,23,42,.06)}
.result-tag{padding:2px 6px;border-radius:999px;font-weight:600;font-size:12px}.result-win{color:#166534;background:rgba(22,101,52,.1)}.result-loss{color:#991b1b;background:rgba(185,28,28,.1)}.result-pending{color:#64748b;background:rgba(100,116,139,.12)}
.link{background:transparent;border:none;color:var(--accent);padding:0 2px;cursor:pointer}.link.win{color:#166534}.link.loss{color:#b91c1c}
.controls{display:flex;gap:8px;align-items:center}.controls .field{display:inline-flex;gap:6px;align-items:center;flex:0 0 auto}.controls input{width:100px}#currency{width:80px}
.small{font-size:12px}.muted{color:var(--muted)}.balance strong{font-size:1em;color:#16a34a;font-style:italic}
.layout{display:grid;grid-template-columns:3fr 2fr;gap:12px;align-items:start}
.layout.narrow-right{grid-template-columns:3fr 0.5fr}
#entryCardContent{transition:all 0.3s ease;overflow:hidden}
#entryCardContent.collapsed{max-height:0;opacity:0;margin:0;padding:0}
#toggleEntryCard svg{transition:transform 0.3s ease}
#toggleEntryCard.collapsed svg{transform:rotate(-90deg)}
.navlinks{display:flex;gap:10px;flex-wrap:wrap}
.navlinks a{color:#cbd5e1;text-decoration:none;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);display:inline-flex;gap:6px;align-items:center}
.navlinks a .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.navlinks a.active{color:#fff;background:rgba(96,165,250,.18);border-color:#60a5fa}
    /* KPI æ ·å¼ */
    .meta-line .kpi{display:flex;flex-direction:column;align-items:flex-end;min-width:72px}
    .meta-line .kpi .k-label{font-size:11px;color:var(--muted)}
    .meta-line .kpi .k-val{font-weight:600}
    .meta-line .kpi.balance .k-val{font-size:200%;font-weight:700}

.ops-line .link:hover{text-decoration:underline}
/* è¾“å…¥åŒºåŸŸæ ·å¼ */.under input,.under select{border:none;border-bottom:1px solid rgba(15,23,42,.25);border-radius:0;background:transparent;padding-left:0;padding-right:0}
.under input:focus,.under select:focus{border-bottom-color:var(--accent);box-shadow:none}.under label{display:block;color:#1f2937;font-weight:700;margin-bottom:4px}
/* æŠ½å±‰æ ·å¼ */
.drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px);z-index:40;display:none}
.drawer{position:fixed;top:0;right:0;height:100%;width:340px;max-width:90vw;background:#fff;color:#0f172a;border-left:1px solid rgba(15,23,42,.12);box-shadow:-8px 0 24px rgba(15,23,42,.15);transform:translateX(100%);transition:transform .25s ease;z-index:41;display:flex;flex-direction:column}
.drawer.open{transform:translateX(0)}
.drawer-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(15,23,42,.08)}
.drawer-body{padding:12px 14px;display:grid;gap:10px;align-content:start}
.drawer .field{display:grid;gap:6px}
.drawer hr{border:none;border-top:1px solid rgba(15,23,42,.08);margin:6px 0}
.icon-btn svg{display:block}

/* è¡¨æ ¼ */table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}th,td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);text-align:left}
thead th{position:sticky;top:0;background:#f1f5f9;z-index:1;cursor:pointer}tbody tr:hover{background:#f8fafc}.right{text-align:right}
tbody tr.win{background:rgba(16,185,129,.08)}
tbody tr.loss{background:rgba(239,68,68,.08)}
.pos{color:#16a34a;font-style:italic}
.neg{color:#b91c1c;font-style:italic}

/* ç»Ÿè®¡å°è¡¨æ ¼ */.stats-table{width:100%;border-collapse:collapse;margin-top:4px;table-layout:fixed;border:1px solid rgba(15,23,42,.18)}
.stats-table th,.stats-table td{padding:6px 8px;border-bottom:1px solid rgba(15,23,42,.08);font-size:13px}.stats-table th{background:#f8fafc;color:#334155;text-align:left}.stats-table td.right,.stats-table th.right{text-align:right}
@media(max-width:1000px){.layout{grid-template-columns:1fr}}@media(max-width:800px){.g-2{grid-template-columns:1fr}}
.tab-btn {
  transition: all 0.2s ease;
}
.tab-btn:hover {
  background: #e2e8f0 !important;
}
.tab-btn.active {
  background: white !important;
  color: #334155 !important;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
</style></head><body>
<div class="navbar"><div class="row" style="align-items:center;gap:12px">
  <div style="display:flex;flex-direction:column;gap:6px;flex:1 1 auto">
    <div class="row" style="align-items:center;gap:10px;flex-wrap:nowrap">
      <h1 style="margin:0">âš½ è¶³çƒä¸‹æ³¨è®°å½•ç°¿</h1>
      <div class="iconbar" style="display:flex;gap:10px;align-items:center">
        <button id="singleBetBtn" class="icon-btn" title="å•åœºå½©" aria-label="å•åœºå½©" onclick="window.location.href='index.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        </button>
        <button id="multiBetBtn" class="icon-btn" title="å¤šé‡å½©" aria-label="å¤šé‡å½©" onclick="window.location.href='multi-bet.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M9 9h6v6H9z"/><path d="M9 3v6"/><path d="M21 9h-6"/><path d="M15 21v-6"/><path d="M3 15h6"/></svg>
        </button>
        <button id="predictionTrackerBtn" class="icon-btn" title="é¢„æµ‹æ¥æºè®°å½•éªŒè¯" aria-label="é¢„æµ‹æ¥æºè®°å½•éªŒè¯" onclick="window.location.href='prediction-tracker.html'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4"/><path d="M20 16V7a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v1"/><path d="M15 2v5"/><path d="M9 2v5"/><path d="M3 9h18"/><circle cx="16" cy="16" r="2"/><path d="m21 21-1.5-1.5"/></svg>
        </button>
        <div style="width:1px;height:20px;background:#e2e8f0;margin:0 4px"></div>
        <button id="exportCsv" class="icon-btn" title="å¯¼å‡º CSV" aria-label="å¯¼å‡º">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="m8 11 4 4 4-4"/><path d="M21 21H3"/></svg>
        </button>
        <button id="importCsvBtn" class="icon-btn" title="å¯¼å…¥ CSV" aria-label="å¯¼å…¥">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21V9"/><path d="m16 13-4-4-4 4"/><path d="M21 3H3"/></svg>
        </button>
        <button id="clearAll" class="icon-btn" title="æ¸…ç©ºå½“å‰åˆ†ç±»" aria-label="æ¸…ç©º">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
        <button id="manageProfiles" class="icon-btn" title="è®¾ç½® / æ–°å¢åˆ†ç±»" aria-label="è®¾ç½®">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16l-3.9-3.9a5 5 0 1 1-6.2-6.2L14 9"/><path d="M22 22l-5.5-5.5"/></svg>
        </button>
      </div>
    </div>
    <div class="navlinks" id="nav"></div>
  </div>
  <div class="controls" style="margin-left:auto;flex-direction:column;align-items:flex-end">
    <div class="row controls-line" style="gap:8px;align-items:center;justify-content:flex-end">




      </div>
      <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none"/>
    </div>
    <div class="meta-line small" style="margin-top:6px;display:flex;gap:16px;align-items:flex-end;justify-content:flex-end">
      <span style="margin-right:auto"></span>
      <div class="kpi"><div class="k-label">æ€»ç¬”æ•°</div><div class="k-val" id="k_total">0</div></div>
      <div class="kpi"><div class="k-label">å·²ç»“ç®—</div><div class="k-val" id="k_settled">0</div></div>
      <div class="kpi"><div class="k-label">èƒœç‡</div><div class="k-val" id="k_wr">0%</div></div>
      <div class="kpi"><div class="k-label">æ€»æŠ•å…¥</div><div class="k-val" id="k_stake">0</div></div>
      <div class="kpi"><div class="k-label">æ€»è¿”è¿˜</div><div class="k-val" id="k_return">0</div></div>
      <div class="kpi"><div class="k-label">å‡€æ”¶ç›Š</div><div class="k-val" id="k_profit">0</div></div>
      <div class="kpi"><div class="k-label">ROI</div><div class="k-val" id="k_roi">0%</div></div>
      <div class="kpi balance"><div class="k-label">ä½™é¢</div><div class="k-val" id="balance">â€”</div></div>
    </div>
  </div>
</div></div>
<!-- å…¨å±€åŠ è½½æŒ‡ç¤ºå™¨ -->
<div id="loadingIndicator" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:8px;z-index:1000;display:none;text-align:center">
  <div style="margin-bottom:10px">æ•°æ®å¤„ç†ä¸­...</div>
  <div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<div class="wrap"><div class="layout">
  <div class="card">
    <div class="row"><input id="search" placeholder="æœç´¢ï¼ˆæŒ‰å†…å®¹/ç»“æœ/æ—¥æœŸ/è”èµ›/æ¯”èµ›ï¼‰"/>
      <div class="row" style="flex:0 0 auto;align-items:center;gap:6px"><label style="align-self:center;margin:0;flex:0 0 auto">æ¯é¡µ</label><select id="pageSize" style="width:auto;min-width:72px;max-width:120px;margin:0;flex:0 0 auto"><option>200</option><option selected>500</option><option>1000</option><option value="0">æ‰€æœ‰</option></select></div>
    </div>
    <table id="table"><thead><tr>
      <th data-sort="date" style="width:110px">æ—¥æœŸ</th>
      <th data-sort="league" style="width:180px">è”èµ›</th>
      <th data-sort="match" style="width:200px">æ¯”èµ›</th>
      <th data-sort="description" style="width:160px">å†…å®¹</th>
      <th data-sort="odds" class="right" style="width:90px">èµ”ç‡</th>
      <th data-sort="stake" class="right" style="width:90px">é‡‘é¢</th>
      <th data-sort="result" style="width:70px">ç»“æœ</th>
      <th class="right" style="width:110px">è¿”è¿˜</th>
      <th class="right" style="width:110px">æ”¶ç›Š</th>
      <th class="right" style="width:110px">ä½™é¢</th>
      <th style="width:140px">æ“ä½œ</th>
    </tr></thead><tbody id="tbody"></tbody></table>
    <div class="row" style="margin-top:8px;align-items:center"><div class="small muted" id="pagerInfo">â€”</div><div style="margin-left:auto;display:flex;gap:6px"><button class="btn sec" id="prevPage">ä¸Šä¸€é¡µ</button><button class="btn sec" id="nextPage">ä¸‹ä¸€é¡µ</button></div></div>
    <div class="small" style="margin:12px 0;color:#64748b">æ•°æ®ä¿å­˜åœ¨Supabaseäº‘æ•°æ®åº“ä¸­ã€‚å¯¼å‡º CSV å¯å¤‡ä»½/è¿ç§»ã€‚</div>
  </div>
<!-- æŠ½å±‰ä¸é®ç½© -->
<div id="drawerBackdrop" class="drawer-backdrop"></div>
<div id="settingsDrawer" class="drawer" aria-hidden="true">
  <div class="drawer-header"><strong>è®¾ç½® / åˆ†ç±»</strong>
    <button id="closeDrawer" class="icon-btn" title="å…³é—­">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>
  <div class="drawer-body">
    <div class="field"><label>åˆå§‹ä½™é¢</label><input id="drawer_initial" type="number" min="0" step="0.01" placeholder="1000"/></div>
    <div class="field"><label>å¸ç§ï¼ˆå‰ç¼€ï¼Œå¦‚ CNYã€$ã€â‚¬ï¼‰</label><input id="drawer_currency" type="text" placeholder="CNY"/></div>
    <div class="row" style="gap:8px">
      <button id="drawer_save" class="btn" style="justify-self:start">ä¿å­˜è®¾ç½®</button>
      <button id="test_db_connection" class="btn sec" style="justify-self:start">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
      <button id="debug_database" class="btn sec" style="justify-self:start">è°ƒè¯•æ•°æ®åº“</button>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button id="remove_duplicates_btn" class="btn warn" style="justify-self:start">ä¸€é”®å»é‡</button>
    </div>
    <hr>
    <div class="field"><label>æ–°å¢åˆ†ç±»ï¼ˆæ˜¾ç¤ºåç§°ï¼‰</label><input id="drawer_label" type="text" placeholder="å¦‚ My Tips"/></div>
    <div class="field"><label>è‹±æ–‡æ ‡è¯†ï¼ˆslugï¼‰</label><input id="drawer_slug" type="text" placeholder="å¦‚ my-tips"/></div>
    <button id="drawer_add_profile" class="btn sec" style="justify-self:start">æ–°å¢åˆ†ç±»</button>
    <hr>
    <div class="field"><label>åˆ†ç±»åˆ—è¡¨</label>
      <div id="profileList" class="small" style="display:grid;gap:6px"></div>
    </div>
    <div class="field">
      <label>å¯¼å…¥/å¯¼å‡ºå…¨éƒ¨æ•°æ®</label>
      <div class="row" style="gap:8px">
        <button id="drawer_export_all" class="btn sec">å¯¼å‡ºå…¨éƒ¨ (soccer.csv)</button>
        <button id="drawer_import_all_btn" class="btn">å¯¼å…¥å…¨éƒ¨ (soccer.csv)</button>
      </div>
      <input id="drawer_import_all_file" type="file" accept=".csv,text/csv" style="display:none"/>
    </div>
  </div>
</div>

  <div class="grid g-2" style="display:grid;grid-template-columns:1fr;gap:12px">
    <div class="card" id="entryCard">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="tab-buttons" style="display:flex;gap:2px;background:#f1f5f9;border-radius:6px;padding:2px">
            <button id="tabSingle" class="tab-btn active" style="padding:4px 12px;border:none;background:white;border-radius:4px;font-size:12px;cursor:pointer;color:#334155">å•æ¡å½•å…¥</button>
            <button id="tabBatch" class="tab-btn" style="padding:4px 12px;border:none;background:transparent;border-radius:4px;font-size:12px;cursor:pointer;color:#64748b">xGScoreæ‰¹é‡</button>
          </div>
        </div>
        <div style="display:flex;gap:4px">
          <button id="toggleEntryCard" class="icon-btn" title="æŠ˜å /å±•å¼€" style="color:#64748b;font-size:16px">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </button>
          <button id="toggleRightPanel" class="icon-btn" title="è°ƒæ•´é¢æ¿å®½åº¦" style="color:#64748b;font-size:16px">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
          </button>
        </div>
      </div>
      <div id="entryCardContent">
        <!-- å•æ¡å½•å…¥é¢æ¿ -->
        <div id="singleEntryPanel">
          <div class="row under"><div><label>æ—¥æœŸ</label><input id="date" type="date"/></div><div><label>è”èµ›</label><div style="position:relative"><input id="league" type="text" placeholder="ä¾‹å¦‚ è‹±è¶…" list="leagueList" autocomplete="off"/><datalist id="leagueList"></datalist></div></div><div><label>æ¯”èµ›</label><input id="match" type="text" placeholder="ä¾‹å¦‚ æ›¼åŸ vs é˜¿æ£®çº³"/></div></div>
          <div class="row under" style="margin-top:8px"><div><label>ä¸‹æ³¨å†…å®¹</label><div style="position:relative"><input id="description" type="text" placeholder="ä¾‹ï¼šæ›¼åŸèƒœ" list="descList" autocomplete="off"/><datalist id="descList"></datalist></div></div><div><label>èµ”ç‡ (å°æ•°)</label><input id="odds" type="number" step="0.01" min="1" placeholder="ä¾‹å¦‚ 1.85"/></div><div><label>é‡‘é¢</label><input id="stake" type="number" step="0.01" min="0" placeholder="ä¾‹å¦‚ 50"/></div><div><label>ç»“æœ</label><select id="result"><option value="pending">å¾…å®š</option><option value="win">èµ¢</option><option value="loss">è¾“</option></select></div></div>
          <div class="row" style="margin-top:10px"><button id="add" class="btn">+ å½•å…¥</button><button id="resetForm" class="btn sec">æ¸…ç©ºè¡¨å•</button></div>
        </div>
        <!-- xGScoreæ‰¹é‡å½•å…¥é¢æ¿ -->
        <div id="batchEntryPanel" style="display:none">
          <div style="margin-bottom:8px">
            <label style="display:block;margin-bottom:4px;font-size:12px;color:#334155">æ‰¹é‡æ•°æ® (è¡¨æ ¼æ ¼å¼ï¼ŒåŒ…å«è¡¨å¤´)</label>
            <textarea id="batchData" placeholder="è¯·ç²˜è´´åŒ…å«ä»¥ä¸‹åˆ—çš„è¡¨æ ¼æ•°æ®ï¼š&#10;æ—¥æœŸ | èµ›äº‹ | ä¸»é˜Ÿ | å®¢é˜Ÿ | æ¯”åˆ† | æŠ•æ³¨å†…å®¹ | ç»“æœ | Odds | Percentage&#10;&#10;æ³¨æ„ï¼š&#10;- Percentageä¼šè½¬æ¢ä¸ºæŠ•æ³¨é‡‘é¢ (3%=30, 4%=40)&#10;- Oddsä¼šä»æ¬§å¼èµ”ç‡è½¬æ¢ä¸ºå°æ•°èµ”ç‡" style="width:100%;height:120px;resize:vertical;font-family:monospace;font-size:11px"></textarea>
          </div>
          <div class="row" style="margin-top:10px;gap:8px">
            <button id="parseBatch" class="btn">è§£ææ•°æ®</button>
            <button id="importBatch" class="btn sec" disabled>æ‰¹é‡å¯¼å…¥</button>
            <button id="clearBatch" class="btn sec">æ¸…ç©º</button>
          </div>
          <div id="batchPreview" style="margin-top:12px;display:none">
            <div style="font-size:12px;color:#334155;margin-bottom:6px">é¢„è§ˆ (<span id="previewCount">0</span> æ¡è®°å½•)</div>
            <div style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;background:#f8fafc">
              <table style="width:100%;font-size:11px" id="previewTable">
                <thead style="background:#e2e8f0;position:sticky;top:0">
                  <tr><th style="padding:4px;text-align:left">æ—¥æœŸ</th><th style="padding:4px;text-align:left">è”èµ›</th><th style="padding:4px;text-align:left">æ¯”èµ›</th><th style="padding:4px;text-align:left">å†…å®¹</th><th style="padding:4px;text-align:left">èµ”ç‡</th><th style="padding:4px;text-align:left">é‡‘é¢</th><th style="padding:4px;text-align:left">ç»“æœ</th></tr>
                </thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3 class="small" style="margin:0 0 8px;color:#334155;display:flex;align-items:center;justify-content:space-between">
        é‡‘é¢ç»Ÿè®¡
        <button class="collapse-btn" onclick="toggleTable('stakeTable')" style="background:none;border:none;font-size:14px;cursor:pointer;color:#64748b">â–¼</button>
      </h3>
      <table class="small stats-table" id="stakeTable"></table>
      
      <h3 class="small" style="margin:8px 0 8px;color:#334155;display:flex;align-items:center;justify-content:space-between">
        å†…å®¹å‡†ç¡®ç‡
        <button class="collapse-btn" onclick="toggleTable('underTable')" style="background:none;border:none;font-size:14px;cursor:pointer;color:#64748b">â–¼</button>
      </h3>
      <table class="small stats-table" id="underTable"></table>
      
      <h3 class="small" style="margin:8px 0 8px;color:#334155;display:flex;align-items:center;justify-content:space-between">
        èµ”ç‡å‡†ç¡®åº¦ï¼ˆæŒ‰åŒºé—´ï¼‰
        <button class="collapse-btn" onclick="toggleTable('oddsTable')" style="background:none;border:none;font-size:14px;cursor:pointer;color:#64748b">â–¼</button>
      </h3>
      <table class="small stats-table" id="oddsTable"></table>
      
      <h3 class="small" style="margin:8px 0 8px;color:#334155;display:flex;align-items:center;justify-content:space-between">
        è”èµ›ç»Ÿè®¡
        <button class="collapse-btn" onclick="toggleTable('leagueTable')" style="background:none;border:none;font-size:14px;cursor:pointer;color:#64748b">â–¼</button>
      </h3>
      <table class="small stats-table" id="leagueTable"></table>
    </div>
  </div>
</div></div>
<script>
// Supabase é…ç½®
// Supabase é…ç½®
const SUPABASE_URL = 'https://hutlxrvwqrmidragxmtx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1dGx4cnZ3cXJtaWRyYWd4bXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMjk3ODMsImV4cCI6MjA3MTYwNTc4M30.KhDGniZHLEnmYJQWugq-U0o6EyZwmCPiXNbat_8Tyg4';

// Supabase é…ç½®å·²å®Œæˆ

// åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
let supabase;
try {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
} catch (error) {
  console.error('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
  alert('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
}

// å·²ç§»é™¤localStorageä¿å­˜å‡½æ•°ï¼Œç°åœ¨åªä½¿ç”¨Supabase

// æ•°æ®åº“æ“ä½œå¯¹è±¡
const db = {
  // è·å–æ‰€æœ‰æŠ•æ³¨è®°å½•
  async getBets(profileKey) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { data, error } = await supabase
        .from('betting_records')
        .select('*')
        .eq('profile_key', profileKey)
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      return data || [];
    } catch (error) {
      console.error('è·å–æŠ•æ³¨è®°å½•å¤±è´¥:', error);
      return [];
    }
  },

  // æ·»åŠ æŠ•æ³¨è®°å½•
  async addBet(bet, profileKey) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { data, error } = await supabase
        .from('betting_records')
        .insert([{
          profile_key: profileKey,
          date: bet.date,
          league: bet.league,
          match: bet.match,
          description: bet.description,
          odds: bet.odds,
          stake: bet.stake,
          result: bet.result
        }])
        .select();
      
      if (error) throw error;
      return data[0];
    } catch (error) {
      console.error('æ·»åŠ æŠ•æ³¨è®°å½•å¤±è´¥:', error);
      throw error;
    }
  },

  // æ·»åŠ æŠ•æ³¨è®°å½•ï¼ˆå¸¦å»é‡æ£€æŸ¥ï¼‰
  async addBetWithDeduplication(bet, profileKey) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é‡å¤è®°å½•ï¼ˆåŸºäºè”èµ›ã€æ¯”èµ›ã€å†…å®¹ã€èµ”ç‡ï¼‰
      const { data: existing, error: checkError } = await supabase
        .from('betting_records')
        .select('id')
        .eq('profile_key', profileKey)
        .eq('league', bet.league || '')
        .eq('match', bet.match || '')
        .eq('description', bet.description)
        .eq('odds', bet.odds)
        .maybeSingle();
      
      if (checkError) throw checkError;
      
      // å¦‚æœè®°å½•å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥
      if (existing) {
        console.log('è·³è¿‡é‡å¤è®°å½•:', bet);
        return null;
      }
      
      // æ’å…¥æ–°è®°å½•
      return await this.addBet(bet, profileKey);
    } catch (error) {
      console.error('æ·»åŠ æŠ•æ³¨è®°å½•ï¼ˆå»é‡ï¼‰å¤±è´¥:', error);
      throw error;
    }
  },

  // åˆ é™¤é‡å¤è®°å½•
  async removeDuplicates(profileKey) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      // è·å–æ‰€æœ‰è®°å½•
      const { data: allRecords, error } = await supabase
        .from('betting_records')
        .select('*')
        .eq('profile_key', profileKey)
        .order('created_at', { ascending: true });
      
      if (error) throw error;
      
      const seen = new Set();
      const duplicates = [];
      
      // æ‰¾å‡ºé‡å¤è®°å½•ï¼ˆåŸºäºè”èµ›ã€æ¯”èµ›ã€å†…å®¹ã€èµ”ç‡ï¼‰
      for (const record of allRecords) {
        const key = `${record.league || ''}-${record.match || ''}-${record.description}-${record.odds}`;
        if (seen.has(key)) {
          duplicates.push(record.id);
        } else {
          seen.add(key);
        }
      }
      
      // åˆ é™¤é‡å¤è®°å½•
      if (duplicates.length > 0) {
        const { error: deleteError } = await supabase
          .from('betting_records')
          .delete()
          .in('id', duplicates);
        
        if (deleteError) throw deleteError;
      }
      
      return { deletedCount: duplicates.length };
    } catch (error) {
      console.error('åˆ é™¤é‡å¤è®°å½•å¤±è´¥:', error);
      throw error;
    }
  },

  // æ›´æ–°æŠ•æ³¨è®°å½•
  async updateBet(id, updates) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { data, error } = await supabase
        .from('betting_records')
        .update(updates)
        .eq('id', id)
        .select();
      
      if (error) throw error;
      return data[0];
    } catch (error) {
      console.error('æ›´æ–°æŠ•æ³¨è®°å½•å¤±è´¥:', error);
      throw error;
    }
  },

  // åˆ é™¤æŠ•æ³¨è®°å½•
  async deleteBet(id) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { error } = await supabase
        .from('betting_records')
        .delete()
        .eq('id', id);
      
      if (error) throw error;
      return true;
    } catch (error) {
      console.error('åˆ é™¤æŠ•æ³¨è®°å½•å¤±è´¥:', error);
      throw error;
    }
  },

  // è·å–è®¾ç½®
  async getSettings(profileKey) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { data, error } = await supabase
        .from('user_settings')
        .select('*')
        .eq('profile_key', profileKey)
        .maybeSingle();
      
      if (error) throw error;
      return data ? { initial: data.initial_balance, currency: data.currency } : { initial: 0, currency: 'CNY' };
    } catch (error) {
      console.error('è·å–è®¾ç½®å¤±è´¥:', error);
      return { initial: 0, currency: 'CNY' };
    }
  },

  // ä¿å­˜è®¾ç½®
  async saveSettings(settings, profileKey) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { data, error } = await supabase
        .from('user_settings')
        .upsert({
          profile_key: profileKey,
          initial_balance: settings.initial,
          currency: settings.currency
        }, {
          onConflict: 'profile_key'
        })
        .select();
      
      if (error) throw error;
      return data[0];
    } catch (error) {
      console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
      throw error;
    }
  },

  // æ¸…ç©ºæ‰€æœ‰æ•°æ®
  async clearAllData(profileKey) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      // åˆ é™¤æŠ•æ³¨è®°å½•
      const { error: betsError } = await supabase
        .from('betting_records')
        .delete()
        .eq('profile_key', profileKey);
      
      if (betsError) throw betsError;
      
      // åˆ é™¤è®¾ç½®
      const { error: settingsError } = await supabase
        .from('user_settings')
        .delete()
        .eq('profile_key', profileKey);
      
      if (settingsError) throw settingsError;
      
      return true;
    } catch (error) {
      console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
      throw error;
    }
  },

  // è·å–æ‰€æœ‰profilesé…ç½®
  async getProfiles() {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { data, error } = await supabase
        .from('profiles_config')
        .select('*')
        .order('created_at', { ascending: true });
      
      if (error) throw error;
      
      // è½¬æ¢ä¸ºPROFILESæ ¼å¼
      const profiles = {};
      (data || []).forEach(profile => {
        profiles[profile.slug] = {
          label: profile.label,
          settingsKey: profile.settings_key,
          betsKey: profile.bets_key,
          exportName: profile.export_name,
          color: profile.color,
          categorizer: (b) => {
            const d = String(b.description || '');
            const m = d.match(/\b(under|over)\s*([0-9]+(?:\.[0-9]+)?)\b/i);
            if (m) {
              return [(m[1][0].toUpperCase() + m[1].slice(1).toLowerCase()) + " " + (+m[2]).toFixed(m[2].includes('.') ? 1 : 0)];
            }
            return firstWordCats(d);
          }
        };
      });
      
      return Object.keys(profiles).length > 0 ? profiles : DEFAULT_PROFILES;
    } catch (error) {
      console.error('è·å–profilesé…ç½®å¤±è´¥:', error);
      return DEFAULT_PROFILES;
    }
  },

  // ä¿å­˜profileé…ç½®
  async saveProfile(slug, profileData) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { data, error } = await supabase
        .from('profiles_config')
        .upsert({
          slug: slug,
          label: profileData.label,
          settings_key: profileData.settingsKey,
          bets_key: profileData.betsKey,
          export_name: profileData.exportName,
          color: profileData.color || '#94a3b8',
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'slug'
        })
        .select();
      
      if (error) throw error;
      return data[0];
    } catch (error) {
      console.error('ä¿å­˜profileé…ç½®å¤±è´¥:', error);
      throw error;
    }
  },

  // åˆ é™¤profileé…ç½®
  async deleteProfile(slug) {
    if (!supabase) {
      throw new Error('Supabase æœªåˆå§‹åŒ–');
    }
    try {
      const { error } = await supabase
        .from('profiles_config')
        .delete()
        .eq('slug', slug);
      
      if (error) throw error;
      return true;
    } catch (error) {
      console.error('åˆ é™¤profileé…ç½®å¤±è´¥:', error);
      throw error;
    }
  }
};

const DEFAULT_PROFILES={
  "under95":{label:"Under 95",settingsKey:"bet_settings_under95",betsKey:"bet_records_under95",exportName:"under 95.csv",categorizer:(b)=>{const d=String(b.description||"");const m=d.match(/\\b(under|over)\\s*([0-9]+(?:\\.[0-9]+)?)\\b/i);if(m){const k=(m[1][0].toUpperCase()+m[1].slice(1).toLowerCase())+" "+(+m[2]).toFixed(m[2].includes('.')?1:0);return [k]}return firstWordCats(d)}},
  "hoods-web":{label:"hoods-web",settingsKey:"bet_settings_hoods_web",betsKey:"bet_records_hoods_web",exportName:"hoods-web.csv",categorizer:(b)=>{const d=String(b.description||"");const ks=[/home\s*win/i,/away\s*win/i,/draw/i,/btts\s*yes/i,/btts\s*no/i].filter(k=>k.test(d)).map(k=>d.match(k)[0].replace(/\s+/g,' ').trim());return ks.length?ks:firstWordCats(d)}},
  "hoods-whatsapp":{label:"hoods-whatsapp",settingsKey:"bet_settings_hoods_whatsapp",betsKey:"bet_records_hoods_whatsapp",exportName:"hoods-whatsapp.csv",categorizer:(b)=>{const d=String(b.description||"");const ks=[/first\s*half/i,/second\s*half/i,/corner/i,/card/i,/over\s*[0-9]+(\.[0-9]+)?/i,/under\s*[0-9]+(\.[0-9]+)?/i].filter(k=>k.test(d)).map(k=>d.match(k)[0].replace(/\s+/g,' ').trim());return ks.length?ks:firstWordCats(d)}},
  "supertips":{label:"SuperTipsAPP",settingsKey:"bet_settings_supertips",betsKey:"bet_records_supertips",exportName:"supertips.csv",categorizer:(b)=>{const d=String(b.description||"");const ks=[/over\s*[0-9]+(\.[0-9]+)?/i,/under\s*[0-9]+(\.[0-9]+)?/i,/home\s*win/i,/away\s*win/i,/draw/i].filter(k=>k.test(d)).map(k=>d.match(k)[0].replace(/\s+/g,' ').trim());return ks.length?ks:firstWordCats(d)}}
};
const $=s=>document.querySelector(s);const navEl=$('#nav');
let PROFILES=DEFAULT_PROFILES; // ä¸´æ—¶åˆå§‹åŒ–ï¼Œå°†ä»æ•°æ®åº“åŠ è½½
let current=location.hash.slice(1);
// å·²ç§»é™¤localStorageå‡½æ•°ï¼Œç°åœ¨åªä½¿ç”¨Supabase

// ä»æ•°æ®åº“åŠ è½½PROFILESé…ç½®
async function loadProfiles() {
  try {
    PROFILES = await db.getProfiles();
    if(!current || !PROFILES[current]){ 
      current=Object.keys(PROFILES)[0]; 
      if(current) location.hash = current;
    }
    renderNav();
  } catch (error) {
    console.error('åŠ è½½profilesé…ç½®å¤±è´¥:', error);
    PROFILES = DEFAULT_PROFILES;
    if(!current || !PROFILES[current]){ 
      current=Object.keys(PROFILES)[0]; 
      if(current) location.hash = current;
    }
    renderNav();
  }
}

// åŠ è½½æŒ‡ç¤ºå™¨è¾…åŠ©å‡½æ•°
function showLoading() {
  document.getElementById('loadingIndicator').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

// æ–°çš„å¼‚æ­¥æ•°æ®æ“ä½œå‡½æ•° - åªä½¿ç”¨Supabase
async function loadData() {
  showLoading();
  try {
    if (!supabase) {
      throw new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
    }
    
    const profileKey = current;
    console.log('æ­£åœ¨åŠ è½½profileæ•°æ®:', profileKey);
    
    const [loadedSettings, loadedBets] = await Promise.all([
      db.getSettings(profileKey),
      db.getBets(profileKey)
    ]);
    
    console.log('åŠ è½½çš„è®¾ç½®:', loadedSettings);
    console.log('åŠ è½½çš„æŠ•æ³¨è®°å½•:', loadedBets);
    
    settings = loadedSettings;
    bets = loadedBets.map((bet, index) => ({
      date: bet.date,
      league: bet.league,
      match: bet.match,
      description: bet.description,
      odds: bet.odds,
      stake: bet.stake,
      result: bet.result,
      id: bet.id,
      i: index
    }));
    
    render();
  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    alert('æ•°æ®åŠ è½½å¤±è´¥ï¼š' + error.message + '\nè¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
    // è®¾ç½®é»˜è®¤å€¼ä½†ä¸ä½¿ç”¨localStorage
    settings = {initial: 0, currency: 'CNY'};
    bets = [];
    render();
  } finally {
    hideLoading();
  }
}
function firstWordCats(d){const m=d.match(/^[^,ï¼Œ\s]+/);return m?[m[0]]:[]}
const PROFILE_COLORS={"under95":"#60a5fa","hoods-web":"#f59e0b","hoods-whatsapp":"#10b981","supertips":"#ef4444"};
function renderNav(){navEl.innerHTML=Object.entries(PROFILES).map(([slug,p])=>{ const c=PROFILE_COLORS[slug]||"#94a3b8"; return `<a href="#${slug}" class="${slug===current?'active':''}"><span class="dot" style="background:${c}"></span><span>${p.label}</span></a>`; }).join('')}
window.addEventListener('hashchange',()=>{const slug=location.hash.slice(1);if(slug&&PROFILES[slug]){current=slug;renderNav();applyProfile();render()}});
function prof(){return PROFILES[current]} // shorthand
let settings={initial:0,currency:'CNY'};let bets=[];let sortBy='created',sortDir='desc',page=1;
async function applyProfile(){page=1;await loadData()}
function symbol(){return settings.currency||''}
function fmtNum(n){return Number(n).toLocaleString(undefined,{maximumFractionDigits:2})}
function compute(b){let ret=null,profit=null;if(b.result==='win'){ret=+b.stake*+b.odds;profit=ret-+b.stake}else if(b.result==='loss'){ret=0;profit=-+b.stake}return {ret,profit}}
function sum(a){return a.reduce((x,y)=>x+(+y||0),0)}
function updateKPIs(){const cur=$('#search').value.trim().toLowerCase();const rows=bets.filter(b=>[b.date,b.league,b.match,b.description,b.result].some(x=>String(x||'').toLowerCase().includes(cur)));const settled=rows.filter(b=>b.result!=='pending');const wins=rows.filter(b=>b.result==='win');const stake=sum(settled.map(b=>+b.stake));const totalReturn=sum(settled.map(b=>compute(b).ret??0));const profit=totalReturn-stake;const wr=settled.length?Math.round(wins.length/settled.length*100):0;const roi=stake?Math.round(profit/stake*100):0;$('#k_total').textContent=rows.length;$('#k_settled').textContent=settled.length;$('#k_wr').textContent=wr+'%';$('#k_stake').textContent=symbol()+fmtNum(stake);$('#k_return').textContent=symbol()+fmtNum(totalReturn);$('#k_profit').textContent=symbol()+fmtNum(profit);$('#k_roi').textContent=roi+'%';const allProfit=sum(bets.filter(b=>b.result!=='pending').map(b=>compute(b).profit??0));const bal=+settings.initial+allProfit;const bel=$('#balance');bel.textContent=symbol()+Number(bal).toFixed(2);bel.classList.remove('pos','neg');if(bal>0)bel.classList.add('pos');else if(bal<0)bel.classList.add('neg');renderStats()}
function updateBalances(pageRows) {
  // è·å–å½“å‰æ’åºåçš„æ‰€æœ‰æ•°æ®
  const cur = $('#search').value.trim().toLowerCase();
  let allRows = bets.map((b,i)=>({...b,i})).filter(b=>[b.date,b.league,b.match,b.description,b.result].some(x=>String(x||'').toLowerCase().includes(cur)));
  allRows.sort((a,b)=>{
    let r=0;
    if(sortBy==='created')r=a.i-b.i;
    else if(sortBy==='date')r=String(a.date??'').localeCompare(String(b.date??''));
    else{
      const va=a[sortBy]??'';
      const vb=b[sortBy]??'';
      r=(typeof va==='number'||typeof vb==='number')?((+va)-(+vb)):String(va).localeCompare(String(vb))
    }
    if(r===0)r=a.i-b.i;
    return sortDir==='asc'?r:-r
  });
  
  // ä»æœ€åä¸€è¡Œå¼€å§‹è®¡ç®—ä½™é¢
  let runningBalance = +settings.initial;
  for(let i = allRows.length - 1; i >= 0; i--) {
    const b = allRows[i];
    const {profit} = compute(b);
    if(profit !== null) runningBalance += profit;
    
    // å¦‚æœè¿™ä¸€è¡Œåœ¨å½“å‰é¡µé¢ä¸­ï¼Œæ›´æ–°æ˜¾ç¤º
    const pageRow = pageRows.find(pr => pr.i === b.i);
    if(pageRow) {
      const balanceEl = $(`#balance-${b.i}`);
      if(balanceEl) {
        balanceEl.textContent = symbol() + runningBalance.toFixed(2);
        balanceEl.style.color = runningBalance >= 0 ? '#16a34a' : '#b91c1c';
      }
    }
  }
}

function render(){const cur=$('#search').value.trim().toLowerCase();let rows=bets.map((b,i)=>({...b,i})).filter(b=>[b.date,b.league,b.match,b.description,b.result].some(x=>String(x||'').toLowerCase().includes(cur)));rows.sort((a,b)=>{let r=0;if(sortBy==='created')r=a.i-b.i;else if(sortBy==='date')r=String(a.date??'').localeCompare(String(b.date??''));else{const va=a[sortBy]??'';const vb=b[sortBy]??'';r=(typeof va==='number'||typeof vb==='number')?((+va)-(+vb)):String(va).localeCompare(String(vb))}if(r===0)r=a.i-b.i;return sortDir==='asc'?r:-r});const psValue=$('#pageSize').value;const ps=psValue==='0'?rows.length:(+psValue||500);const total=rows.length;const pages=Math.max(1,Math.ceil(total/ps));if(page>pages)page=pages;const start=(page-1)*ps;const pageRows=rows.slice(start,start+ps);$('#tbody').innerHTML=pageRows.map(r=>rowHTML(r)).join('')||`<tr><td colspan="12" class="muted">æš‚æ— æ•°æ®</td></tr>`;$('#pagerInfo').textContent=psValue==='0'?`æ˜¾ç¤ºå…¨éƒ¨ ${total} æ¡`:`ç¬¬ ${page}/${pages} é¡µï¼Œå…± ${total} æ¡`;$('#prevPage').disabled=page<=1||psValue==='0';$('#nextPage').disabled=page>=pages||psValue==='0';updateBalances(pageRows);updateKPIs();updateLeagueList();updateDescList()}
function rowHTML(b){
  const {ret,profit}=compute(b);
  const retTxt=ret==null?'â€”':symbol()+Number(ret).toFixed(2);
  const pTxt=profit==null?'â€”':(profit>=0?'+':'')+symbol()+Number(Math.abs(profit)).toFixed(2);
  const pColor=profit==null?'':(profit>=0?'#16a34a':'#b91c1c');
  return `<tr class="${b.result==='win'?'win':(b.result==='loss'?'loss':'')}">
    <td contenteditable data-act="edit" data-field="date" data-idx="${b.i}">${b.date||''}</td>
    <td contenteditable data-act="edit" data-field="league" data-idx="${b.i}">${escapeHTML(b.league||'')}</td>
    <td contenteditable data-act="edit" data-field="match" data-idx="${b.i}">${escapeHTML(b.match||'')}</td>
    <td contenteditable data-act="edit" data-field="description" data-idx="${b.i}">${escapeHTML(b.description||'')}</td>
    <td class="right" contenteditable data-act="edit" data-field="odds" data-idx="${b.i}">${(+b.odds).toFixed(3)}</td>
    <td class="right" contenteditable data-act="edit" data-field="stake" data-idx="${b.i}">${symbol()+Number(b.stake).toFixed(2)}</td>
    <td><span class="result-tag ${b.result==='win'?'result-win':(b.result==='loss'?'result-loss':'result-pending')}">${b.result==='win'?'èµ¢':(b.result==='loss'?'è¾“':'å¾…å®š')}</span></td>
    <td class="right">${retTxt}</td>
    <td class="right" style="color:${pColor};font-weight:700;font-size:15px">${pTxt}</td>
    <td class="right" id="balance-${b.i}">${symbol()}0.00</td>
    <td><div class="row ops-line" style="gap:8px;align-items:center;flex-wrap:nowrap"><button class="link" data-act="set" data-value="pending" data-idx="${b.i}">å¾…</button><button class="link win" data-act="set" data-value="win" data-idx="${b.i}">âœ“</button><button class="link loss" data-act="set" data-value="loss" data-idx="${b.i}">âœ—</button><button class="link" data-act="del" data-idx="${b.i}">ğŸ—‘</button></div></td>
  </tr>`;
}

// æŠ½å±‰å¼€å…³
const drawer=$('#settingsDrawer'), backdrop=$('#drawerBackdrop');
function openDrawer(){drawer.classList.add('open');backdrop.style.display='block';drawer.setAttribute('aria-hidden','false')}
function closeDrawer(){drawer.classList.remove('open');backdrop.style.display='none';drawer.setAttribute('aria-hidden','true')}
backdrop.onclick=closeDrawer;$('#closeDrawer').onclick=closeDrawer;
// å¡«å……å½“å‰è®¾ç½®
function fillSettings(){ $('#drawer_initial').value=settings.initial||0; $('#drawer_currency').value=settings.currency||''; }
// ä¿å­˜è®¾ç½®
$('#drawer_save').onclick=async()=>{ 
  const newSettings = {initial:+$('#drawer_initial').value||0, currency:$('#drawer_currency').value.trim()||''};
  showLoading();
  try{
    await db.saveSettings(newSettings, current);
    settings = newSettings;
    render();
    alert('å·²ä¿å­˜');
  }catch(error){
    console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
    alert('ä¿å­˜è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
  }finally{
    hideLoading();
  }
};
$('#test_db_connection').onclick=async()=>{
  showLoading();
  try{
    const testSettings = await db.getSettings(current);
    const testBets = await db.getBets(current);
    alert('æ•°æ®åº“è¿æ¥æˆåŠŸï¼\nè®¾ç½®æ•°æ®ï¼š' + (testSettings ? 'å·²æ‰¾åˆ°' : 'æœªæ‰¾åˆ°') + '\næŠ•æ³¨è®°å½•ï¼š' + (testBets ? testBets.length + ' æ¡' : '0 æ¡'));
  }catch(error){
    console.error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);
    alert('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼š' + error.message);
  }finally{
    hideLoading();
  }
};

// è°ƒè¯•æ•°æ®åº“å‡½æ•°
$('#debug_database').onclick=async()=>{
  showLoading();
  try{
    console.log('=== æ•°æ®åº“è°ƒè¯•ä¿¡æ¯ ===');
    console.log('å½“å‰profile:', current);
    console.log('Supabaseå®¢æˆ·ç«¯çŠ¶æ€:', supabase ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–');
    
    // æ£€æŸ¥æ‰€æœ‰profileçš„æ•°æ®
    const allProfiles = Object.keys(PROFILES);
    let debugInfo = `å½“å‰profile: ${current}\nSupabaseçŠ¶æ€: ${supabase ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}\n\n=== Supabaseæ•°æ® ===\n`;
    
    for(const profileKey of allProfiles) {
      try {
        const settings = await db.getSettings(profileKey);
        const bets = await db.getBets(profileKey);
        debugInfo += `Profile: ${profileKey}\n`;
        debugInfo += `- è®¾ç½®: ${settings ? JSON.stringify(settings) : 'ä¸å­˜åœ¨'}\n`;
        debugInfo += `- æŠ•æ³¨è®°å½•: ${bets ? bets.length : 0} æ¡\n`;
        if(bets && bets.length > 0) {
          debugInfo += `- æœ€æ–°è®°å½•: ${bets[0].description}\n`;
        }
        debugInfo += '\n';
        console.log(`Profile ${profileKey}:`, { settings, bets });
      } catch(err) {
        debugInfo += `Profile: ${profileKey}\n- é”™è¯¯: ${err.message}\n\n`;
        console.error(`Profile ${profileKey} é”™è¯¯:`, err);
      }
    }
    
    alert(debugInfo);
  }catch(error){
    console.error('è°ƒè¯•å¤±è´¥:', error);
    alert('è°ƒè¯•å¤±è´¥ï¼š' + error.message);
  }finally{
    hideLoading();
  }
};

// ä¸€é”®å»é‡æŒ‰é’®äº‹ä»¶å¤„ç†
$('#remove_duplicates_btn').onclick = async () => {
  if (!confirm('ç¡®å®šè¦åˆ é™¤é‡å¤çš„æŠ•æ³¨è®°å½•å—ï¼Ÿ\n\nå»é‡è§„åˆ™ï¼šåŸºäºè”èµ›ã€æ¯”èµ›ã€å†…å®¹ã€èµ”ç‡å››ä¸ªå­—æ®µåˆ¤æ–­é‡å¤\nç³»ç»Ÿå°†ä¿ç•™æœ€æ—©æ·»åŠ çš„è®°å½•ï¼Œåˆ é™¤åç»­çš„é‡å¤é¡¹ã€‚\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
    return;
  }
  
  showLoading();
  try {
    const result = await db.removeDuplicates(current);
    if (result && result.deletedCount > 0) {
      alert(`å»é‡å®Œæˆï¼åˆ é™¤äº† ${result.deletedCount} æ¡é‡å¤è®°å½•ã€‚`);
      render(); // åˆ·æ–°æ˜¾ç¤º
    } else {
      alert('æ²¡æœ‰å‘ç°é‡å¤è®°å½•ã€‚');
    }
  } catch (error) {
    console.error('å»é‡å¤±è´¥:', error);
    alert('å»é‡å¤±è´¥ï¼š' + error.message);
  } finally {
    hideLoading();
  }
};
// æ–°å¢åˆ†ç±»
$('#drawer_add_profile').onclick=async()=>{ const label=$('#drawer_label').value.trim(); const slug=($('#drawer_slug').value||'').trim(); if(!label||!slug){alert('è¯·å¡«å†™åç§°å’Œæ ‡è¯†');return} if(!/^[a-z0-9-]{2,}$/.test(slug)){alert('æ ‡è¯†ä¸åˆæ³•');return} if(PROFILES[slug]){alert('è¯¥æ ‡è¯†å·²å­˜åœ¨');return} const p={label,settingsKey:`bet_settings_${slug}`,betsKey:`bet_records_${slug}`,exportName:`${slug}.csv`,categorizer:(b)=>{const d=String(b.description||'');const m=d.match(/\b(under|over)\s*([0-9]+(?:\.[0-9]+)?)\b/i);if(m){return[(m[1][0].toUpperCase()+m[1].slice(1).toLowerCase())+" "+(+m[2]).toFixed(m[2].includes('.')?1:0)]}return firstWordCats(d)}}; try{showLoading();await db.saveProfile(slug,p);PROFILES={...PROFILES,[slug]:p};hideLoading();}catch(error){console.error('ä¿å­˜åˆ†ç±»å¤±è´¥:',error);alert('ä¿å­˜åˆ†ç±»å¤±è´¥ï¼Œè¯·é‡è¯•');hideLoading();return;} 
  // ä¸å†ä½¿ç”¨localStorageï¼ŒPROFILESåªåœ¨å†…å­˜ä¸­ç®¡ç†
  renderNav(); location.hash=slug; alert('å·²æ–°å¢åˆ†ç±»'); };
// å…¥å£ï¼šæ‰“å¼€æŠ½å±‰
$('#manageProfiles').onclick=()=>{ fillSettings(); renderProfileList(); openDrawer(); };

// åˆ†ç±»ç®¡ç†æ¸²æŸ“ä¸äº¤äº’
function renderProfileList(){
  const el=$('#profileList');
  const rows=Object.entries(PROFILES).map(([slug,p])=>{
    const c=(p.color||PROFILE_COLORS[slug]||'#94a3b8');
    const active=slug===current;
    return `<div style="display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center">
      <input data-k="label" data-slug="${slug}" value="${escapeHTML(p.label)}"/>
      <input data-k="color" data-slug="${slug}" value="${c}" style="width:80px"/>
      <button data-act="switch" data-slug="${slug}" class="icon-btn" title="åˆ‡æ¢åˆ°æ­¤åˆ†ç±»">${active?'âœ…':'â†ªï¸'}</button>
      <button data-act="delete" data-slug="${slug}" class="icon-btn" title="åˆ é™¤åˆ†ç±»">ğŸ—‘</button>
    </div>`
  }).join('');
  el.innerHTML=rows||'<div class="muted">æš‚æ— åˆ†ç±»</div>';
}
$('#profileList').addEventListener('input',e=>{
  const t=e.target; const slug=t.getAttribute('data-slug'); const k=t.getAttribute('data-k'); if(!slug||!k) return;
  if(!PROFILES[slug]) return; PROFILES[slug]={...PROFILES[slug],[k]:t.value}; 
  // ä¸å†ä½¿ç”¨localStorageï¼ŒPROFILESåªåœ¨å†…å­˜ä¸­ç®¡ç†
  renderNav();
});
$('#profileList').addEventListener('click',e=>{
  const t=e.target; const act=t.getAttribute('data-act'); const slug=t.getAttribute('data-slug'); if(!act||!slug) return;
  if(act==='switch'){ if(PROFILES[slug]){ location.hash=slug; } }
  if(act==='delete'){
    if(!PROFILES[slug]) return; 
    if(!confirm('åˆ é™¤è¯¥åˆ†ç±»ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤æ•°æ®åº“ä¸­è¯¥åˆ†ç±»çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æŠ•æ³¨è®°å½•å’Œè®¾ç½®ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    
    // åˆ é™¤æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®å’Œé…ç½®
    showLoading();
    Promise.all([
      db.clearAllData(slug),
      db.deleteProfile(slug)
    ]).then(() => {
      // åˆ é™¤æˆåŠŸåç§»é™¤å†…å­˜ä¸­çš„é…ç½®
      let newProfiles={...PROFILES}; delete newProfiles[slug];
      if(Object.keys(newProfiles).length===0){ 
        alert('å·²åˆ é™¤æœ€åä¸€ä¸ªåˆ†ç±»ï¼Œç³»ç»Ÿå°†æ¢å¤é»˜è®¤åˆ†ç±»'); 
        newProfiles={...DEFAULT_PROFILES}; 
      }
      PROFILES=newProfiles;
      if(!PROFILES[current]){ 
        const first=Object.keys(PROFILES)[0]; 
        if(first){ location.hash=first; } 
      }
      renderNav(); renderProfileList();
      alert('åˆ†ç±»åŠå…¶æ‰€æœ‰æ•°æ®å·²æˆåŠŸåˆ é™¤');
    }).catch(error => {
      console.error('åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
      alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
    }).finally(() => {
      hideLoading();
    });
  }
});
// æ‰“å¼€æŠ½å±‰æ—¶å¡«å……åˆ—è¡¨
function openDrawerAndFill(){ fillSettings(); renderProfileList(); openDrawer(); }
// æ›¿æ¢å…¥å£
$('#manageProfiles').onclick=openDrawerAndFill;

function escapeHTML(s){return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function normalizeLeagueName(name){return name.trim().replace(/\s+/g,' ').toLowerCase()}
function updateLeagueList(){const leagueMap=new Map();bets.forEach(b=>{if(b.league&&b.league.trim()){const original=b.league.trim();const normalized=normalizeLeagueName(original);if(!leagueMap.has(normalized)||leagueMap.get(normalized).length>original.length){leagueMap.set(normalized,original)}}});const uniqueLeagues=Array.from(leagueMap.values()).sort();const datalist=$('#leagueList');datalist.innerHTML=uniqueLeagues.map(league=>`<option value="${escapeHTML(league)}"></option>`).join('')}
function updateDescList(){const descMap=new Map();bets.forEach(b=>{if(b.description&&b.description.trim()){const original=b.description.trim();const normalized=original.toLowerCase();if(!descMap.has(normalized)||descMap.get(normalized).length>original.length){descMap.set(normalized,original)}}});const uniqueDescs=Array.from(descMap.values()).sort();const datalist=$('#descList');datalist.innerHTML=uniqueDescs.map(description=>`<option value="${escapeHTML(description)}"></option>`).join('')}
let leagueSortAlpha=false;function renderStats(){const stakeTable=$('#stakeTable'),underTable=$('#underTable'),oddsTable=$('#oddsTable'),leagueTable=$('#leagueTable');if(!stakeTable||!underTable||!oddsTable||!leagueTable)return;const settled=bets.filter(b=>b.result!=='pending');const allBets=bets.filter(b=>b.stake>0);const stakeMap={};let totalStake=0,totalReturn=0;allBets.forEach(b=>{const stake=+b.stake;const stakeRange=getStakeRange(stake);totalStake+=stake;if(b.result==='win'){totalReturn+=stake*b.odds}else if(b.result==='loss'){totalReturn+=0}else{totalReturn+=stake}(stakeMap[stakeRange]??={t:0,w:0,totalStake:0,totalReturn:0}).t++;if(b.result==='win')stakeMap[stakeRange].w++;stakeMap[stakeRange].totalStake+=stake;if(b.result==='win'){stakeMap[stakeRange].totalReturn+=stake*b.odds}else if(b.result==='loss'){stakeMap[stakeRange].totalReturn+=0}else{stakeMap[stakeRange].totalReturn+=stake}});const profit=totalReturn-totalStake;const stakeRows=Object.entries(stakeMap).sort((a,b)=>parseFloat(a[0].split('-')[0])-parseFloat(b[0].split('-')[0])).map(([range,v])=>{const rangeProfit=v.totalReturn-v.totalStake;const profitColor=rangeProfit>=0?'color:#059669':'color:#dc2626';return `<tr><td>${range}</td><td class="right">${v.w}/${v.t}</td><td class="right">${v.t?Math.round(v.w/v.t*100):0}%</td><td class="right">${v.totalStake.toFixed(0)}</td><td class="right" style="${profitColor}">${rangeProfit>=0?'+':''}${rangeProfit.toFixed(0)}</td></tr>`}).join('');const totalProfitColor=profit>=0?'color:#059669':'color:#dc2626';stakeTable.innerHTML=`<colgroup><col><col style="width:70px"><col style="width:60px"><col style="width:70px"><col style="width:80px"></colgroup><thead><tr><th>é‡‘é¢èŒƒå›´</th><th class="right">èƒœ/æ€»</th><th class="right">èƒœç‡</th><th class="right">æ€»æŠ•æ³¨</th><th class="right">ç›ˆäº</th></tr></thead><tbody>${stakeRows||'<tr><td colspan=5 class="muted">â€”</td></tr>'}<tr style="border-top:2px solid #e2e8f0;font-weight:bold"><td>æ€»è®¡</td><td class="right">${allBets.filter(b=>b.result==='win').length}/${allBets.length}</td><td class="right">${allBets.length?Math.round(allBets.filter(b=>b.result==='win').length/allBets.length*100):0}%</td><td class="right">${totalStake.toFixed(0)}</td><td class="right" style="${totalProfitColor}">${profit>=0?'+':''}${profit.toFixed(0)}</td></tr></tbody>`;const getCats=(prof()&&typeof prof().categorizer==='function')?prof().categorizer:(b)=>{const description=String(b.description||'').trim();if(!description)return [];return [description];};const mapCats={};settled.forEach(b=>{(getCats(b)||[]).forEach(k=>{if(!k)return;(mapCats[k]??={t:0,w:0}).t++;if(b.result==='win')mapCats[k].w++})});const catRows=Object.entries(mapCats).sort((a,b)=>b[1].t-a[1].t).map(([name,v])=>`<tr><td>${name}</td><td class="right">${v.w}/${v.t}</td><td class="right">${v.t?Math.round(v.w/v.t*100):0}%</td></tr>`).join('');underTable.innerHTML=`<colgroup><col><col style="width:90px"><col style="width:70px"></colgroup><thead><tr><th>ç±»å‹</th><th class="right">èƒœ/æ€»</th><th class="right">èƒœç‡</th></tr></thead><tbody>${catRows||'<tr><td colspan=3 class="muted">â€”</td></tr>'}</tbody>`;const map={};settled.forEach(b=>{const odds=+b.odds;let k;if(odds<=1.2)k='â‰¤1.2';else if(odds<=1.5)k='1.21-1.5';else if(odds<=1.8)k='1.51-1.80';else if(odds<=2.0)k='1.81-2.0';else if(odds<=2.5)k='2.01-2.5';else k='2.51+';(map[k]??={t:0,w:0}).t++;if(b.result==='win')map[k].w++});const oddsOrder=['â‰¤1.2','1.21-1.5','1.51-1.80','1.81-2.0','2.01-2.5','2.51+'];const oddsRows=oddsOrder.filter(k=>map[k]).map(k=>{const v=map[k];return `<tr><td>${k}</td><td class="right">${v.w}/${v.t}</td><td class="right">${v.t?Math.round(v.w/v.t*100):0}%</td></tr>`}).join('');oddsTable.innerHTML=`<thead><tr><th>èµ”ç‡</th><th class="right">èƒœ/æ€»</th><th class="right">èƒœç‡</th></tr></thead><tbody>${oddsRows||'<tr><td colspan=3 class="muted">â€”</td></tr>'}</tbody>`;const leagueMap=new Map();const leagues={};settled.forEach(b=>{const original=b.league||'æœªå¡«';const normalized=normalizeLeagueName(original);if(!leagueMap.has(normalized)||leagueMap.get(normalized).length>original.length){leagueMap.set(normalized,original)}const displayName=leagueMap.get(normalized);(leagues[displayName]??={t:0,w:0}).t++;if(b.result==='win')leagues[displayName].w++});const leagueRows=Object.entries(leagues).sort(leagueSortAlpha?(a,b)=>a[0].localeCompare(b[0]):(a,b)=>b[1].t-a[1].t).map(([k,v])=>`<tr><td style="cursor:pointer" onclick="toggleLeagueSort()">${k}</td><td class="right">${v.w}/${v.t}</td><td class="right">${v.t?Math.round(v.w/v.t*100):0}%</td></tr>`).join('');leagueTable.innerHTML=`<thead><tr><th style="cursor:pointer" onclick="toggleLeagueSort()">è”èµ› ${leagueSortAlpha?'(A-Z)':'(æŒ‰æ•°é‡)'}</th><th class="right">èƒœ/æ€»</th><th class="right">èƒœç‡</th></tr></thead><tbody>${leagueRows||'<tr><td colspan=3 class="muted">â€”</td></tr>'}</tbody>`}function toggleLeagueSort(){leagueSortAlpha=!leagueSortAlpha;renderStats()}

// è¡¨æ ¼æŠ˜å /å±•å¼€åŠŸèƒ½
function toggleTable(tableId) {
  const table = document.getElementById(tableId);
  const button = document.querySelector(`button[onclick="toggleTable('${tableId}')"]`);
  
  if (table.style.display === 'none') {
    table.style.display = 'table';
    button.textContent = 'â–¼';
    button.title = 'æŠ˜å è¡¨æ ¼';
  } else {
    table.style.display = 'none';
    button.textContent = 'â–¶';
    button.title = 'å±•å¼€è¡¨æ ¼';
  }
}
function getStakeRange(stake){if(stake<=10)return '0-10';if(stake<=20)return '11-20';if(stake<=30)return '21-30';if(stake<=50)return '31-50';if(stake<=100)return '51-100';if(stake<=200)return '101-200';if(stake<=500)return '201-500';return '500+'}
async function addBet(){const b={date:$('#date').value||new Date().toISOString().slice(0,10),league:($('#league').value||'').trim(),match:($('#match').value||'').trim(),description:($('#description').value||'').trim(),odds:+$('#odds').value,stake:+$('#stake').value,result:$('#result').value};if(!b.description){alert('è¯·å¡«å†™ä¸‹æ³¨å†…å®¹');return}if(!(b.odds>=1)){alert('è¯·å¡«å†™æ­£ç¡®çš„èµ”ç‡');return}if(!(b.stake>0)){alert('è¯·å¡«å†™æ­£ç¡®çš„é‡‘é¢');return}showLoading();try{const newBet=await db.addBet(b,current);bets.unshift({...b,id:newBet.id,i:0});bets.forEach((bet,index)=>bet.i=index);sortBy='created';sortDir='desc';page=1;render();$('#description').value='';$('#odds').value='';$('#stake').value='';$('#result').value='pending'}catch(error){console.error('æ·»åŠ è®°å½•å¤±è´¥:',error);alert('æ·»åŠ è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•')}finally{hideLoading()}}
async function setResult(i,v){showLoading();try{const bet=bets[i];await db.updateBet(bet.id,{result:v});bets[i].result=v;render()}catch(error){console.error('æ›´æ–°ç»“æœå¤±è´¥:',error);alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•')}finally{hideLoading()}}async function delBet(i){if(confirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ')){showLoading();try{const bet=bets[i];await db.deleteBet(bet.id);bets.splice(i,1);bets.forEach((bet,index)=>bet.i=index);render()}catch(error){console.error('åˆ é™¤è®°å½•å¤±è´¥:',error);alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')}finally{hideLoading()}}}
async function onInlineEdit(e){const td=e.target;if(td.dataset.act!=='edit')return;const i=+td.dataset.idx;const field=td.dataset.field;let val=td.textContent.trim();if(field==='odds'||field==='stake'){val=val.replace(/[^0-9.\-]/g,'');const num=+val;if(!isFinite(num)){alert('æ•°å€¼ä¸æ­£ç¡®');render();return}val=num}showLoading();try{const bet=bets[i];await db.updateBet(bet.id,{[field]:val});bets[i][field]=val;render()}catch(error){console.error('æ›´æ–°å¤±è´¥:',error);alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');render()}finally{hideLoading()}}
async function saveSettings(){const newSettings={initial:+$('#initial').value||0,currency:$('#currency').value.trim()||''};showLoading();try{await db.saveSettings(newSettings,current);settings=newSettings;render()}catch(error){console.error('ä¿å­˜è®¾ç½®å¤±è´¥:',error);alert('ä¿å­˜è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•')}finally{hideLoading()}}
function exportCSV(){const rows=[["kind","date","league","match","description","odds","stake","result"],["settings","initial",settings.initial,",,,,"],["settings","currency",settings.currency,",,,,"]];bets.forEach(b=>rows.push(["bet",b.date,b.league||'',b.match||'',b.description,b.odds,b.stake,b.result]));const csv=toCSV(rows);download(prof().exportName,csv)}
async function importCSV(ev){const f=ev.target.files[0];if(!f)return;const reader=new FileReader();reader.onload=async()=>{try{const rows=parseCSV(String(reader.result||''));if(!rows.length){alert('CSV å†…å®¹ä¸ºç©º');return}const header=rows[0].map(s=>s.toLowerCase());if(header[0]!=="kind"){alert('CSV æ ¼å¼ä¸å…¼å®¹');return}if(header[1]==="profile"){showLoading();try{const R={},S={};let profilesUpdated=false;for(let i=1;i<rows.length;i++){const r=rows[i];const kind=(r[0]||'').toLowerCase();let slug=(r[1]||'').trim().toLowerCase();if(!/^[a-z0-9-]{2,}$/.test(slug)) continue;if(!PROFILES[slug]){const p={label:slug,settingsKey:`bet_settings_${slug}`,betsKey:`bet_records_${slug}`,exportName:`${slug}.csv`,categorizer:(b)=>{const d=String(b.description||'');return firstWordCats(d)}};PROFILES={...PROFILES,[slug]:p};profilesUpdated=true;}if(kind==="settings"){const k=(r[2]||'').toLowerCase();const v=r[3]||'';(S[slug]||(S[slug]={initial:0,currency:''}))[k]=k==='initial'?+v||0:v;}if(kind==="bet"){const descIndex=header.indexOf('desc')!==-1?header.indexOf('desc'):header.indexOf('description');(R[slug]||(R[slug]=[])).push({date:r[2]||today(),league:r[3]||'',match:r[4]||'',description:r[descIndex]||'',odds:+r[6]||0,stake:+r[7]||0,result:(r[8]||'pending').toLowerCase()});}}for(const [slug,settingsData] of Object.entries(S)){try{await db.saveSettings(settingsData,slug);}catch(error){console.warn(`ä¿å­˜è®¾ç½®å¤±è´¥ ${slug}:`,error);if(error.message&&error.message.includes('duplicate key')){try{await supabase.from('user_settings').delete().eq('profile_key',slug);await db.saveSettings(settingsData,slug);}catch(retryError){console.error(`é‡è¯•ä¿å­˜è®¾ç½®å¤±è´¥ ${slug}:`,retryError);throw retryError;}}else{throw error;}}}for(const [slug,betsData] of Object.entries(R)){for(const bet of betsData){try{await db.addBet(bet,slug);}catch(error){console.warn(`ä¿å­˜æŠ•æ³¨è®°å½•å¤±è´¥:`,error);}}}if(profilesUpdated){renderNav();}await applyProfile();render();alert('å¯¼å…¥æˆåŠŸ');}catch(error){console.error('å¯¼å…¥å¤±è´¥:',error);alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•')}finally{hideLoading()}return;}const newSettings={...settings};const newBets=[];const descIndex=header.indexOf('desc')!==-1?header.indexOf('desc'):header.indexOf('description');for(let i=1;i<rows.length;i++){const r=rows[i];const kind=(r[0]||'').toLowerCase();if(kind==='settings'){const key=(r[1]||'').toLowerCase();const val=r[2]||'';if(key==='initial')newSettings.initial=+val||0;if(key==='currency')newSettings.currency=val}else if(kind==='bet'){let b={};if(rows[0].length>=8){b={date:r[1]||today(),league:r[2]||'',match:r[3]||'',description:r[descIndex]||'',odds:+r[5]||0,stake:+r[6]||0,result:(r[7]||'pending').toLowerCase()}} if(b.description)newBets.push(b)}}showLoading();try{await db.saveSettings(newSettings,current);for(const bet of newBets){await db.addBet(bet,current);}settings=newSettings;const allBets=await db.getBets(current);bets=allBets.map((bet,index)=>({date:bet.date,league:bet.league,match:bet.match,description:bet.description,odds:bet.odds,stake:bet.stake,result:bet.result,id:bet.id,i:index}));sortBy='created';sortDir='desc';page=1;render();alert('å¯¼å…¥æˆåŠŸ')}catch(error){console.error('å¯¼å…¥å¤±è´¥:',error);alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•')}finally{hideLoading()}}catch(e){console.error(e);alert('å¯¼å…¥å¤±è´¥ï¼š'+e.message)}finally{ev.target.value=''}};reader.readAsText(f)}
function today(){return new Date().toISOString().slice(0,10)}
function download(name,content){const blob=new Blob(["\uFEFF"+content],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href)}
function toCSV(rows){return rows.map(r=>r.map(csvEscape).join(',')).join('\n')}function csvEscape(s){if(s==null)s='';s=String(s);if(/[",\n]/.test(s))s='"'+s.replace(/"/g,'""')+'"';return s}
function parseCSV(text){const out=[];let row=[],field='',q=false;for(let i=0;i<text.length;i++){const c=text[i];if(q){if(c==='"'){if(text[i+1]==='"'){field+='"';i++;}else q=false}else field+=c}else{if(c==='"')q=true;else if(c===','){row.push(field);field='';}else if(c==='\n'){row.push(field);out.push(row);row=[];field='';}else if(c==='\r'){}else field+=c}}if(field!==''||row.length){row.push(field);out.push(row)}return out}

async function buildUI(){
  // é¦–å…ˆä»æ•°æ®åº“åŠ è½½profilesé…ç½®
  await loadProfiles();
  // ç„¶åæ‰§è¡Œå…¶ä»–åˆå§‹åŒ–æ“ä½œ
  await applyProfile();render();updateLeagueList();updateDescList();
document.querySelectorAll('th[data-sort]').forEach(th=>{th.addEventListener('click',()=>{const key=th.getAttribute('data-sort');if(sortBy===key){sortDir=sortDir==='asc'?'desc':'asc'}else{sortBy=key;sortDir='asc'};render()})});
$('#prevPage').onclick=()=>{if(page>1){page--;render()}};$('#nextPage').onclick=()=>{page++;render()};

async function exportAllCSV(){
  showLoading();
  try {
    const rows=[["kind","profile","date","league","match","description","odds","stake","result"]];
    
    for (const [slug, p] of Object.entries(PROFILES)) {
      try {
        // è·å–è®¾ç½®
        const settings = await db.getSettings(slug);
        rows.push(["settings",slug,"initial",settings.initial||0]);
        rows.push(["settings",slug,"currency",settings.currency||""]);
        
        // è·å–æŠ•æ³¨è®°å½•
        const bets = await db.getBets(slug);
        bets.forEach(b=>rows.push(["bet",slug,b.date,b.league||"",b.match||"",b.description,b.odds,b.stake,b.result]));
      } catch (error) {
        console.warn(`å¯¼å‡º ${slug} æ•°æ®å¤±è´¥:`, error);
      }
    }
    
    download("soccer.csv",toCSV(rows));
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
  } finally {
    hideLoading();
  }
}

async function importAllCSV(ev){
  const f=ev.target.files[0]; if(!f)return;
  const reader=new FileReader(); reader.onload=async()=>{ 
    showLoading();
    try{
      const rows=parseCSV(String(reader.result||'')); if(!rows.length){alert('CSV å†…å®¹ä¸ºç©º');return}
      const H=rows[0].map(s=>s.toLowerCase()); if(H[0]!=="kind"||H[1]!=="profile"){alert("CSV ä¸å…¼å®¹");return}
      
      const R={},S={};
      let profilesUpdated = false;
      for(let i=1;i<rows.length;i++){
        const r=rows[i]; const kind=(r[0]||'').toLowerCase(); let slug=(r[1]||'').trim().toLowerCase();
        if(!/^[a-z0-9-]{2,}$/.test(slug)) continue;
        if(!PROFILES[slug]){
          const p={label:slug,settingsKey:`bet_settings_${slug}`,betsKey:`bet_records_${slug}`,exportName:`${slug}.csv`,categorizer:(b)=>{const d=String(b.description||'');const m=d.match(/\b(under|over)\s*([0-9]+(?:\.[0-9]+)?)\b/i);if(m){return[(m[1][0].toUpperCase()+m[1].slice(1).toLowerCase())+" "+(+m[2]).toFixed(m[2].includes('.')?1:0)]}return firstWordCats(d)}};
          PROFILES={...PROFILES,[slug]:p};
          profilesUpdated = true;
          // ä¿å­˜æ–°çš„profileåˆ°æ•°æ®åº“
          try{
            await db.saveProfile(slug,p);
          }catch(error){
            console.warn(`ä¿å­˜profileé…ç½®å¤±è´¥ ${slug}:`,error);
          }
        }
        if(kind==="settings"){
          const k=(r[2]||'').toLowerCase(); const v=r[3]||'';
          (S[slug]||(S[slug]={initial:0,currency:''}))[k]=k==='initial'?+v||0:v;
        }
        if(kind==="bet"){
          (R[slug]||(R[slug]=[])).push({date:r[2]||today(),league:r[3]||'',match:r[4]||'',description:r[5]||'',odds:+r[6]||0,stake:+r[7]||0,result:(r[8]||'pending').toLowerCase()});
        }
      }
      
      // ä¿å­˜åˆ°Supabase
      for(const [slug,settingsData] of Object.entries(S)){
        try {
          await db.saveSettings(settingsData,slug);
        } catch (error) {
          console.warn(`ä¿å­˜è®¾ç½®å¤±è´¥ ${slug}:`, error);
          // å¦‚æœæ˜¯é‡å¤é”®é”™è¯¯ï¼Œå°è¯•å…ˆåˆ é™¤å†æ’å…¥
          if (error.message && error.message.includes('duplicate key')) {
            try {
              await supabase.from('user_settings').delete().eq('profile_key', slug);
              await db.saveSettings(settingsData,slug);
            } catch (retryError) {
              console.error(`é‡è¯•ä¿å­˜è®¾ç½®å¤±è´¥ ${slug}:`, retryError);
              throw retryError;
            }
          } else {
            throw error;
          }
        }
      }
      for(const [slug,betsData] of Object.entries(R)){
        for(const bet of betsData){
          try {
            await db.addBetWithDeduplication(bet,slug);
          } catch (error) {
            console.warn(`ä¿å­˜æŠ•æ³¨è®°å½•å¤±è´¥:`, error);
            // ç»§ç»­å¤„ç†å…¶ä»–è®°å½•ï¼Œä¸ä¸­æ–­æ•´ä¸ªå¯¼å…¥è¿‡ç¨‹
          }
        }
      }
      
      // å¦‚æœæœ‰æ–°çš„profileè¢«åˆ›å»ºï¼Œé‡æ–°æ¸²æŸ“å¯¼èˆª
      if (profilesUpdated) {
        renderNav();
      }
      
      await applyProfile(); render(); alert('å¯¼å…¥æˆåŠŸ');
    }catch(e){console.error(e);alert('å¯¼å…¥å¤±è´¥ï¼š'+e.message)} finally{ ev.target.value=''; hideLoading(); } };
  reader.readAsText(f);
}

$('#add').onclick=addBet;$('#resetForm').onclick=()=>{$('#description').value='';$('#odds').value='';$('#stake').value='';$('#result').value='pending'};$('#search').oninput=()=>{page=1;render()};
$('#exportCsv').onclick=exportCSV;$('#importCsvBtn').onclick=()=>$('input#csvFile').click();$('#csvFile').onchange=importCSV;$('#clearAll').onclick=async()=>{if(confirm('è¿™å°†æ¸…ç©ºå½“å‰åˆ†ç±»çš„æ‰€æœ‰è®¾å®šä¸è®°å½•ï¼Œç¡®å®šï¼Ÿ')){showLoading();try{await db.clearAllData(current);await applyProfile();}catch(error){console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:',error);alert('æ¸…ç©ºæ•°æ®å¤±è´¥ï¼š'+error.message);}finally{hideLoading();}}};
$('#drawer_export_all').onclick=exportAllCSV;$('#drawer_import_all_btn').onclick=()=>$('input#drawer_import_all_file').click();$('#drawer_import_all_file').onchange=importAllCSV;

$('#tbody').addEventListener('click',e=>{const t=e.target;const a=t.dataset.act;const i=+t.dataset.idx;if(a==='del')delBet(i);if(a==='set')setResult(i,t.dataset.value)});
$('#tbody').addEventListener('blur',onInlineEdit,true);$('#tbody').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();e.target.blur();}});

// æŠ˜å /å±•å¼€æ–°å¢è®°å½•å¡ç‰‡
$('#toggleEntryCard').onclick=()=>{
  const content=$('#entryCardContent');
  const btn=$('#toggleEntryCard');
  if(content.classList.contains('collapsed')){
    content.classList.remove('collapsed');
    btn.classList.remove('collapsed');
  }else{
    content.classList.add('collapsed');
    btn.classList.add('collapsed');
  }
};

// è°ƒæ•´å³ä¾§é¢æ¿å®½åº¦
$('#toggleRightPanel').onclick=()=>{
  const layout=document.querySelector('.layout');
  if(layout.classList.contains('narrow-right')){
    layout.classList.remove('narrow-right');
  }else{
    layout.classList.add('narrow-right');
  }
};

// é€‰é¡¹å¡åˆ‡æ¢åŠŸèƒ½
$('#tabSingle').onclick=()=>{
  $('#tabSingle').classList.add('active');
  $('#tabBatch').classList.remove('active');
  $('#singleEntryPanel').style.display='block';
  $('#batchEntryPanel').style.display='none';
};

$('#tabBatch').onclick=()=>{
  $('#tabBatch').classList.add('active');
  $('#tabSingle').classList.remove('active');
  $('#singleEntryPanel').style.display='none';
  $('#batchEntryPanel').style.display='block';
};

// æ‰¹é‡æ•°æ®å¤„ç†åŠŸèƒ½
let parsedBatchData=[];

$('#parseBatch').onclick=()=>{
  const data=$('#batchData').value.trim();
  if(!data){
    alert('è¯·è¾“å…¥æ‰¹é‡æ•°æ®');
    return;
  }
  
  try{
    parsedBatchData=parseBatchData(data);
    if(parsedBatchData.length===0){
      alert('æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®');
      return;
    }
    
    // æ˜¾ç¤ºé¢„è§ˆ
    $('#previewCount').textContent=parsedBatchData.length;
    const tbody=$('#previewBody');
    tbody.innerHTML=parsedBatchData.map(item=>
      `<tr>
        <td style="padding:4px">${item.date}</td>
        <td style="padding:4px">${item.league}</td>
        <td style="padding:4px">${item.match}</td>
        <td style="padding:4px">${item.description}</td>
        <td style="padding:4px">${item.odds}</td>
        <td style="padding:4px">${item.stake}</td>
        <td style="padding:4px">${item.result}</td>
      </tr>`
    ).join('');
    
    $('#batchPreview').style.display='block';
    $('#importBatch').disabled=false;
  }catch(e){
    alert('æ•°æ®è§£æå¤±è´¥ï¼š'+e.message);
  }
};

$('#importBatch').onclick=()=>{
  if(parsedBatchData.length===0){
    alert('æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®');
    return;
  }
  
  if(confirm(`ç¡®å®šå¯¼å…¥${parsedBatchData.length}æ¡è®°å½•ï¼Ÿ`)){
    bets.push(...parsedBatchData);
    save(prof().betsKey,bets);
    sortBy='created';
    sortDir='desc';
    page=1;
    render();
    
    // æ¸…ç©ºæ‰¹é‡è¾“å…¥
    $('#batchData').value='';
    $('#batchPreview').style.display='none';
    $('#importBatch').disabled=true;
    parsedBatchData=[];
    
    alert('æ‰¹é‡å¯¼å…¥æˆåŠŸ');
  }
};

$('#clearBatch').onclick=()=>{
  $('#batchData').value='';
  $('#batchPreview').style.display='none';
  $('#importBatch').disabled=true;
  parsedBatchData=[];
};

// è§£ææ‰¹é‡æ•°æ®å‡½æ•°
function parseBatchData(text){
  const lines=text.split('\n').map(line=>line.trim()).filter(line=>line);
  if(lines.length<2)throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘éœ€è¦è¡¨å¤´å’Œä¸€è¡Œæ•°æ®');
  
  const results=[];
  
  for(let i=1;i<lines.length;i++){
    const line=lines[i];
    // æ”¯æŒåˆ¶è¡¨ç¬¦æˆ–å¤šä¸ªç©ºæ ¼åˆ†éš”
    const parts=line.split(/\t|\s{2,}/).map(p=>p.trim()).filter(p=>p);
    
    if(parts.length<9)continue; // è·³è¿‡ä¸å®Œæ•´çš„è¡Œ
    
    try{
      const dateStr=parts[0];
      const league=parts[1];
      const homeTeam=parts[2];
      const awayTeam=parts[3];
      const score=parts[4];
      const description=parts[5];
      const resultStr=parts[6];
      const oddsStr=parts[7].replace(',','.');
      const percentageStr=parts[8];
      
      // è½¬æ¢æ—¥æœŸæ ¼å¼
      let date=dateStr;
      if(dateStr.includes('å¹´')){
        // å¤„ç†ä¸­æ–‡æ—¥æœŸæ ¼å¼
        const match=dateStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
        if(match){
          const year=match[1];
          const month=match[2].padStart(2,'0');
          const day=match[3].padStart(2,'0');
          date=`${year}-${month}-${day}`;
        }
      }
      
      // è½¬æ¢èµ”ç‡ï¼ˆä»æ¬§å¼èµ”ç‡åˆ°å°æ•°èµ”ç‡ï¼Œå®é™…ä¸Šæ¬§å¼èµ”ç‡å°±æ˜¯å°æ•°èµ”ç‡ï¼‰
      const odds=parseFloat(oddsStr);
      if(isNaN(odds)||odds<1)continue;
      
      // è½¬æ¢ç™¾åˆ†æ¯”ä¸ºé‡‘é¢
      const percentage=parseFloat(percentageStr.replace('%',''));
      if(isNaN(percentage)||percentage<=0)continue;
      const stake=percentage*10; // 3%=30, 4%=40
      
      // è½¬æ¢ç»“æœ
      let result='pending';
      if(resultStr==='èµ¢')result='win';
      else if(resultStr==='è¾“')result='loss';
      else if(resultStr==='å¹³')result='push';
      
      results.push({
        date:date,
        league:league,
        match:`${homeTeam} vs ${awayTeam}`,
        description:description,
        odds:odds,
        stake:stake,
        result:result
      });
    }catch(e){
      console.warn('è·³è¿‡æ— æ•ˆè¡Œï¼š',line,e.message);
    }
  }
  
  return results;
}
}

document.addEventListener('DOMContentLoaded', buildUI);
</script></body></html>

